# MCPサーバーリクエストログ設計書

## 概要

UserMcpServerInstance テーブルに対するリクエストログを収集し、パフォーマンス監視、エラー分析、セキュリティ監査、使用量追跡、課金計算を実現するためのログ設計書です。

## 目的

1. **パフォーマンス監視**: MCPサーバーの応答時間、スループット、リソース使用量の監視
2. **エラー分析**: 失敗したリクエストの原因分析とデバッグ支援
3. **セキュリティ監査**: 不正アクセスの検出とセキュリティイベントの追跡
4. **使用量追跡**: ユーザー・組織別のAPI使用量統計
5. **課金計算**: サービス利用料金の正確な計算基盤

## 収集対象ログ

### 1. リクエストログ（基本情報）

- **リクエストID**: 分散トレーシング用の一意識別子
- **ユーザーID**: リクエストを実行したユーザー
- **MCPサーバーインスタンスID**: 対象のMCPサーバーインスタンス
- **実行されたツール名**: 呼び出されたMCPツール
- **リクエストタイムスタンプ**: リクエスト開始時刻
- **レスポンスタイムスタンプ**: レスポンス完了時刻
- **実行時間（duration）**: レスポンス時間（ミリ秒）
- **ステータス**: 成功/失敗/タイムアウト

### 2. パフォーマンスログ

- **レスポンス時間**: API応答時間の詳細測定
- **リクエストサイズ**: 送信データサイズ（バイト）
- **レスポンスサイズ**: 受信データサイズ（バイト）
- **メモリ使用量**: プロセスメモリ消費量
- **CPU使用率**: プロセスCPU使用率

### 3. エラーログ

- **エラーコード**: 標準化されたエラー識別子
- **エラーメッセージ**: 人間可読なエラー内容
- **スタックトレース**: デバッグ用の詳細情報
- **原因分析情報**: エラーの根本原因データ

### 4. セキュリティログ

- **認証情報**: 認証方式と認証状態
- **API キー使用状況**: 使用されたAPIキーの識別子
- **レート制限状況**: レート制限の適用状況
- **アクセス元IP**: リクエスト元IPアドレス（必要に応じて）

### 5. ビジネスログ

- **組織ID**: 組織レベルでの利用統計
- **使用料金計算用データ**: 課金に必要な基礎データ
- **機能使用統計**: 機能別の利用状況

## データベーススキーマ設計

### McpServerRequestLog テーブル

```prisma
/// MCPサーバーインスタンスへのリクエストログ
model McpServerRequestLog {
  id                      String                @id @default(cuid())
  /// ユーザーID
  userId                  String
  user                    User                  @relation(fields: [userId], references: [id])
  /// MCPサーバーインスタンスID
  mcpServerInstanceId     String
  mcpServerInstance       UserMcpServerInstance @relation(fields: [mcpServerInstanceId], references: [id])
  /// 実行されたツール名
  toolName                String
  /// トランスポートタイプ（STDIO, SSE, STREAMABLE_HTTPS）
  transportType           TransportType
  /// MCPメソッド（tools/list, tools/call）
  method                  String
  /// 実行時間（ミリ秒）
  durationMs              Int
  /// エラーメッセージ
  errorMessage            String?
  /// エラーコード
  errorCode               String?
  /// 入力データサイズ（LLMからMCPサーバーに送信されるデータのバイト数）
  inputBytes              Int?
  /// 出力データサイズ（MCPサーバーからLLMに返すデータのバイト数）
  outputBytes             Int?
  /// 組織ID
  organizationId          String?
  organization            Organization?         @relation(fields: [organizationId], references: [id])
  /// ユーザーエージェント
  userAgent               String?

  createdAt               DateTime              @default(now())

  @@index([userId, createdAt])
  @@index([mcpServerInstanceId, createdAt])
  @@index([toolName, createdAt])
  @@index([responseStatus, createdAt])
  @@index([transportType, createdAt])
}
```

### インデックス設計

効率的なクエリ実行のため、以下のインデックスを設定：

1. **ユーザー別時系列検索**: `[userId, createdAt]`
2. **MCPサーバーインスタンス別時系列検索**: `[mcpServerInstanceId, createdAt]`
3. **ツール別時系列検索**: `[toolName, createdAt]`
4. **ステータス別時系列検索**: `[responseStatus, createdAt]`
5. **トランスポートタイプ別時系列検索**: `[transportType, createdAt]`

## 実装上の考慮事項

### 1. データプライバシー

- **機密情報の除外**: リクエストパラメータから機密情報（APIキー、パスワード等）を除外
- **個人情報の保護**: IPアドレス等の個人情報は必要最小限に留める
- **データ保持期間**: 法的要件に応じた適切な保持期間を設定

### 2. パフォーマンス最適化

- **非同期ログ出力**: リクエスト処理への影響を最小化
- **バッチ処理**: 大量ログの効率的な処理
- **データ圧縮**: 長期保存データの圧縮

### 3. 運用監視

- **ログ欠損監視**: ログ収集失敗の検出
- **容量監視**: ディスク使用量の監視
- **アラート設定**: 異常検知時の自動通知

## 活用方法

### 1. ダッシュボード

- **リアルタイム監視**: 現在のシステム状況
- **トレンド分析**: 時系列での使用量推移
- **エラー率監視**: サービス品質の可視化

### 2. レポート

- **月次利用統計**: ユーザー・組織別の利用サマリー
- **パフォーマンスレポート**: 応答時間とスループットの分析
- **エラー分析レポート**: 頻発エラーの原因分析

### 3. アラート

- **異常検知**: 応答時間の異常、エラー率の急上昇
- **容量アラート**: 使用量の急激な増加
- **セキュリティアラート**: 不正アクセスの検出

## 今後の拡張性

### 1. 機械学習活用

- **異常検知**: 正常パターンからの逸脱検出
- **予測分析**: 将来のリソース需要予測
- **自動最適化**: パフォーマンスの自動調整

### 2. 分散トレーシング

- **マイクロサービス間の追跡**: 複数サービスにまたがるリクエストの追跡
- **依存関係の可視化**: サービス間の依存関係マップ

### 3. 高度な分析

- **ユーザー行動分析**: 利用パターンの深掘り分析
- **A/Bテスト**: 機能改善の効果測定
- **コスト最適化**: リソース使用量の最適化提案

## 関連技術

- **Prisma**: データベースORM
- **PostgreSQL**: リレーショナルデータベース
- **Next.js**: フロントエンドフレームワーク
- **tRPC**: 型安全なAPI通信
- **MCP Protocol**: Model Context Protocol

## 作成日時

2025年7月5日

## 更新履歴

- 2025年7月5日: 初版作成
