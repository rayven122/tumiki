import { describe, expect, test, vi } from "vitest";

import type { ScanResult, ToolDefinition } from "../../security/types.js";
import {
  formatScanResultForDb,
  formatVulnerabilityError,
  toToolDefinition,
} from "../../security/vulnerability-checker.js";

// scanToolsForVulnerabilities のモック
vi.mock("../../security/scanner.js", () => ({
  scanToolsForVulnerabilities: vi.fn(),
}));

describe("formatScanResultForDb", () => {
  test("クリーンなスキャン結果をDB形式に変換する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [],
      status: "clean",
      executionTimeMs: 1000,
    };

    const tools: ToolDefinition[] = [
      {
        name: "tool1",
        description: "ツール1",
        inputSchema: { type: "object" },
      },
    ];

    const result = formatScanResultForDb(scanResult, tools);

    expect(result).toStrictEqual({
      status: "CLEAN",
      vulnerabilities: [],
      toolsSnapshot: [
        {
          name: "tool1",
          description: "ツール1",
          inputSchema: { type: "object" },
        },
      ],
      executionTimeMs: 1000,
      errorMessage: null,
    });
  });

  test("脆弱性があるスキャン結果をDB形式に変換する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [
        {
          type: "tool_poisoning",
          toolName: "malicious_tool",
          description: "悪意のあるツール",
          severity: "high",
        },
      ],
      status: "vulnerable",
      executionTimeMs: 2000,
    };

    const tools: ToolDefinition[] = [];

    const result = formatScanResultForDb(scanResult, tools);

    expect(result).toStrictEqual({
      status: "VULNERABLE",
      vulnerabilities: [
        {
          type: "tool_poisoning",
          toolName: "malicious_tool",
          description: "悪意のあるツール",
          severity: "high",
        },
      ],
      toolsSnapshot: [],
      executionTimeMs: 2000,
      errorMessage: null,
    });
  });

  test("エラースキャン結果をDB形式に変換する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [],
      status: "error",
      errorMessage: "タイムアウト",
    };

    const tools: ToolDefinition[] = [];

    const result = formatScanResultForDb(scanResult, tools);

    expect(result).toStrictEqual({
      status: "ERROR",
      vulnerabilities: [],
      toolsSnapshot: [],
      executionTimeMs: null,
      errorMessage: "タイムアウト",
    });
  });

  test("説明がないツールのスナップショットを正しく変換する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [],
      status: "clean",
    };

    const tools: ToolDefinition[] = [
      {
        name: "tool_without_desc",
        inputSchema: {},
      },
    ];

    const result = formatScanResultForDb(scanResult, tools);

    expect(result.toolsSnapshot).toStrictEqual([
      {
        name: "tool_without_desc",
        description: "",
        inputSchema: {},
      },
    ]);
  });
});

describe("toToolDefinition", () => {
  test("完全なツール情報を変換する", () => {
    const tool = {
      name: "test_tool",
      description: "テストツール",
      inputSchema: { type: "object", properties: {} },
    };

    const result = toToolDefinition(tool);

    expect(result).toStrictEqual({
      name: "test_tool",
      description: "テストツール",
      inputSchema: { type: "object", properties: {} },
    });
  });

  test("説明がnullのツールを変換する", () => {
    const tool = {
      name: "test_tool",
      description: null,
      inputSchema: { type: "object" },
    };

    const result = toToolDefinition(tool);

    expect(result).toStrictEqual({
      name: "test_tool",
      description: undefined,
      inputSchema: { type: "object" },
    });
  });

  test("説明がundefinedのツールを変換する", () => {
    const tool = {
      name: "test_tool",
      inputSchema: { type: "string" },
    };

    const result = toToolDefinition(tool);

    expect(result).toStrictEqual({
      name: "test_tool",
      description: undefined,
      inputSchema: { type: "string" },
    });
  });

  test("inputSchemaがundefinedの場合は空オブジェクトを設定する", () => {
    const tool = {
      name: "test_tool",
    };

    const result = toToolDefinition(tool);

    expect(result).toStrictEqual({
      name: "test_tool",
      description: undefined,
      inputSchema: {},
    });
  });
});

describe("formatVulnerabilityError", () => {
  test("脆弱性がある場合のエラーメッセージを生成する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [
        {
          type: "tool_poisoning",
          toolName: "malicious_tool",
          description: "悪意のあるコードが検出されました",
          severity: "high",
        },
      ],
      status: "vulnerable",
    };

    const result = formatVulnerabilityError("test-server", scanResult);

    expect(result).toBe(
      "MCPサーバー「test-server」にセキュリティ脆弱性が検出されました: [HIGH] tool_poisoning: 悪意のあるコードが検出されました",
    );
  });

  test("複数の脆弱性がある場合のエラーメッセージを生成する", () => {
    const scanResult: ScanResult = {
      serverName: "my-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [
        {
          type: "tool_poisoning",
          toolName: "tool1",
          description: "ツール1の問題",
          severity: "high",
        },
        {
          type: "prompt_injection",
          toolName: "tool2",
          description: "ツール2の問題",
          severity: "critical",
        },
      ],
      status: "vulnerable",
    };

    const result = formatVulnerabilityError("my-server", scanResult);

    expect(result).toBe(
      "MCPサーバー「my-server」にセキュリティ脆弱性が検出されました: [HIGH] tool_poisoning: ツール1の問題; [CRITICAL] prompt_injection: ツール2の問題",
    );
  });

  test("脆弱性がない場合のエラーメッセージを生成する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [],
      status: "error",
      errorMessage: "接続エラー",
    };

    const result = formatVulnerabilityError("test-server", scanResult);

    expect(result).toBe(
      "MCPサーバー「test-server」のスキャン中にエラーが発生しました: 接続エラー",
    );
  });

  test("エラーメッセージがない場合は不明なエラーを表示する", () => {
    const scanResult: ScanResult = {
      serverName: "test-server",
      scanTimestamp: "2024-01-01T00:00:00.000Z",
      vulnerabilities: [],
      status: "error",
    };

    const result = formatVulnerabilityError("test-server", scanResult);

    expect(result).toBe(
      "MCPサーバー「test-server」のスキャン中にエラーが発生しました: 不明なエラー",
    );
  });
});
