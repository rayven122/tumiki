import type {
  ScanResult,
  ToolDefinition,
  VulnerabilityCheckResult,
} from "./types.js";
import { scanToolsForVulnerabilities } from "./scanner.js";

/**
 * 新規追加時のツール脆弱性チェック
 *
 * リモート MCP サーバーに接続してツール定義を取得し、
 * mcp-scan を使用して脆弱性をチェックする
 *
 * @param serverName サーバー名（識別用）
 * @param serverUrl リモート MCP サーバーの URL
 * @param options オプション（タイムアウト、認証ヘッダー）
 * @returns 脆弱性チェック結果
 */
export const checkToolsForNewServer = async (
  serverName: string,
  serverUrl: string,
  options: { timeoutMs?: number; headers?: Record<string, string> } = {},
): Promise<VulnerabilityCheckResult> => {
  const scanResult = await scanToolsForVulnerabilities(
    {
      serverName,
      serverUrl,
      headers: options.headers,
    },
    { timeoutMs: options.timeoutMs },
  );

  return {
    isVulnerable: scanResult.status === "vulnerable",
    scanResult,
  };
};

/**
 * スキャン結果を DB 保存用の形式に変換
 *
 * @param scanResult スキャン結果
 * @param toolsSnapshot ツールスナップショット
 * @returns DB 保存用のオブジェクト
 */
export const formatScanResultForDb = (
  scanResult: ScanResult,
  toolsSnapshot: ToolDefinition[],
): {
  status: "CLEAN" | "VULNERABLE" | "ERROR";
  vulnerabilities: unknown[];
  toolsSnapshot: unknown[];
  executionTimeMs: number | null;
  errorMessage: string | null;
} => {
  const statusMap = {
    clean: "CLEAN" as const,
    vulnerable: "VULNERABLE" as const,
    error: "ERROR" as const,
  };

  return {
    status: statusMap[scanResult.status],
    vulnerabilities: scanResult.vulnerabilities,
    toolsSnapshot: toolsSnapshot.map((tool) => ({
      name: tool.name,
      description: tool.description ?? "",
      inputSchema: tool.inputSchema,
    })),
    executionTimeMs: scanResult.executionTimeMs ?? null,
    errorMessage: scanResult.errorMessage ?? null,
  };
};

/**
 * ツール定義を ToolDefinition 形式に変換
 *
 * MCP SDK の Tool 型や Prisma の McpTool 型から変換する際に使用
 *
 * @param tool ツール情報
 * @returns ToolDefinition
 */
export const toToolDefinition = (tool: {
  name: string;
  description?: string | null;
  inputSchema?: unknown;
}): ToolDefinition => ({
  name: tool.name,
  description: tool.description ?? undefined,
  inputSchema: (tool.inputSchema as Record<string, unknown>) ?? {},
});

/**
 * 脆弱性が検出された場合のエラーメッセージを生成
 *
 * @param serverName サーバー名
 * @param scanResult スキャン結果
 * @returns エラーメッセージ
 */
export const formatVulnerabilityError = (
  serverName: string,
  scanResult: ScanResult,
): string => {
  if (scanResult.vulnerabilities.length === 0) {
    return `MCPサーバー「${serverName}」のスキャン中にエラーが発生しました: ${scanResult.errorMessage ?? "不明なエラー"}`;
  }

  const vulnSummary = scanResult.vulnerabilities
    .map((v) => `[${v.severity.toUpperCase()}] ${v.type}: ${v.description}`)
    .join("; ");

  return `MCPサーバー「${serverName}」にセキュリティ脆弱性が検出されました: ${vulnSummary}`;
};
