# MCP-Scan セキュリティガイド

## 概要

MCP-Scan は Model Context Protocol (MCP) 接続のセキュリティ脆弱性を検出・監視するための専用ツールです。静的スキャンとリアルタイム監視の両方の機能を提供し、AI エージェントとMCPサーバー間の安全な通信を確保します。

## 主要機能

### 1. 二重運用モード

MCP-Scan は以下の2つのモードを提供し、単独または組み合わせて使用できます：

#### 静的スキャン (`mcp-scan scan`)
- インストール済みサーバーの静的解析
- 悪意のあるツール記述の検出
- 設定ファイルからの自動MCP構成検出

#### 動的プロキシ (`mcp-scan proxy`)
- MCP接続のリアルタイム監視
- セキュリティポリシーの動的実装
- 通信トラフィックの継続的な保護

### 2. 検出可能なセキュリティ脅威

#### ツールポイズニング攻撃
- **概要**: 悪意のあるプロンプトがツール記述に埋め込まれる攻撃
- **検出内容**: ツール説明文内の不審な指示や隠れたコマンド
- **影響**: AIエージェントが意図しない動作を実行する可能性

#### クロスオリジン エスカレーション
- **概要**: 異なるオリジンへの不正アクセス
- **検出内容**: 権限外のリソースへのアクセス試行
- **影響**: データ漏洩やシステム侵害のリスク

#### ラグプル攻撃
- **概要**: ツール定義の悪意ある変更
- **検出方法**: ハッシュベースの変更追跡
- **影響**: 信頼されたツールの機能が突然変更される

#### トキシックフロー
- **概要**: 危険な操作フローの連鎖
- **検出内容**: ツールの組み合わせによる悪意ある実行パス
- **影響**: 複数のツールを通じた複雑な攻撃

#### 間接プロンプトインジェクション
- **概要**: 自然言語メッセージに隠された悪意あるコマンド
- **検出内容**: 一見無害に見えるが埋め込まれた指示
- **影響**: ユーザーが気づかない不正操作の実行

### 3. ガードレール機能

#### PII検出
- **機能**: 個人識別情報の自動検出
- **対象**: 名前、住所、電話番号、メールアドレス等
- **アクション**: 機密情報の送信を防止

#### シークレット検出
- **機能**: APIキー、パスワード、トークンの検出
- **対象**: 各種認証情報やアクセストークン
- **アクション**: 機密情報の漏洩防止

#### ツール制限
- **機能**: 特定ツールの使用制限
- **設定**: カスタムルールによる柔軟な制御
- **適用**: ホワイトリスト/ブラックリストベース

### 4. 監査・ログ機能

#### リアルタイム監視
- **機能**: MCP通信の継続的な監視
- **記録**: 全ての通信ログの保存
- **分析**: 異常な通信パターンの検出

#### 詳細レポート
- **形式**: JSON、テキスト形式での出力
- **内容**: 脆弱性の詳細と推奨対策
- **保存**: ローカルファイルへの結果保存

## 使用方法

### 基本的なスキャン

```bash
# 自動検出されたMCP設定をスキャン
uvx mcp-scan@latest scan

# 特定の設定ファイルをスキャン
uvx mcp-scan@latest scan /path/to/config.json

# JSON形式で結果を出力
uvx mcp-scan@latest scan --json

# 詳細ログを有効化
uvx mcp-scan@latest scan --verbose
```

### プロキシモードでのリアルタイム監視

```bash
# プロキシモードの開始
uvx mcp-scan@latest proxy

# カスタム設定でプロキシを起動
uvx mcp-scan@latest proxy --config ~/.mcp-scan/custom_config.yml
```

### 設定ファイルの例

```json
{
  "mcpServers": {
    "production-server": {
      "url": "https://api.example.com/mcp",
      "transport": {
        "type": "sse"
      },
      "headers": {
        "api-key": "your-api-key",
        "x-validation-mode": "true"
      }
    }
  }
}
```

## セキュリティチェック項目

### 1. ツール記述の検証
- [ ] 不審なプロンプト指示の検出
- [ ] 隠れたコマンドの識別
- [ ] 悪意ある実行パスの分析

### 2. 通信内容の監視
- [ ] 異常なデータ転送の検出
- [ ] 不正なAPI呼び出しの識別
- [ ] 権限外アクセスの監視

### 3. ツール整合性の確認
- [ ] ツール定義の変更追跡
- [ ] 期待される動作との乖離検出
- [ ] バージョン管理との整合性確認

### 4. データ保護
- [ ] PII情報の漏洩防止
- [ ] 機密情報の検出・ブロック
- [ ] データ分類に基づく制御

## 実装上の考慮事項

### セキュリティベストプラクティス

1. **定期的なスキャンの実施**
   - 新しいMCPサーバー追加時の必須スキャン
   - 定期的な脆弱性チェックの自動化

2. **ログ管理**
   - セキュリティログの適切な保存期間設定
   - ログ改ざん防止措置の実装

3. **アクセス制御**
   - MCP接続の最小権限原則の適用
   - 認証・認可機構の強化

### パフォーマンス最適化

1. **効率的なスキャン**
   - 並列処理による高速化
   - キャッシュ機構の活用

2. **リソース管理**
   - メモリ使用量の監視
   - CPU負荷の適切な制御

## トラブルシューティング

### よくある問題

#### スキャンタイムアウト
```bash
# タイムアウト値の調整
uvx mcp-scan@latest scan --server-timeout 60
```

#### 設定ファイルエラー
- JSON形式の検証
- 必須フィールドの確認
- URLの有効性チェック

#### 接続エラー
- ネットワーク接続の確認
- APIキーの有効性確認
- サーバーの稼働状況確認

## まとめ

MCP-Scan は AI エージェントの安全な運用に不可欠なセキュリティツールです。静的解析とリアルタイム監視を組み合わせることで、包括的なセキュリティ保護を提供します。定期的なスキャンと適切な設定により、MCPベースのAIシステムのセキュリティを大幅に向上させることができます。

## 関連リンク

- [mcp-scan GitHub Repository](https://github.com/invariantlabs-ai/mcp-scan)
- [Model Context Protocol 公式サイト](https://modelcontextprotocol.io/)
- [MCP セキュリティガイドライン](https://protectai.com/blog/mcp-security-101)