// Stripe決済関連のスキーマ定義

// サブスクリプション
model Subscription {
  id                     String             @id @default(cuid())
  userId                 String?            // 個人プランの場合
  organizationId         String?            // 組織プランの場合
  stripeSubscriptionId   String             @unique // StripeサブスクリプションID
  stripeCustomerId       String             // StripeカスタマーID
  stripePriceId          String             // Stripe価格ID
  stripeCurrentPeriodEnd DateTime           // 現在の請求期間終了日
  
  status                 SubscriptionStatus @default(incomplete)
  planType               PlanType           // プランタイプ（定数から参照）
  
  // メタデータ
  metadata               Json?              // 追加情報の保存用
  canceledAt             DateTime?          // キャンセル日時
  cancelReason           String?            // キャンセル理由
  
  // 冪等性管理
  lastProcessedEventId   String?            // 最後に処理したStripeイベントID
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  // リレーション
  user                  User?              @relation(fields: [userId], references: [id])
  organization          Organization?      @relation(fields: [organizationId], references: [id])
  
  // 制約: userIdまたはorganizationIdのいずれか一つが必須
  @@unique([userId])
  @@unique([organizationId])
  @@index([stripeCustomerId])
}

// 処理済みWebhookイベント（軽量な冪等性管理用）
model ProcessedWebhookEvent {
  stripeEventId   String   @id // StripeイベントID（冪等性キー）
  objectId        String?  // data.object.id（追加の重複排除用）
  processedAt     DateTime @default(now()) // 処理完了日時
  
  @@index([processedAt]) // 古いレコードの削除用
  @@index([objectId])    // オブジェクトIDでの検索用
}

// プランタイプ
enum PlanType {
  INDIVIDUAL  // 個人向け
  TEAM        // チーム向け
  ENTERPRISE  // エンタープライズ
}

// サブスクリプションステータス（Stripeと同期）
enum SubscriptionStatus {
  incomplete          // 支払い未完了
  incomplete_expired  // 支払い期限切れ
  trialing            // 試用期間中
  active              // 有効
  past_due            // 支払い遅延
  canceled            // キャンセル済み
  unpaid              // 未払い
  paused              // 一時停止（将来の拡張用）
}