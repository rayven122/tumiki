// Stripe決済関連のスキーマ定義

// 料金プラン
model Plan {
  id            String         @id @default(cuid())
  name          String         // プラン名（例: "プロプラン"）
  description   String?        // プランの説明
  stripePriceId String         @unique // Stripe価格ID
  amount        Int            // 金額（円）
  currency      String         @default("jpy")
  interval      String         @default("month") // 請求間隔
  features      Json           // 機能リスト（string[]）
  limits        Json           // 制限値（mcpServers, apiCalls等）
  type          PlanType       // プランタイプ
  isActive      Boolean        @default(true) // 販売中かどうか
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  subscriptions Subscription[]

  @@index([type])
  @@index([isActive])
}

// サブスクリプション
model Subscription {
  id                     String             @id @default(cuid())
  userId                 String?            // 個人プランの場合
  organizationId         String?            // 組織プランの場合
  stripeSubscriptionId   String             @unique // StripeサブスクリプションID
  stripeCustomerId       String             // StripeカスタマーID
  stripePriceId          String             // Stripe価格ID
  stripeCurrentPeriodEnd DateTime           // 現在の請求期間終了日
  
  status                 SubscriptionStatus @default(incomplete)
  planId                 String
  
  // メタデータ
  metadata               Json?              // 追加情報の保存用
  canceledAt             DateTime?          // キャンセル日時
  cancelReason           String?            // キャンセル理由
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  // リレーション
  user                  User?              @relation(fields: [userId], references: [id])
  organization          Organization?      @relation(fields: [organizationId], references: [id])
  plan                  Plan               @relation(fields: [planId], references: [id])
  
  // 制約: userIdまたはorganizationIdのいずれか一つが必須
  @@unique([userId])
  @@unique([organizationId])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeCurrentPeriodEnd])
}

// Stripe Webhookイベント（冪等性管理用）
model StripeWebhookEvent {
  id              String   @id @default(cuid())
  stripeEventId   String   @unique // StripeイベントID（冪等性キー）
  type            String   // イベントタイプ
  data            Json     // イベントデータ
  processedAt     DateTime @default(now())
  
  // エラー追跡
  error           String?  // エラーメッセージ
  retryCount      Int      @default(0)
  
  @@index([type])
  @@index([processedAt])
}

// プランタイプ
enum PlanType {
  INDIVIDUAL  // 個人向け
  TEAM        // チーム向け
  ENTERPRISE  // エンタープライズ
}

// サブスクリプションステータス（Stripeと同期）
enum SubscriptionStatus {
  incomplete          // 支払い未完了
  incomplete_expired  // 支払い期限切れ
  trialing            // 試用期間中
  active              // 有効
  past_due            // 支払い遅延
  canceled            // キャンセル済み
  unpaid              // 未払い
  paused              // 一時停止（将来の拡張用）
}