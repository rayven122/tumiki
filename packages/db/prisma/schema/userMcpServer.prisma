/**
 * @namespace UserMcpServer
 * ユーザごとに作成するため、他のユーザには表示されない
 */

/// APIキー等の認証情報（組織レベル/ユーザーレベル）
/// userId = null で組織共通設定、userId 設定済みでユーザー個別設定
/// @namespace UserMcpServer
model McpConfig {
  id      String @id @default(cuid())
  /// MCPサーバーの envVars を文字配列を key にしたオブジェクトを Object.stringify + 暗号化したもの
  envVars String /// @encrypted

  /// 関連するMCPサーバーテンプレートインスタンス（インスタンスごとに異なる設定）
  mcpServerTemplateInstanceId String
  mcpServerTemplateInstance   McpServerTemplateInstance @relation(fields: [mcpServerTemplateInstanceId], references: [id], onDelete: Cascade)

  /// 組織（必須）
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  /// ユーザー（nullの場合は組織共通設定、設定済みでユーザー個別設定）
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 1インスタンス×1ユーザー（または組織）=1設定
  @@unique([mcpServerTemplateInstanceId, userId, organizationId])
}

/// サーバーの状態
/// @namespace UserMcpServer
enum ServerStatus {
  /// サーバーが起動している
  RUNNING
  /// サーバーが停止している
  STOPPED
  /// サーバーがエラーが発生している
  ERROR
  /// サーバーの接続検証中
  PENDING
}

/// サーバーの種類
/// @namespace UserMcpServer
enum ServerType {
  /// カスタムMCPサーバー
  CUSTOM
  /// 公式MCPサーバー
  OFFICIAL
  /// 統合MCPサーバー（複数のMCPサーバーを単一エンドポイントで公開）
  UNIFIED
}

/// PIIマスキングモード
/// @namespace UserMcpServer
enum PiiMaskingMode {
  /// マスキング無効
  DISABLED
  /// リクエストのみマスキング
  REQUEST
  /// レスポンスのみマスキング
  RESPONSE
  /// 両方マスキング
  BOTH
}

/// 実際に稼働するMCPサーバー
/// 1つまたは複数のMcpServerTemplateから作成
/// serverType = UNIFIED の場合は複数のMCPサーバーを統合したエンドポイント
/// @namespace UserMcpServer
model McpServer {
  id           String       @id @default(cuid())
  /// 稼働中のMCPサーバー名
  /// @zod.string.min(1)
  name         String
  /// サーバーの説明（必須）
  description  String
  /// アイコンパス
  iconPath     String?
  /// サーバーの状態
  serverStatus ServerStatus
  /// サーバーの種類
  serverType   ServerType

  /// テンプレートインスタンス一覧
  templateInstances McpServerTemplateInstance[]

  /// APIキー一覧
  apiKeys        McpApiKey[]
  /// 使用する認証タイプ（API_KEY, OAUTH, NONE）
  authType       AuthType     @default(API_KEY)
  /// 組織
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  /// 表示順序（ユーザーごと）
  displayOrder   Int          @default(0)

  /// PIIマスキングモード設定（GCP DLPによるマスキング）
  /// DISABLED: マスキングなし（デフォルト）
  /// REQUEST: リクエストのみマスキング
  /// RESPONSE: レスポンスのみマスキング
  /// BOTH: 両方マスキング
  piiMaskingMode PiiMaskingMode @default(DISABLED)

  /// 使用するInfoType一覧（GCP DLP）
  /// 空配列の場合は全InfoTypeを使用
  piiInfoTypes String[] @default([])

  /// TOON変換を有効にするかどうか（AIへのトークン削減用）
  /// true: レスポンスをTOON形式に変換してからAIに返す
  /// false: JSONのままAIに返す（デフォルト）
  toonConversionEnabled Boolean @default(false)

  /// 権限設定（サーバー削除時に自動削除）
  mcpPermissions McpPermission[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  /// 論理削除用のタイムスタンプ
  deletedAt DateTime?

  @@index([deletedAt])
}


/// APIキー管理テーブル
/// @namespace UserMcpServer
model McpApiKey {
  id          String    @id @default(cuid())
  /// APIキー名（ユーザーが設定）
  name        String
  /// 暗号化されたAPIキー（client_id として使用）
  apiKey      String    @unique /// @encrypted
  /// APIキーをハッシュ化したもの（SHA-256、自動生成）
  apiKeyHash  String?   @unique /// @encryption:hash(apiKey)
  /// APIキーが有効かどうか
  isActive    Boolean   @default(true)
  /// 最後に使用された日時
  lastUsedAt  DateTime?
  /// APIキーの有効期限
  expiresAt   DateTime?
  /// スコープ情報（例: ["mcp:access:notion", "mcp:access:figma"]）
  scopes      String[]  @default([])
  /// 関連するユーザー
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 関連するMcpServerのID
  mcpServerId String
  mcpServer   McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  /// 論理削除用のタイムスタンプ
  deletedAt DateTime?

  @@index([apiKeyHash])
  @@index([deletedAt])
}

/// トークンの用途
/// @namespace UserMcpServer
enum TokenPurpose {
  /// AIクライアントが使用するTumikiトークン
  TUMIKI_CLIENT
  /// Backend MCPサーバーへのアクセストークン
  BACKEND_MCP
}

/// OAuth クライアント情報（Dynamic Client Registration で取得）
/// mcpServerId = null の場合はTumiki自体のOAuth（第1層）
/// mcpServerId 設定済みの場合は外部MCPサーバー用OAuth（第2層）
/// @namespace UserMcpServer
model McpOAuthClient {
  id String @id @default(cuid())

  /// 関連するMCPサーバー（null=Tumiki OAuth、設定済み=外部MCPサーバー用）
  mcpServerTemplateId String?
  mcpServerTemplate   McpServerTemplate? @relation(fields: [mcpServerTemplateId], references: [id], onDelete: Cascade)

  /// 組織ID
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  /// DCRで取得したクライアント情報
  clientId                String /// @encrypted
  clientSecret            String? /// @encrypted
  registrationAccessToken String? /// @encrypted
  registrationClientUri   String?

  /// Authorization ServerのベースURL（Discoveryエンドポイント導出用）
  authorizationServerUrl String

  /// リダイレクトURI（DCR登録時に使用）
  redirectUris String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// トークンのリレーション
  oauthTokens McpOAuthToken[]
}

/// OAuth トークン情報（ユーザー×インスタンスごと）
/// 整合性保証: organizationIdは、参照するMcpOAuthClientのorganizationIdと一致する必要がある（アプリケーションレベルで検証）
/// @namespace UserMcpServer
model McpOAuthToken {
  id String @id @default(cuid())

  /// 関連するOAuthクライアント
  oauthClientId String
  oauthClient   McpOAuthClient @relation(fields: [oauthClientId], references: [id], onDelete: Cascade)

  /// どのインスタンス用のトークンか（インスタンスごとに独立したOAuth認証）
  mcpServerTemplateInstanceId String
  mcpServerTemplateInstance   McpServerTemplateInstance @relation(fields: [mcpServerTemplateInstanceId], references: [id], onDelete: Cascade)

  /// ユーザー
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 組織（トークンは組織ごとに発行、組織横断で使い回さない）
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  /// トークン情報
  accessToken  String /// @encrypted
  refreshToken String? /// @encrypted
  expiresAt    DateTime? // Access Tokenの有効期限

  /// トークンの用途を明確化
  tokenPurpose TokenPurpose @default(BACKEND_MCP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 1ユーザー×1インスタンス=1トークン
  @@unique([userId, mcpServerTemplateInstanceId])
}

/// MCPサーバーとテンプレートの関連（同じテンプレートを複数追加可能）
/// @namespace UserMcpServer
model McpServerTemplateInstance {
  id String @id @default(cuid())

  /// インスタンスの識別用正規化名（例: "github-work", "github-personal"）
  normalizedName String

  /// 関連するMCPサーバー
  mcpServerId String
  mcpServer   McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  /// 関連するMCPサーバーテンプレート
  mcpServerTemplateId String
  mcpServerTemplate   McpServerTemplate @relation(fields: [mcpServerTemplateId], references: [id], onDelete: Cascade)

  /// このテンプレートインスタンスが有効か
  isEnabled Boolean @default(true)

  /// 統合サーバー内での表示順序
  displayOrder Int @default(0)

  /// 有効化されたツール一覧
  allowedTools McpTool[]

  mcpConfigs McpConfig[]

  oauthTokens McpOAuthToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mcpServerId, normalizedName])
}
