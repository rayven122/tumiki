/**
 * @namespace UserMcpServer
 * ユーザごとに作成するため、他のユーザには表示されない
 */

/// APIキー等の認証情報（組織レベル/ユーザーレベル）
/// userId = null で組織共通設定、userId 設定済みでユーザー個別設定
/// @namespace UserMcpServer
model McpConfig {
  id      String @id @default(cuid())
  /// MCPサーバーの envVars を文字配列を key にしたオブジェクトを Object.stringify + 暗号化したもの
  envVars String /// @encrypted

  /// 関連するMCPサーバーテンプレート
  mcpServerTemplateId String
  mcpServerTemplate   McpServerTemplate @relation(fields: [mcpServerTemplateId], references: [id], onDelete: Cascade)

  /// 組織（必須）
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  /// ユーザー（nullの場合は組織共通設定、設定済みでユーザー個別設定）
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mcpServerTemplateId, organizationId, userId])
}

/// サーバーの状態
/// @namespace UserMcpServer
enum ServerStatus {
  /// サーバーが起動している
  RUNNING
  /// サーバーが停止している
  STOPPED
  /// サーバーがエラーが発生している
  ERROR
  /// サーバーの接続検証中
  PENDING
}

/// サーバーの種類
/// @namespace UserMcpServer
enum ServerType {
  /// カスタムMCPサーバー
  CUSTOM
  /// 公式MCPサーバー
  OFFICIAL
}

/// 実際に稼働するMCPサーバー
/// 1つまたは複数のMcpServerTemplateから作成
/// allowedTools[] で許可ツールを管理（Prisma暗黙的多対多）
/// @namespace UserMcpServer
model McpServer {
  id           String       @id @default(cuid())
  /// 稼働中のMCPサーバー名
  /// @zod.string.min(1)
  name         String
  /// サーバーの説明
  description  String
  /// アイコンパス
  iconPath     String?
  /// サーバーの状態
  serverStatus ServerStatus
  /// サーバーの種類
  serverType   ServerType

  /// 使用するMCPサーバーテンプレート（複数可）
  mcpServers McpServerTemplate[]

  /// 許可されたツール一覧
  allowedTools McpTool[]

  /// APIキー一覧
  apiKeys        McpApiKey[]
  /// リクエストログ
  requestLogs    McpServerRequestLog[]
  /// 使用する認証タイプ（API_KEY, OAUTH, NONE）
  authType       AuthType              @default(API_KEY)
  /// 組織
  organizationId String
  organization   Organization          @relation(fields: [organizationId], references: [id])
  /// 表示順序（ユーザーごと）
  displayOrder   Int                   @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  /// 論理削除用のタイムスタンプ
  deletedAt DateTime?

  @@index([deletedAt])
}

/// MCPサーバーインスタンスへのリクエストログ
/// @namespace UserMcpServer
model McpServerRequestLog {
  id             String                @id @default(cuid())
  /// MCPサーバーインスタンスID
  mcpServerId    String
  mcpServer      McpServer             @relation(fields: [mcpServerId], references: [id])
  /// 実行されたツール名
  toolName       String
  /// リクエスト時のトランスポートタイプ（SSE, STREAMABLE_HTTPS のどちらか）
  transportType  TransportType
  /// MCPメソッド（tools/list, tools/call）
  method     String
  /// HTTPステータスコード
  httpStatus String
  /// 実行時間（ミリ秒）
  durationMs Int
  /// 入力データサイズ（LLMからMCPサーバーに送信されるデータのバイト数）
  inputBytes     Int
  /// 出力データサイズ（MCPサーバーからLLMに返すデータのバイト数）
  outputBytes    Int
  /// 組織ID
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  /// ユーザーエージェント
  userAgent      String?

  /// GCS統合用フィールド（将来の実装に備えて追加）
  /// GCSオブジェクトキー（パス）（例: logs/2025/01/17/{orgId}/{serverId}/{requestLogId}.json.gz）
  gcsObjectKey  String?
  /// GCSアップロード完了日時
  gcsUploadedAt DateTime?

  createdAt DateTime @default(now())
}

/// APIキー管理テーブル
/// @namespace UserMcpServer
model McpApiKey {
  id          String    @id @default(cuid())
  /// APIキー名（ユーザーが設定）
  name        String
  /// 暗号化されたAPIキー（client_id として使用）
  apiKey      String    @unique /// @encrypted
  /// APIキーをハッシュ化したもの
  apiKeyHash  String?   @unique
  /// APIキーが有効かどうか
  isActive    Boolean   @default(true)
  /// 最後に使用された日時
  lastUsedAt  DateTime?
  /// APIキーの有効期限
  expiresAt   DateTime?
  /// スコープ情報（例: ["mcp:access:notion", "mcp:access:figma"]）
  scopes      String[]  @default([])
  /// 関連するユーザー
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 関連するMcpServerのID
  mcpServerId String
  mcpServer   McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyHash])
}

/// トークンの用途
/// @namespace UserMcpServer
enum TokenPurpose {
  /// AIクライアントが使用するTumikiトークン
  TUMIKI_CLIENT
  /// Backend MCPサーバーへのアクセストークン
  BACKEND_MCP
}

/// OAuth クライアント情報（Dynamic Client Registration で取得）
/// mcpServerId = null の場合はTumiki自体のOAuth（第1層）
/// mcpServerId 設定済みの場合は外部MCPサーバー用OAuth（第2層）
/// @namespace UserMcpServer
model McpOAuthClient {
  id String @id @default(cuid())

  /// 関連するMCPサーバー（null=Tumiki OAuth、設定済み=外部MCPサーバー用）
  mcpServerTemplateId String?
  mcpServerTemplate   McpServerTemplate? @relation(fields: [mcpServerTemplateId], references: [id], onDelete: Cascade)

  /// 組織ID (null=Global)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  /// DCRで取得したクライアント情報
  clientId                String /// @encrypted
  clientSecret            String? /// @encrypted
  registrationAccessToken String? /// @encrypted
  registrationClientUri   String?

  /// Authorization ServerのベースURL（Discoveryエンドポイント導出用）
  authorizationServerUrl String

  /// リダイレクトURI（DCR登録時に使用）
  redirectUris String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// トークンのリレーション
  oauthTokens McpOAuthToken[]
}

/// OAuth トークン情報（ユーザー×組織ごと）
/// 整合性保証: organizationIdは、参照するMcpOAuthClientのorganizationIdと一致する必要がある（アプリケーションレベルで検証）
/// @namespace UserMcpServer
model McpOAuthToken {
  id String @id @default(cuid())

  /// 関連するOAuthクライアント
  oauthClientId String
  oauthClient   McpOAuthClient @relation(fields: [oauthClientId], references: [id], onDelete: Cascade)

  /// ユーザー
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 組織（トークンは組織ごとに発行、組織横断で使い回さない）
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  /// トークン情報
  accessToken  String /// @encrypted
  refreshToken String? /// @encrypted
  expiresAt    DateTime?

  /// トークンの用途を明確化
  tokenPurpose TokenPurpose @default(BACKEND_MCP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 一意性制約: ユーザー×組織×クライアント×用途
  @@unique([userId, organizationId, oauthClientId, tokenPurpose])
}
