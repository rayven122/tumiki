/**
 * @namespace Organization
 */

/// @namespace Organization
model Organization {
  /// Keycloak Group ID
  id           String                   @id
  /// 組織名（表示名）
  name         String
  /// 組織のURL識別子（Keycloak Group名: "@user-id" or "team-slug"）
  slug         String                   @unique
  /// 組織の説明
  description  String?
  /// 組織のロゴURL
  logoUrl      String?
  /// 論理削除フラグ
  isDeleted    Boolean                  @default(false)
  /// 個人組織フラグ（個人ユーザー用の組織の場合true）
  isPersonal   Boolean                  @default(true)
  /// 最大メンバー数（個人組織の場合は1）
  maxMembers   Int                      @default(1)
  /// 組織の作成者
  createdBy    String
  creator      User                     @relation(fields: [createdBy], references: [id])
  /// @deprecated セッション管理に移行。新規コードでは使用しないこと。
  /// この組織をデフォルト組織として設定しているユーザー
  defaultUsers User[]                   @relation("UserDefaultOrganization")
  /// 組織のメンバー
  members   OrganizationMember[]
  /// 組織の招待
  invitations  OrganizationInvitation[]

  /// 組織に関連するMCPサーバー設定
  mcpConfigs         McpConfig[]
  /// 組織に関連するMCPサーバー
  mcpServers         McpServer[]
  /// 組織限定公開のMCPサーバーテンプレート
  mcpServerTemplates McpServerTemplate[]

  /// OAuth関連
  mcpOAuthClients McpOAuthClient[]
  mcpOAuthTokens  McpOAuthToken[]

  /// フィードバック
  feedbacks Feedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// @namespace Organization
model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
}

/// @namespace Organization
model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  /// 招待先メールアドレス
  email          String
  /// 招待トークン
  token          String       @unique @default(cuid())

  /// 招待者のユーザーID
  invitedBy     String
  invitedByUser User     @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  /// 招待時に付与するロール（Keycloak管理）
  roles         String[] @default(["Member"])

  /// 招待の有効期限
  expires   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email])
  @@index([token])
}
