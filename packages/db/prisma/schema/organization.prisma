/**
 * @namespace Organization
 */

/// @namespace Organization
model Organization {
  /// Keycloak Group ID
  id           String                   @id
  /// 組織名（表示名）
  name         String
  /// 組織のURL識別子（Keycloak Group名: "@user-id" or "team-slug"）
  slug         String                   @unique
  /// 組織の説明
  description  String?
  /// 組織のロゴURL
  logoUrl      String?
  /// 論理削除フラグ
  isDeleted    Boolean                  @default(false)
  /// 個人組織フラグ（個人ユーザー用の組織の場合true）
  isPersonal   Boolean                  @default(true)
  /// 最大メンバー数（個人組織の場合は1）
  maxMembers   Int                      @default(1)
  /// 組織の作成者
  createdBy    String
  creator      User                     @relation(fields: [createdBy], references: [id])
  /// @deprecated セッション管理に移行。新規コードでは使用しないこと。
  /// この組織をデフォルト組織として設定しているユーザー
  defaultUsers User[]                   @relation("UserDefaultOrganization")
  /// 組織のメンバー（メタデータのみ、実際のメンバーシップはKeycloak管理）
  members      OrganizationMember[]
  /// 組織のアプリケーションロール（権限定義）
  roles        OrganizationRole[]
  /// 組織の招待
  invitations  OrganizationInvitation[]

  /// 組織に関連するMCPサーバー設定
  mcpConfigs         McpConfig[]
  /// 組織に関連するMCPサーバー
  mcpServers         McpServer[]
  /// 組織限定公開のMCPサーバーテンプレート
  mcpServerTemplates McpServerTemplate[]

  /// OAuth関連
  mcpOAuthClients McpOAuthClient[]
  mcpOAuthTokens  McpOAuthToken[]

  /// フィードバック
  feedbacks Feedback[]

  /// 通知関連
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// @namespace Organization
model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
}

/// @namespace Organization
model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  /// 招待先メールアドレス
  email          String
  /// 招待トークン
  token          String       @unique @default(cuid())

  /// 招待者のユーザーID
  invitedBy     String
  invitedByUser User     @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  /// 招待時に付与するロール（Keycloak管理）
  roles         String[] @default(["Member"])

  /// 招待の有効期限
  expires   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email])
  @@index([token])
}

/// アプリケーションロール定義（権限セット）
/// @namespace Organization
model OrganizationRole {
  /// 組織ID
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  /// URL識別子（例: data-engineer）
  slug           String
  /// ロール名（表示用）
  name           String
  /// ロールの説明
  description    String?
  /// デフォルトロールか（新メンバーに自動付与）
  isDefault      Boolean          @default(false)
  /// このロールが持つ詳細な権限
  permissions    RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([organizationId, slug])
}


/// リソースタイプ
/// @namespace Organization
enum ResourceType {
  /// MCPサーバー設定
  MCP_SERVER_CONFIG
  /// MCPサーバー
  MCP_SERVER
  /// MCPサーバーテンプレート
  MCP_SERVER_TEMPLATE
}

/// ロールに付与された権限（Unix型権限）
/// @namespace Organization
model RolePermission {
  id             String           @id @default(cuid())
  /// 組織ID
  organizationId String
  /// ロールslug
  roleSlug       String
  role           OrganizationRole @relation(fields: [organizationId, roleSlug], references: [organizationId, slug], onDelete: Cascade)
  /// リソースタイプ
  resourceType   ResourceType
  /// リソースID（空文字列の場合は全リソースに適用）
  resourceId     String           @default("")

  /// 読み取り権限（閲覧）
  read    Boolean @default(false)
  /// 書き込み権限（作成・更新・削除）
  write   Boolean @default(false)
  /// 実行権限（MCPツール実行）
  execute Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, roleSlug, resourceType, resourceId])
}
