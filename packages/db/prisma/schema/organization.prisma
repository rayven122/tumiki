/**
 * @namespace Organization
 */

/// @namespace Organization
model Organization {
  /// Keycloak Group ID
  id           String                   @id
  /// 組織名（表示名）
  name         String
  /// 組織のURL識別子（Keycloak Group名: "@user-id" or "team-slug"）
  slug         String                   @unique
  /// 組織の説明
  description  String?
  /// 組織のロゴURL
  logoUrl      String?
  /// 論理削除フラグ
  isDeleted    Boolean                  @default(false)
  /// 個人組織フラグ（個人ユーザー用の組織の場合true）
  isPersonal   Boolean                  @default(true)
  /// 最大メンバー数（個人組織の場合は1）
  maxMembers   Int                      @default(1)
  /// 組織の作成者
  createdBy    String
  creator      User                     @relation(fields: [createdBy], references: [id])
  /// @deprecated セッション管理に移行。新規コードでは使用しないこと。
  /// この組織をデフォルト組織として設定しているユーザー
  defaultUsers User[]                   @relation("UserDefaultOrganization")
  /// 組織のメンバー（メタデータのみ、実際のメンバーシップはKeycloak管理）
  members      OrganizationMember[]
  /// 組織のアプリケーションロール（権限定義）
  roles        OrganizationRole[]
  /// 組織の招待
  invitations  OrganizationInvitation[]

  /// 組織に関連するMCPサーバー設定
  mcpConfigs         McpConfig[]
  /// 組織に関連するMCPサーバー
  mcpServers         McpServer[]
  /// 組織限定公開のMCPサーバーテンプレート
  mcpServerTemplates McpServerTemplate[]

  /// OAuth関連
  mcpOAuthClients McpOAuthClient[]
  mcpOAuthTokens  McpOAuthToken[]

  /// フィードバック
  feedbacks Feedback[]

  /// 通知関連
  notifications Notification[]

  /// チャット関連
  chats Chat[]

  /// エージェント関連
  agents Agent[]

  /// Slack Bot Token（暗号化して保存）
  slackBotToken      String? /// @encrypted
  /// SlackワークスペースのTeam ID
  slackTeamId        String?
  /// Slackワークスペース名（表示用）
  slackTeamName      String?
  /// Slack連携日時
  slackConnectedAt   DateTime?
  /// Slack連携を行ったユーザーID
  slackConnectedById String?
  slackConnectedBy   User?     @relation("SlackConnectedOrganizations", fields: [slackConnectedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// @namespace Organization
model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
}

/// @namespace Organization
model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  /// 招待先メールアドレス
  email          String
  /// 招待トークン
  token          String       @unique @default(cuid())

  /// 招待者のユーザーID
  invitedBy     String
  invitedByUser User     @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  /// 招待時に付与するロール（Keycloak管理）
  roles         String[] @default(["Member"])

  /// 招待の有効期限
  expires   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email])
  @@index([token])
}

/// アプリケーションロール定義（権限セット）
/// @namespace Organization
model OrganizationRole {
  /// 組織slug（URLで使用される識別子）
  organizationSlug String
  organization     Organization                  @relation(fields: [organizationSlug], references: [slug], onDelete: Cascade)
  /// ロールslug（例: data-engineer）
  slug             String
  /// ロール名（表示用）
  name             String
  /// ロールの説明
  description      String?
  /// デフォルトロールか（新メンバーに自動付与）
  isDefault        Boolean                       @default(false)

  /// 全MCPサーバーに適用するデフォルト権限
  defaultRead      Boolean                       @default(false)
  defaultWrite     Boolean                       @default(false)
  defaultExecute   Boolean                       @default(false)

  /// 特定サーバーへの権限設定
  mcpPermissions   McpPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([organizationSlug, slug])
}

/// 特定MCPサーバーへの権限設定（参照整合性あり）
/// @namespace Organization
model McpPermission {
  id               String           @id @default(cuid())

  /// 親のロール
  organizationSlug String
  roleSlug         String
  role             OrganizationRole @relation(fields: [organizationSlug, roleSlug], references: [organizationSlug, slug], onDelete: Cascade)

  /// 対象MCPサーバー（削除時に自動削除）
  mcpServerId      String
  mcpServer        McpServer        @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  /// 権限（trueで権限付与）
  read             Boolean          @default(false)
  write            Boolean          @default(false)
  execute          Boolean          @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationSlug, roleSlug, mcpServerId])
}
