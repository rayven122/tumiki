/**
 * @namespace McpServer
 * 全ユーザが共通して利用するテーブル
 */

/// 接続タイプ
/// @namespace McpServer
enum TransportType {
  /// 標準入出力での通信
  STDIO
  /// Server-Sent Eventsでの通信  
  SSE
  /// Streamable HTTPSでの通信
  STREAMABLE_HTTPS
}

/// 認証タイプ
/// @namespace McpServer
enum AuthType {
  /// 認証不要
  NONE
  /// APIキー認証
  API_KEY
  /// OAuth認証
  OAUTH
}

/// ユーザーカスタムサーバーの可視性
/// @namespace McpServer
enum McpServerVisibility {
  /// 作成者のみ閲覧可能
  PRIVATE
  /// 組織内で共有
  ORGANIZATION
  /// 全ユーザーに公開
  PUBLIC
}

/// MCP サーバーテンプレート（接続情報や認証方式の「設計図」）
/// organizationId = OFFICIAL_ORGANIZATION_ID の場合はアプリ提供の公式テンプレート
/// organizationId が他の値の場合はユーザー作成の組織専用テンプレート
/// @namespace McpServer
/// @namespace UserMcpServer
model McpServerTemplate {
  id             String              @id @default(cuid())
  /// MCP サーバー名
  /// @zod.string.min(1)
  name           String
  /// 正規化されたサーバー名（小文字、空白をハイフンに変換）
  /// @zod.string.min(1)
  normalizedName String
  /// MCPサーバーの説明
  description    String?
  /// タグ（カテゴリー分類用）
  tags           String[]
  /// アイコンパス
  iconPath       String?
  /// 接続タイプ（stdio, sse）
  transportType  TransportType       @default(STDIO)
  /// STDIO用のコマンド
  command        String?
  /// STDIO用の引数
  args           String[]
  /// SSE/Streamable HTTPS接続用のURL
  url            String?
  /// STDIO: 環境変数のキー配列（値はMcpConfigで管理）
  /// SSE/Streamable HTTPS: ヘッダーのキー配列（値はMcpConfigで管理）
  /// Cloud Run: HTTPヘッダー名（X-DeepL-API-Keyなど）を直接指定し、同名の環境変数から値を取得
  envVarKeys     String[]
  /// 認証タイプ
  authType       AuthType            @default(NONE)
  /// OAuth プロバイダー（AuthTypeがOAUTHの場合のみ必須）
  /// google, github, slack, notion, linkedin など
  oauthProvider  String?             @db.VarChar(50)
  /// OAuth で必要なデフォルトスコープ
  oauthScopes    String[]
  /// Google Cloud Run IAM認証を使用するか
  useCloudRunIam Boolean             @default(false)
  /// ユーザーカスタムサーバーの作成者
  createdBy      String?
  creator        User?               @relation(fields: [createdBy], references: [id])
  /// ユーザーカスタムサーバーの可視性
  visibility     McpServerVisibility @default(PRIVATE)
  /// 組織ID（公式テンプレートはOFFICIAL_ORGANIZATION_ID、組織専用テンプレートは組織ID）
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id])

  mcpTools McpTool[] @relation("mcpTools")

  /// テンプレートインスタンス一覧
  templateInstances McpServerTemplateInstance[]

  /// OAuth Client リレーション（1:多）
  oauthClients McpOAuthClient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 組織内で正規化名は一意
  @@unique([normalizedName, organizationId])
}

/// 各MCPサーバーが提供するツール一覧
/// @namespace McpServer
model McpTool {
  id          String @id @default(cuid())
  /// ツールの名前
  /// @zod.string.min(1)
  name        String
  /// ツールの説明
  description String
  /// ツールの入力スキーマ（JSON Schema形式）
  inputSchema Json

  mcpServerTemplateId String
  mcpServerTemplate   McpServerTemplate @relation("mcpTools", fields: [mcpServerTemplateId], references: [id], onDelete: Cascade)

  /// テンプレートインスタンスとの関連
  templateInstances McpServerTemplateInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// MCP サーバー内のツールの名前は一意
  @@unique([mcpServerTemplateId, name])
}
