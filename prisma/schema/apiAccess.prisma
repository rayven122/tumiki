/**
 * @namespace ApiAccess
 * ユーザごとに作成するため、他のユーザには表示されない
 */

/// ユーザーが利用できるMCPサーバーの設定
/// @namespace ApiAccess
model UserMcpServer {
  id            String          @id @default(cuid())
  /// カスタムMCPサーバー名 (ユーザーが設定した名前)
  name          String?
  /// MCPサーバーの envVars を文字配列を key にしたオブジェクトを Object.stringify + 暗号化したもの
  envVars       String /// @encrypted
  /// 利用可能なツールグループ
  tools         Tool[]
  /// MCPサーバーID
  mcpServerId   String
  mcpServer     McpServer       @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  /// ユーザーID
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// ToolGroup, Toolの関連を表す中間テーブル
  toolGroupTool ToolGroupTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ToolGroup, Tool, UserMcpServerの関連を表す中間テーブル
model ToolGroupTool {
  id              String        @id @default(cuid())
  /// ToolGroupへの参照
  toolGroupId     String
  toolGroup       ToolGroup     @relation(fields: [toolGroupId], references: [id], onDelete: Cascade)
  /// Toolへの参照
  toolId          String
  tool            Tool          @relation(fields: [toolId], references: [id], onDelete: Cascade)
  /// このToolがどのUserMcpServerに属しているか
  userMcpServerId String
  userMcpServer   UserMcpServer @relation(fields: [userMcpServerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([toolGroupId, toolId, userMcpServerId])
}

/// どのツール群を利用するかを設定する
/// @namespace ApiAccess
model ToolGroup {
  id             String          @id @default(cuid())
  /// ツールグループ名
  /// @zod.string.min(1)
  name           String
  /// ツールグループの説明
  description    String
  /// ツールグループが有効かどうか
  isEnabled      Boolean         @default(true)
  /// ツールの表示順序を保持するためのID配列
  order          String[]
  /// ユーザーID
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKeys        ApiKey[]
  /// ToolGroupに含まれるTool（中間テーブル経由）
  toolGroupTools ToolGroupTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// APIアクセスの設定
/// @namespace ApiAccess
model ApiKey {
  id          String      @id @default(cuid())
  /// APIアクセス名
  /// @zod.string.min(1)
  name        String
  /// APIアクセスの説明
  description String
  /// ツールグループ
  toolGroups  ToolGroup[]
  /// ユーザーID
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// ツールグループとツールの表示順序を保持するためのID配列
  order       String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
