/**
 * @namespace McpServer
 * @namespace UserMcpServer
 * ユーザごとに作成するため、他のユーザには表示されない
 */

/// ユーザーが利用できるMCPサーバーの設定
/// @namespace McpServer
/// @namespace UserMcpServer
model UserMcpServerConfig {
  id             String        @id @default(cuid())
  /// カスタムMCPサーバー名 (ユーザーが設定した名前)
  name           String?
  /// MCPサーバーの envVars を文字配列を key にしたオブジェクトを Object.stringify + 暗号化したもの
  envVars        String /// @encrypted
  /// 利用可能なツールグループ
  tools          Tool[]
  /// MCPサーバーID
  mcpServerId    String
  mcpServer      McpServer     @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  /// ユーザーID
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 組織
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ToolGroup, Toolの関連を表す中間テーブル
/// @namespace McpServer
/// @namespace UserMcpServer
model UserToolGroupTool {
  /// ToolGroupへの参照
  toolGroupId String
  toolGroup   UserToolGroup @relation(fields: [toolGroupId], references: [id], onDelete: Cascade)
  /// Toolへの参照
  toolId      String
  tool        Tool          @relation(fields: [toolId], references: [id], onDelete: Cascade)
  /// ソート順序
  sortOrder   Int           @default(0)

  createdAt DateTime @default(now())

  @@id([toolGroupId, toolId])
}

/// どのツール群を利用するかを設定する
/// @namespace McpServer
/// @namespace UserMcpServer
model UserToolGroup {
  id                         String                           @id @default(cuid())
  /// ツールグループ名
  /// @zod.string.min(1)
  name                       String
  /// ツールグループの説明
  description                String
  /// ツールグループが有効かどうか
  isEnabled                  Boolean                          @default(true)
  /// ユーザーID
  userId                     String
  user                       User                             @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// ToolGroupに含まれるTool（中間テーブル経由）
  toolGroupTools             UserToolGroupTool[]
  /// 組織
  organizationId             String?
  organization               Organization?                    @relation(fields: [organizationId], references: [id])
  /// MCPサーバーとツールグループの関連を管理する中間テーブル
  mcpServerInstanceToolGroup UserMcpServerInstanceToolGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// MCPサーバーインスタンスとツールグループの関連を管理する中間テーブル
/// @namespace UserMcpServer
/// @namespace McpServer
model UserMcpServerInstanceToolGroup {
  mcpServerInstanceId String
  mcpServerInstance   UserMcpServerInstance @relation(fields: [mcpServerInstanceId], references: [id], onDelete: Cascade)
  toolGroupId         String
  toolGroup           UserToolGroup         @relation(fields: [toolGroupId], references: [id], onDelete: Cascade)
  /// このMcpServerInstance内でのToolGroupの表示順序
  sortOrder           Int                   @default(0)

  createdAt DateTime @default(now())

  @@id([mcpServerInstanceId, toolGroupId])
}

/// MCPサーバーインスタンスとツールの関連を管理する中間テーブル
/// @namespace UserMcpServer
/// @namespace McpServer
model UserMcpServerInstanceTool {
  mcpServerInstanceId String
  mcpServerInstance   UserMcpServerInstance @relation(fields: [mcpServerInstanceId], references: [id], onDelete: Cascade)
  toolId              String
  tool                Tool                  @relation(fields: [toolId], references: [id], onDelete: Cascade)
  /// このMcpServerInstance内でのToolの表示順序
  sortOrder           Int                   @default(0)

  createdAt DateTime @default(now())

  @@id([mcpServerInstanceId, toolId])
}

/// サーバーの状態
/// @namespace UserMcpServer
/// @namespace McpServer
enum ServerStatus {
  /// サーバーが起動している
  RUNNING
  /// サーバーが停止している
  STOPPED
}

/// サーバーの種類
/// @namespace UserMcpServer
/// @namespace McpServer
enum ServerType {
  /// カスタムMCPサーバー
  CUSTOM
  /// 公式MCPサーバー
  OFFICIAL
}

/// MCPサーバーとして利用するインスタンス
/// @namespace McpServer
/// @namespace UserMcpServer
model UserMcpServerInstance {
  id                         String                           @id @default(cuid())
  /// サーバー名
  /// @zod.string.min(1)
  name                       String
  /// サーバーの説明
  description                String
  /// サーバーの状態
  serverStatus               ServerStatus
  /// サーバーの種類
  serverType                 ServerType
  /// ツール関連を管理する中間テーブル
  mcpServerInstanceTool      UserMcpServerInstanceTool[]
  /// MCPサーバーとツールグループの関連を管理する中間テーブル
  mcpServerInstanceToolGroup UserMcpServerInstanceToolGroup[]
  /// ユーザーID
  userId                     String
  user                       User                             @relation(fields: [userId], references: [id])
  /// 組織
  organizationId             String?
  organization               Organization?                    @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
