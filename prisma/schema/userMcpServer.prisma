/**
 * @namespace McpServer
 * @namespace UserMcpServer
 * ユーザごとに作成するため、他のユーザには表示されない
 */

/// ユーザーが利用できるMCPサーバーの設定
/// @namespace McpServer
/// @namespace UserMcpServer
model UserMcpServerConfig {
  id                 String                  @id @default(cuid())
  /// MCPサーバーの envVars を文字配列を key にしたオブジェクトを Object.stringify + 暗号化したもの
  envVars            String /// @encrypted
  /// 利用可能なツールグループ
  tools              Tool[]
  /// MCPサーバーインスタンス
  mcpServerInstances UserMcpServerInstance[]
  /// MCPサーバーID
  mcpServerId        String
  mcpServer          McpServer               @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  /// ユーザーID
  userId             String
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// 組織
  organizationId     String?
  organization       Organization?           @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ToolGroup, Toolの関連を表す中間テーブル
/// @namespace McpServer
/// @namespace UserMcpServer
model UserToolGroupTool {
  /// ToolGroupへの参照
  toolGroupId String
  toolGroup   UserToolGroup @relation(fields: [toolGroupId], references: [id], onDelete: Cascade)
  /// Toolへの参照
  toolId      String
  tool        Tool          @relation(fields: [toolId], references: [id], onDelete: Cascade)
  /// ソート順序
  sortOrder   Int           @default(0)

  createdAt DateTime @default(now())

  @@id([toolGroupId, toolId])
}

/// どのツール群を利用するかを設定する
/// @namespace McpServer
/// @namespace UserMcpServer
model UserToolGroup {
  id                          String                           @id @default(cuid())
  /// ツールグループ名
  /// @zod.string.min(1)
  name                        String
  /// ツールグループの説明
  description                 String
  /// ツールグループが有効かどうか
  isEnabled                   Boolean                          @default(true)
  /// UserMcpServerInstance ごとに1つの ToolGroup が存在する
  mcpServerInstance           UserMcpServerInstance?
  /// ユーザーID
  userId                      String
  user                        User                             @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// ToolGroupに含まれるTool（中間テーブル経由）
  toolGroupTools              UserToolGroupTool[]
  /// 組織
  organizationId              String?
  organization                Organization?                    @relation(fields: [organizationId], references: [id])
  /// MCPサーバーとツールグループの関連を管理する中間テーブル
  mcpServerInstanceToolGroups UserMcpServerInstanceToolGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// MCPサーバーインスタンスとツールグループの関連を管理する中間テーブル
/// @namespace UserMcpServer
/// @namespace McpServer
model UserMcpServerInstanceToolGroup {
  mcpServerInstanceId String
  mcpServerInstance   UserMcpServerInstance @relation(fields: [mcpServerInstanceId], references: [id], onDelete: Cascade)
  toolGroupId         String
  toolGroup           UserToolGroup         @relation(fields: [toolGroupId], references: [id], onDelete: Cascade)
  /// このMcpServerInstance内でのToolGroupの表示順序
  sortOrder           Int                   @default(0)

  createdAt DateTime @default(now())

  @@id([mcpServerInstanceId, toolGroupId])
}

/// サーバーの状態
/// @namespace UserMcpServer
/// @namespace McpServer
enum ServerStatus {
  /// サーバーが起動している
  RUNNING
  /// サーバーが停止している
  STOPPED
  /// サーバーがエラーが発生している
  ERROR
}

/// サーバーの種類
/// @namespace UserMcpServer
/// @namespace McpServer
enum ServerType {
  /// カスタムMCPサーバー
  CUSTOM
  /// 公式MCPサーバー
  OFFICIAL
}

/// MCPサーバーとして利用するインスタンス
/// @namespace McpServer
/// @namespace UserMcpServer
model UserMcpServerInstance {
  id                          String                           @id @default(cuid())
  /// 稼働中のMCPサーバー名
  /// @zod.string.min(1)
  name                        String
  /// サーバーの説明
  description                 String
  /// アイコンパス
  iconPath                    String?
  /// サーバーの状態
  serverStatus                ServerStatus
  /// サーバーの種類
  serverType                  ServerType
  /// MCPサーバーの設定
  mcpServerConfigs            UserMcpServerConfig[]
  /// MCPサーバーとツールグループの関連を管理する中間テーブル
  mcpServerInstanceToolGroups UserMcpServerInstanceToolGroup[]
  /// ツールグループ
  /// UserMcpServerInstance ごとに1つの ToolGroup が存在する 1:1 関係
  toolGroupId                 String                           @unique
  toolGroup                   UserToolGroup                    @relation(fields: [toolGroupId], references: [id])
  /// ユーザーID
  userId                      String
  user                        User                             @relation(fields: [userId], references: [id])
  /// 組織
  organizationId              String?
  organization                Organization?                    @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
