name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: ğŸš€ CI
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - name: ğŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ğŸ”§ Build tooling packages
        run: pnpm run --filter @tumiki/tsup-config build && pnpm run --filter @tumiki/vitest-config build
        # toolingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…ˆã«ãƒ“ãƒ«ãƒ‰

      - name: ğŸ”§ Build dependencies
        run: pnpm run --filter @tumiki/mailer build && pnpm run --filter @tumiki/db build && pnpm run --filter @tumiki/auth build && pnpm run --filter @tumiki/utils build
        # CIç’°å¢ƒã§@tumiki/mailerã®å‹å®šç¾©ã‚’ç¢ºå®Ÿã«ç”Ÿæˆã™ã‚‹ãŸã‚ã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ãƒ“ãƒ«ãƒ‰

      - name: âœ… Run lint, format and typecheck
        run: pnpm check

  build:
    name: ğŸ§° Build
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - name: ğŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ğŸ”§ Copy test environment file
        run: cp .env.test .env

      - name: ğŸ”§ Build tooling packages
        run: pnpm run --filter @tumiki/tsup-config build && pnpm run --filter @tumiki/vitest-config build
        # toolingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…ˆã«ãƒ“ãƒ«ãƒ‰

      - name: ğŸ—ï¸ Run build
        run: pnpm run build
