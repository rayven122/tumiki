name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches: [main]

jobs:
  build:
    name: ðŸ”§ Build
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ðŸ“ Create .env file for CI
        run: cp .env.example .env

      - name: ðŸ”§ Build packages
        run: pnpm turbo build

  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ðŸ“ Create .env file for CI
        run: cp .env.example .env

      - name: ðŸ” Run lint
        run: pnpm turbo lint

  format:
    name: ðŸ’… Format
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ðŸ’… Check format
        run: pnpm turbo format

  typecheck:
    name: ðŸ”¬ Typecheck
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ðŸ“ Create .env file for CI
        run: cp .env.example .env

      - name: ðŸ”¬ Run typecheck
        run: pnpm turbo typecheck

  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup
        uses: ./.github/actions/setup

      - name: ðŸ“ Create .env file for CI
        run: cp .env.example .env

      - name: ðŸ”§ Build packages
        run: pnpm turbo build

      - name: ðŸ§ª Run tests
        run: pnpm test

  docker-smoke-test:
    name: ðŸ³ Docker Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4

      - name: ðŸ”¨ Build manager image
        run: docker build -f apps/manager/Dockerfile -t tumiki-manager .

      - name: ðŸ”¨ Build mcp-proxy image
        run: docker build -f apps/mcp-proxy/Dockerfile -t tumiki-mcp-proxy .

      - name: ðŸš€ Start containers
        run: |
          docker run -d --name manager -p 8080:8080 \
            -e KEYCLOAK_CLIENT_ID=test \
            -e KEYCLOAK_CLIENT_SECRET=test \
            -e KEYCLOAK_ISSUER=https://dummy.keycloak.local/realms/tumiki \
            tumiki-manager
          docker run -d --name mcp-proxy -p 8081:8080 \
            tumiki-mcp-proxy

      - name: âœ… Wait and verify health endpoints
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/api/health > /dev/null 2>&1 && \
               curl -sf http://localhost:8081/health > /dev/null 2>&1; then
              echo "=== Manager ==="
              curl -sf http://localhost:8080/api/health | jq .
              echo "=== MCP Proxy ==="
              curl -sf http://localhost:8081/health | jq .
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "Timeout waiting for containers"
          docker logs manager
          docker logs mcp-proxy
          exit 1
