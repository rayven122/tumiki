name: Desktop Release

on:
  push:
    tags:
      - "desktop-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚° (ä¾‹: desktop-v0.1.0)"
        required: true
        type: string

jobs:
  # macOSç”¨ãƒ“ãƒ«ãƒ‰
  build-macos:
    name: ğŸ macOS ãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Build database package
        run: pnpm --filter @tumiki/db build

      - name: ğŸ”§ Generate Prisma client for desktop
        run: |
          cd apps/desktop
          pnpm db:generate

      - name: ğŸ”¨ Build Electron app
        run: |
          cd apps/desktop
          pnpm build
        env:
          # Keycloakèªè¨¼ç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¿ï¼‰
          KEYCLOAK_ISSUER: ${{ secrets.KEYCLOAK_ISSUER }}
          DESKTOP_KEYCLOAK_CLIENT_ID: ${{ secrets.DESKTOP_KEYCLOAK_CLIENT_ID }}
          DESKTOP_KEYCLOAK_CLIENT_SECRET: ${{ secrets.DESKTOP_KEYCLOAK_CLIENT_SECRET }}

      - name: ğŸ“¦ Package for macOS (x64 + arm64)
        run: |
          cd apps/desktop
          pnpm build:release
        env:
          # Keycloakèªè¨¼ç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆbuild:releaseãŒå†…éƒ¨ã§pnpm buildã‚’å†å®Ÿè¡Œã™ã‚‹ãŸã‚å¿…è¦ï¼‰
          KEYCLOAK_ISSUER: ${{ secrets.KEYCLOAK_ISSUER }}
          DESKTOP_KEYCLOAK_CLIENT_ID: ${{ secrets.DESKTOP_KEYCLOAK_CLIENT_ID }}
          DESKTOP_KEYCLOAK_CLIENT_SECRET: ${{ secrets.DESKTOP_KEYCLOAK_CLIENT_SECRET }}
          # å°†æ¥çš„ã«ã‚³ãƒ¼ãƒ‰ç½²åã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å ´åˆ:
          # Apple Developerè¨¼æ˜æ›¸ãŒå¿…è¦ã§ã™
          # CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
          # CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          # å…¬è¨¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆ:
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            apps/desktop/out/*.dmg
            apps/desktop/out/*.zip
          retention-days: 7

  # GitHub Releaseã®ä½œæˆ
  create-release:
    name: ğŸ“¢ GitHub Release ä½œæˆ
    needs: [build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-builds
          path: artifacts/

      - name: ğŸ“‹ Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#desktop-v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Tumiki Desktop ${{ steps.version.outputs.version }}

          ### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

          **macOS:**
          - Intel Mac: `Tumiki-${{ steps.version.outputs.version }}-x64.dmg`
          - Apple Silicon (M1/M2/M3): `Tumiki-${{ steps.version.outputs.version }}-arm64.dmg`
          - ZIPç‰ˆï¼ˆä¸¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œï¼‰: `Tumiki-${{ steps.version.outputs.version }}-mac.zip`

          ### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          1. ãŠä½¿ã„ã®Macã«å¯¾å¿œã—ãŸDMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€Tumikiã‚’Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°
          3. åˆå›èµ·å‹•æ™‚ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆ:
             - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š > ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ > ã€Œã“ã®ã¾ã¾é–‹ãã€ã‚’ã‚¯ãƒªãƒƒã‚¯

          ### ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

          - macOS 11.0 (Big Sur) ä»¥é™
          - Intel ã¾ãŸã¯ Apple Silicon ãƒ—ãƒ­ã‚»ãƒƒã‚µ

          ### æ³¨æ„äº‹é …

          - ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ç½²åãƒ»å…¬è¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“
          - å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§Appleå…¬è¨¼ã«å¯¾å¿œäºˆå®šã§ã™

          ---

          ğŸ¤– ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          EOF

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Tumiki Desktop v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Slacké€šçŸ¥
  notify:
    name: ğŸ“¢ Slacké€šçŸ¥
    needs: [create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#desktop-v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: ğŸ“¨ Send Slack notification
        if: ${{ vars.SLACK_ENABLED == 'true' }}
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.0.0
        with:
          payload: |
            {
              "text": "${{ needs.create-release.result == 'success' && 'âœ…' || 'âŒ' }} Tumiki Desktop Release",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.create-release.result == 'success' && 'âœ…' || 'âŒ' }} Tumiki Desktop v${{ steps.version.outputs.version }} ãƒªãƒªãƒ¼ã‚¹"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¿ã‚°:*\n${{ steps.version.outputs.tag }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:*\n${{ needs.create-release.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡Œè€…:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}|ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
