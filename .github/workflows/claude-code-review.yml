name: ğŸ” Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    name: ğŸ“ Code Review Assistant
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: arc-runner-set
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ## ç¬¬1æ®µéš: è©³ç´°ãªã‚³ãƒ¼ãƒ‰åˆ†æ

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰å¾¹åº•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

            ### 1. ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - å‘½åè¦ç´„ã®ä¸€è²«æ€§
            - ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ï¼ˆDRYåŸå‰‡ï¼‰
            - è¤‡é›‘æ€§ã®è©•ä¾¡

            ### 2. è¨­è¨ˆåŸå‰‡ã®éµå®ˆ
            - **SOLIDåŸå‰‡**: å˜ä¸€è²¬ä»»ã€é–‹æ”¾é–‰é–ã€ãƒªã‚¹ã‚³ãƒ•ç½®æ›ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆ†é›¢ã€ä¾å­˜æ€§é€†è»¢
            - **KISSåŸå‰‡**: ã‚·ãƒ³ãƒ—ãƒ«ã•ã®ç¶­æŒ
            - **YAGNIåŸå‰‡**: ä¸è¦ãªæ©Ÿèƒ½ã®å®Ÿè£…ã‚’é¿ã‘ã‚‹
            - **DRYåŸå‰‡**: ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚’é¿ã‘ã‚‹

            ### 3. æ½œåœ¨çš„ãªãƒã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®é©åˆ‡æ€§
            - nullã‚„undefinedã®å‡¦ç†
            - å‹å®‰å…¨æ€§ï¼ˆTypeScriptã®å ´åˆï¼‰

            ### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
            - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŠ¹ç‡æ€§
            - ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆReactã®å ´åˆï¼‰
            - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
            - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§

            ### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            - ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã¸ã®å¯¾ç­–
            - èªè¨¼ãƒ»èªå¯ã®é©åˆ‡æ€§
            - æ©Ÿå¯†æƒ…å ±ã®å–ã‚Šæ‰±ã„
            - ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§

            ### 6. ãƒ†ã‚¹ãƒˆã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ååˆ†æ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

            ## ç¬¬2æ®µéš: è‡ªå·±è©•ä¾¡ã¨æ”¹å–„ææ¡ˆã®å„ªå…ˆé †ä½ä»˜ã‘

            ä¸Šè¨˜ã®åˆ†æã‚’è¡Œã£ãŸå¾Œã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

            1. **å„æŒ‡æ‘˜äº‹é …ã«é‡è¦åº¦ã‚¹ã‚³ã‚¢ã‚’ä»˜ä¸**ï¼ˆ1-10ï¼‰
               - 10: ç·Šæ€¥å¯¾å¿œå¿…é ˆï¼ˆæœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ï¼‰
               - 7-9: é‡è¦ï¼ˆãƒãƒ¼ã‚¸å‰ã«ä¿®æ­£æ¨å¥¨ï¼‰
               - 4-6: ä¸­ç¨‹åº¦ï¼ˆæ”¹å–„æ¨å¥¨ï¼‰
               - 1-3: è»½å¾®ï¼ˆå°†æ¥çš„ãªæ”¹å–„æ¡ˆï¼‰

            2. **å…·ä½“çš„ãªæ”¹å–„ã‚³ãƒ¼ãƒ‰ã®æç¤º**
               - å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®å¼•ç”¨
               - æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ä¾‹
               - ãªãœãã®æ”¹å–„ãŒå¿…è¦ã‹ã®èª¬æ˜

            3. **å…¨ä½“çš„ãªè©•ä¾¡**
               - ã“ã®PRã®å¼·ã¿
               - æ”¹å–„ãŒå¿…è¦ãªä¸»è¦é ˜åŸŸ
               - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®æ¨å¥¨äº‹é …

          # Add custom instructions for Japanese language support with review history management
          custom_instructions: |
            ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ãã ã•ã„ï¼š
            - å…¨ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨å›ç­”ã‚’æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„
            - å»ºè¨­çš„ã§å®Ÿè·µçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„
            - æŠ€è¡“çš„ãªç”¨èªã¯é©åˆ‡ãªæ—¥æœ¬èªã¾ãŸã¯è‹±èªã§èª¬æ˜ã—ã¦ãã ã•ã„

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ## ğŸ¤– Claude Code Review

            ### ğŸ“ æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
            **æ—¥æ™‚**: {ç¾åœ¨ã®æ—¥æ™‚ã‚’YYYY-MM-DD HH:mmå½¢å¼ã§è¨˜è¼‰}
            **ã‚³ãƒŸãƒƒãƒˆ**: {ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆæœ€åˆã®7æ–‡å­—ï¼‰}
            **ç·åˆè©•ä¾¡**: {ä»¥ä¸‹ã‹ã‚‰é¸æŠ: âœ… æ‰¿èªå¯èƒ½ / âš ï¸ æ”¹å–„æ¨å¥¨ / âŒ è¦ä¿®æ­£}

            ### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
            **é‡è¦åº¦ã‚¹ã‚³ã‚¢åˆ†å¸ƒ**:
            - ğŸ”´ ç·Šæ€¥ï¼ˆ8-10ï¼‰: {ä»¶æ•°}ä»¶
            - ğŸŸ¡ é‡è¦ï¼ˆ5-7ï¼‰: {ä»¶æ•°}ä»¶
            - ğŸŸ¢ è»½å¾®ï¼ˆ1-4ï¼‰: {ä»¶æ•°}ä»¶

            **ä¸»ãªæŒ‡æ‘˜äº‹é …** ï¼ˆé‡è¦åº¦é †ï¼‰:
            {æœ€ã‚‚é‡è¦ãª3-5ä»¶ã®æŒ‡æ‘˜ã‚’é‡è¦åº¦ã‚¹ã‚³ã‚¢ã¨å…±ã«è¨˜è¼‰}

            ### ğŸ” è©³ç´°åˆ†æ

            #### 1. è¨­è¨ˆåŸå‰‡ã®è©•ä¾¡
            - **SOLIDåŸå‰‡**: {éµå®ˆåº¦ã‚’5æ®µéšã§è©•ä¾¡ â­â­â­â­â­}
            - **DRY/KISS/YAGNI**: {éµå®ˆåº¦ã‚’5æ®µéšã§è©•ä¾¡ â­â­â­â­â­}
            - **å…·ä½“çš„ãªæ”¹å–„ç‚¹**: {é•åãŒã‚ã‚Œã°å…·ä½“ä¾‹ã‚’è¨˜è¼‰}

            #### 2. é‡è¦ãªæŒ‡æ‘˜äº‹é …ï¼ˆé‡è¦åº¦8ä»¥ä¸Šï¼‰
            {å„é …ç›®ã«ã¤ã„ã¦ä»¥ä¸‹ã®å½¢å¼ã§è¨˜è¼‰:}

            **ğŸ”´ [é‡è¦åº¦: X/10] å•é¡Œã®æ¦‚è¦**
            - **ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.ts:è¡Œç•ªå·`
            - **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰**:
            ```typescript
            // å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
            ```
            - **æ”¹å–„æ¡ˆ**:
            ```typescript
            // æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰
            ```
            - **ç†ç”±**: {ãªãœã“ã®å¤‰æ›´ãŒå¿…è¦ã‹}

            #### 3. æ”¹å–„æ¨å¥¨äº‹é …ï¼ˆé‡è¦åº¦5-7ï¼‰
            {åŒæ§˜ã®å½¢å¼ã§è¨˜è¼‰ã€ãŸã ã—ç°¡æ½”ã«}

            #### 4. è»½å¾®ãªææ¡ˆï¼ˆé‡è¦åº¦1-4ï¼‰
            {ãƒªã‚¹ãƒˆå½¢å¼ã§ç°¡æ½”ã«è¨˜è¼‰}

            ### âœ¨ è‰¯ã„ç‚¹
            {ã“ã®PRã®å„ªã‚Œã¦ã„ã‚‹ç‚¹ã‚’2-3å€‹æŒ™ã’ã‚‹}

            ### ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            {é–‹ç™ºè€…ãŒå–ã‚‹ã¹ãå…·ä½“çš„ãªè¡Œå‹•ã‚’å„ªå…ˆé †ä½ä»˜ãã§è¨˜è¼‰}

            ### ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
            - **ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢**: {10ç‚¹æº€ç‚¹}
            - **ä¿å®ˆæ€§**: {é«˜/ä¸­/ä½}
            - **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¸ã®å½±éŸ¿**: {æ”¹å–„/ç¶­æŒ/ä½ä¸‹}
            - **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿**: {æ”¹å–„/å½±éŸ¿ãªã—/æ‡¸å¿µã‚ã‚Š}
            - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**: {ãªã—/ä½/ä¸­/é«˜}

          # Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          use_sticky_comment: true

          # Optional: Customize review based on file types
          # direct_prompt: |
          #   Review this PR focusing on:
          #   - For TypeScript files: Type safety and proper interface usage
          #   - For API endpoints: Security, input validation, and error handling
          #   - For React components: Performance, accessibility, and best practices
          #   - For tests: Coverage, edge cases, and test quality

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"

          # Optional: Skip review for certain conditions
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')

  # Auto-fix job that runs after Claude review if auto-fix label is present
  auto-fix:
    name: ğŸ”§ Auto-Fix Issues
    needs: claude-review
    if: contains(github.event.pull_request.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ğŸ¤– Run Auto-Fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          node .github/scripts/claude-auto-fix.js
