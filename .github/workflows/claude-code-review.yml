name: ğŸ” Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    name: ğŸ“ Code Review Assistant
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: arc-runner-set
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š
            - ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - æ½œåœ¨çš„ãªãƒã‚°ã‚„å•é¡Œ
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®äº‹é …
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ‡¸å¿µ
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

            å»ºè¨­çš„ã§å½¹ã«ç«‹ã¤ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

          # Add custom instructions for Japanese language support with review history management
          custom_instructions: |
            ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ãã ã•ã„ï¼š
            - å…¨ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨å›ç­”ã‚’æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„
            - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã«å¾“ã£ã¦ãã ã•ã„
            - å»ºè¨­çš„ã§ä¸å¯§ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„
            - æŠ€è¡“çš„ãªç”¨èªã¯é©åˆ‡ãªæ—¥æœ¬èªã¾ãŸã¯è‹±èªã§èª¬æ˜ã—ã¦ãã ã•ã„

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ## ğŸ¤– Claude Code Review

            ### ğŸ“ æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
            **æ—¥æ™‚**: {ç¾åœ¨ã®æ—¥æ™‚ã‚’YYYY-MM-DD HH:mmå½¢å¼ã§è¨˜è¼‰}
            **ã‚³ãƒŸãƒƒãƒˆ**: {ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼ˆæœ€åˆã®7æ–‡å­—ï¼‰}
            **è©•ä¾¡**: {ä»¥ä¸‹ã‹ã‚‰é¸æŠ: âœ… å•é¡Œãªã— / âš ï¸ æ”¹å–„ææ¡ˆã‚ã‚Š / âŒ è¦ä¿®æ­£}

            #### ã‚µãƒãƒªãƒ¼
            {ä¸»ãªæŒ‡æ‘˜äº‹é …ã‚’3-5è¡Œã§ç°¡æ½”ã«è¨˜è¼‰ã€‚é‡è¦åº¦ã®é«˜ã„ã‚‚ã®ã‹ã‚‰é †ã«è¨˜è¼‰}

            #### è©³ç´°
            - **ã‚³ãƒ¼ãƒ‰å“è³ª**: {è‰¯å¥½/æ”¹å–„ä½™åœ°ã‚ã‚Š/è¦æ”¹å–„ãªã©ç°¡æ½”ãªè©•ä¾¡}
            - **æ½œåœ¨çš„ãªå•é¡Œ**: {ãªã—/è»½å¾®/è¦å¯¾å¿œãªã©ç°¡æ½”ãªè©•ä¾¡}
            - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: {å•é¡Œãªã—/ç¢ºèªäº‹é …ã‚ã‚Š/è¦ä¿®æ­£ãªã©ç°¡æ½”ãªè©•ä¾¡}
            - **æ”¹å–„ææ¡ˆ**: {ä¸»è¦ãªææ¡ˆã‚’1è¡Œã§ã€‚ãªã‘ã‚Œã°ã€Œç‰¹ã«ãªã—ã€}

            ---

            ### ğŸ“š éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´

            {æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã«éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã€ä»¥ä¸‹ã®å½¢å¼ã§å„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å€‹åˆ¥ã«æŠ˜ã‚ŠãŸãŸã‚“ã§è¿½åŠ }
            {æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å¤ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é †ï¼ˆé™é †ï¼‰ã§é…ç½®}

            <details>
            <summary>ãƒ¬ãƒ“ãƒ¥ãƒ¼ #N - {éå»ã®æ—¥æ™‚} - {éå»ã®è©•ä¾¡ã‚¢ã‚¤ã‚³ãƒ³}</summary>

            {éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’ãã®ã¾ã¾ä¿æŒ}

            </details>

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          use_sticky_comment: true

          # Optional: Customize review based on file types
          # direct_prompt: |
          #   Review this PR focusing on:
          #   - For TypeScript files: Type safety and proper interface usage
          #   - For API endpoints: Security, input validation, and error handling
          #   - For React components: Performance, accessibility, and best practices
          #   - For tests: Coverage, edge cases, and test quality

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"

          # Optional: Skip review for certain conditions
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')
