name: CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  # ç’°å¢ƒåˆ¤å®š
  setup:
    name: ğŸ”§ ç’°å¢ƒè¨­å®š
    runs-on:
      group: self-arc
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      stage: ${{ steps.env.outputs.stage }}
      is_pr: ${{ steps.env.outputs.is_pr }}
      pr_number: ${{ steps.env.outputs.pr_number }}
    steps:
      - uses: actions/checkout@v4
      - id: env
        uses: ./.github/actions/determine-env

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆstaging/productionæ™‚ã®ã¿å®Ÿè¡Œã€previewç’°å¢ƒã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  migrate-database:
    name: ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    needs: setup
    if: needs.setup.outputs.environment != 'preview'
    runs-on:
      group: self-arc
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      migration_applied: ${{ steps.migrate.outputs.migration_applied }}
      migration_names: ${{ steps.migrate.outputs.migration_names }}
      preview_migration_applied: ${{ steps.migrate-preview.outputs.migration_applied }}
      preview_migration_names: ${{ steps.migrate-preview.outputs.migration_names }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Fetch Vercel environment variables
        uses: ./.github/actions/fetch-vercel-env
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          environment: ${{ needs.setup.outputs.environment }}
          output-file: .env

      - name: ğŸ’¾ Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build packages (database only)
        run: pnpm turbo build --filter=@tumiki/db

      - name: Migrate staging/production database
        id: migrate
        uses: ./.github/actions/migrate-database
        with:
          database_url: ${{ needs.setup.outputs.environment == 'production' && secrets.DATABASE_URL_PRODUCTION || secrets.DATABASE_URL_STAGING }}
          environment: ${{ needs.setup.outputs.environment }}

      - name: Also migrate preview database (when merging to main)
        id: migrate-preview
        if: needs.setup.outputs.environment == 'staging'
        uses: ./.github/actions/migrate-database
        with:
          database_url: ${{ secrets.DATABASE_URL_PREVIEW }}
          environment: preview

  # Vercelãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    name: ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [setup, migrate-database]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped' || needs.setup.outputs.environment == 'preview')
    runs-on:
      group: self-arc
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      vercel_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Fetch Vercel environment variables
        uses: ./.github/actions/fetch-vercel-env
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          environment: ${{ needs.setup.outputs.environment }}
          output-file: .env

      - name: ğŸ’¾ Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build packages
        run: pnpm turbo build

      - name: Configure git user for deployment
        run: |
          git config --global user.email "efficient122@gmail.com"
          git config --global user.name "Tumiki Deploy Bot"

      - name: Create deploy commit
        run: |
          git commit --allow-empty -m "chore: deploy commit for ${{ needs.setup.outputs.environment }} [skip ci]"

      - name: Deploy to Vercel
        id: deploy
        uses: ./.github/actions/deploy-vercel
        with:
          stage: ${{ needs.setup.outputs.stage }}
          vercel_token: ${{ secrets.VERCEL_TOKEN }}

  # Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå…¨ç’°å¢ƒå¯¾å¿œï¼‰
  deploy-cloudrun:
    name: ğŸš€ Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [setup, migrate-database]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on:
      group: self-arc
    # Previewç’°å¢ƒã§ã¯stagingã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€environmentã‚’stagingã«è¨­å®š
    environment: ${{ needs.setup.outputs.environment == 'production' && 'production' || 'staging' }}
    outputs:
      cloudrun_url: ${{ steps.deploy-cloudrun.outputs.service_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Fetch Vercel environment variables
        uses: ./.github/actions/fetch-vercel-env
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          environment: ${{ needs.setup.outputs.environment }}
          output-file: .env

      - name: ğŸ’¾ Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build packages
        run: pnpm turbo build

      - name: Deploy to Cloud Run
        id: deploy-cloudrun
        uses: ./.github/actions/deploy-cloudrun
        with:
          environment: ${{ needs.setup.outputs.environment }}
          pr_number: ${{ needs.setup.outputs.pr_number }}
          gcp_credentials: ${{ secrets.GCP_SA_KEY_PRODUCTION }}
          gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
          vercel_token: ${{ secrets.VERCEL_TOKEN }}
          vercel_org_id: ${{ secrets.VERCEL_ORG_ID }}
          vercel_project_id: ${{ secrets.VERCEL_PROJECT_ID }}

  # PRã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚³ãƒ¡ãƒ³ãƒˆ
  comment-deployment:
    name: ğŸ’¬ ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚³ãƒ¡ãƒ³ãƒˆ
    needs: [setup, deploy, deploy-cloudrun]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      (needs.deploy.result == 'success' || needs.deploy-cloudrun.result == 'success')
    runs-on:
      group: self-arc
    steps:
      - uses: actions/checkout@v4

      - name: Comment deployment URLs
        uses: ./.github/actions/comment-deployment
        with:
          vercel_url: ${{ needs.deploy.outputs.vercel_url }}
          cloudrun_url: ${{ needs.deploy-cloudrun.outputs.cloudrun_url }}
          environment: ${{ needs.setup.outputs.environment }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
  notify:
    name: ğŸ“¢ çµæœé€šçŸ¥
    needs: [setup, migrate-database, deploy, deploy-cloudrun]
    if: |
      always() &&
      (needs.setup.outputs.is_pr != 'true' ||
       contains(github.event.pull_request.labels.*.name, 'test-slack'))
    runs-on:
      group: self-arc
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub summary
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ needs.setup.outputs.environment }}';
            const migrationStatus = '${{ needs.migrate-database.result }}';
            const deployStatus = '${{ needs.deploy.result }}';
            const cloudrunStatus = '${{ needs.deploy-cloudrun.result }}';
            const isProduction = environment === 'production';
            const isPreview = environment === 'preview';

            let emoji = 'âœ…';
            if (migrationStatus === 'failure' || deployStatus === 'failure' || cloudrunStatus === 'failure') {
              emoji = 'âŒ';
            }

            let summary = `## ${emoji} ${environment}ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤\n\n`;
            summary += `| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
            summary += `|---------------|------------|\n`;

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if (migrationStatus && migrationStatus !== 'skipped') {
              const dbLabel = isPreview ? 'Preview DB' : 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹';
              summary += `| ${dbLabel} | ${migrationStatus === 'success' ? 'âœ…' : 'âŒ'} ${migrationStatus} |\n`;
            }

            // Vercelãƒ‡ãƒ—ãƒ­ã‚¤
            summary += `| Vercel | ${deployStatus === 'success' ? 'âœ…' : deployStatus === 'failure' ? 'âŒ' : 'âš ï¸'} ${deployStatus} |\n`;

            // Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
            summary += `| Cloud Run (MCP Proxy) | ${cloudrunStatus === 'success' ? 'âœ…' : cloudrunStatus === 'failure' ? 'âŒ' : 'âš ï¸'} ${cloudrunStatus} |\n`;

            summary += `\n**Triggered by:** ${{ github.actor }}\n`;
            summary += `**Commit:** ${{ github.sha }}`;

            await core.summary.addRaw(summary).write();

      - name: Send Slack notification
        if: success() || failure()
        uses: ./.github/actions/notify-slack-summary
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          environment: ${{ needs.setup.outputs.environment }}
          migration_status: ${{ needs.setup.outputs.environment == 'preview' && 'skipped' || needs.migrate-database.result }}
          migration_applied: ${{ needs.setup.outputs.environment == 'preview' && 'false' || needs.migrate-database.outputs.migration_applied }}
          migration_names: ${{ needs.setup.outputs.environment == 'preview' && '' || needs.migrate-database.outputs.migration_names }}
          preview_migration_applied: ${{ needs.setup.outputs.environment == 'staging' && needs.migrate-database.outputs.preview_migration_applied || 'false' }}
          preview_migration_names: ${{ needs.setup.outputs.environment == 'staging' && needs.migrate-database.outputs.preview_migration_names || '' }}
          vercel_status: ${{ needs.deploy.result }}
          vercel_url: ${{ needs.deploy.outputs.vercel_url }}
          cloudrun_status: ${{ needs.deploy-cloudrun.result }}
          cloudrun_url: ${{ needs.deploy-cloudrun.outputs.cloudrun_url }}
          actor: ${{ github.actor }}
          commit_sha: ${{ github.sha }}
          ref_name: ${{ github.ref_name }}
