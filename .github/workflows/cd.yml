name: CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  # ç’°å¢ƒåˆ¤å®š
  setup:
    name: ğŸ”§ ç’°å¢ƒè¨­å®š
    runs-on: arc-runner-set
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      stage: ${{ steps.env.outputs.stage }}
      is_pr: ${{ steps.env.outputs.is_pr }}
    steps:
      - uses: actions/checkout@v4
      - id: env
        uses: ./.github/actions/determine-env

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆstaging/production ã®ã¿ï¼‰
  migrate-database:
    name: ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    needs: setup
    if: needs.setup.outputs.environment != 'preview'
    runs-on: arc-runner-set
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup
        uses: ./.github/actions/setup
      
      - name: Build packages (database only)
        shell: bash
        run: |
          pnpm run --filter @tumiki/tsup-config build
          pnpm run --filter @tumiki/db build
      
      - name: Migrate database
        uses: ./.github/actions/migrate-database
        with:
          database_url: ${{ needs.setup.outputs.environment == 'production' && secrets.DATABASE_URL_PRODUCTION || secrets.DATABASE_URL_STAGING }}
          environment: ${{ needs.setup.outputs.environment }}

  # Vercelãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-vercel:
    name: ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [setup, migrate-database]
    if: always() && needs.setup.result == 'success' && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on: arc-runner-set
    environment: ${{ needs.setup.outputs.environment }}
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build packages
        uses: ./.github/actions/build-packages

      - name: Deploy to Vercel
        id: deploy
        uses: ./.github/actions/deploy-vercel
        with:
          environment: ${{ needs.setup.outputs.environment }}
          vercel_token: ${{ secrets.VERCEL_TOKEN }}
          database_url: ${{ needs.setup.outputs.environment == 'production' && secrets.DATABASE_URL_PRODUCTION || secrets.DATABASE_URL_STAGING }}
          api_url: ${{ needs.setup.outputs.environment == 'production' && secrets.NEXT_PUBLIC_API_URL_PRODUCTION || secrets.NEXT_PUBLIC_API_URL_STAGING }}

      - name: Comment deployment URL
        uses: ./.github/actions/comment-deployment
        with:
          deployment_url: ${{ steps.deploy.outputs.deployment_url }}
          environment: ${{ needs.setup.outputs.environment }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # PRæ™‚ã®GCEãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰
  validate-gce:
    name: ğŸ” GCEãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼
    needs: setup
    if: needs.setup.outputs.is_pr == 'true'
    runs-on: arc-runner-set
    environment: production  # æœ¬ç•ªç’°å¢ƒã®secretsã‚’ä½¿ç”¨
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup
        uses: ./.github/actions/setup
      
      - name: ğŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PRODUCTION }}
      
      - name: â˜ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: ğŸ” Setup Vercel CLI
        shell: bash
        run: |
          # Vercel CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g vercel
          
          # Vercelèªè¨¼ã¯VERCEL_TOKENç’°å¢ƒå¤‰æ•°ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯è¨­å®šä¸è¦
          echo "Vercel CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"
      
      - name: ğŸ§ª Validate Deployment Script (Dry Run)
        shell: bash
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ğŸ” GCEãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³æ¤œè¨¼ã‚’å®Ÿè¡Œ"
          echo "=============================="
          echo "æ¤œè¨¼å†…å®¹:"
          echo "  1. GCEã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®SSHæ¥ç¶š"
          echo "  2. Vercelç’°å¢ƒå¤‰æ•°ã®å–å¾—å¯èƒ½æ€§"
          echo "  3. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ§‹æ–‡"
          echo "=============================="
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
          pnpm run --filter @tumiki/tsup-config build
          pnpm run --filter @tumiki/db build
          
          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          # GCEã‚¢ã‚¯ã‚»ã‚¹ã¨Vercelç’°å¢ƒå¤‰æ•°å–å¾—ã®æ¤œè¨¼ã‚’å«ã‚€
          DRY_RUN=true \
          INSTANCE_NAME="${{ secrets.GCE_INSTANCE_NAME_PRODUCTION }}" \
          ZONE="${{ secrets.GCE_ZONE }}" \
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}" \
          DEPLOY_STAGE="production" \
          bash scripts/deploy-ci.sh
          
          echo "âœ… ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³æ¤œè¨¼å®Œäº†"

  # GCEãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
  deploy-gce:
    name: ğŸ”§ GCEãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [setup, migrate-database]
    if: needs.setup.outputs.environment == 'production' && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on: arc-runner-set
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Deploy to GCE
        uses: ./.github/actions/deploy-gce
        with:
          gcp_credentials: ${{ secrets.GCP_SA_KEY_PRODUCTION }}
          instance_name: ${{ secrets.GCE_INSTANCE_NAME_PRODUCTION }}
          zone: ${{ secrets.GCE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

  # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
  notify:
    name: ğŸ“¢ çµæœé€šçŸ¥
    needs: [setup, migrate-database, deploy-vercel, deploy-gce]
    if: always() && needs.setup.outputs.is_pr != 'true'
    runs-on: arc-runner-set
    steps:
      - uses: actions/checkout@v4

      - name: Create summary
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ needs.setup.outputs.environment }}';
            const migrationStatus = '${{ needs.migrate-database.result }}';
            const vercelStatus = '${{ needs.deploy-vercel.result }}';
            const gceStatus = '${{ needs.deploy-gce.result }}';
            const isProduction = environment === 'production';
            
            let emoji = 'âœ…';
            if (migrationStatus === 'failure' || vercelStatus === 'failure' || (isProduction && gceStatus === 'failure')) {
              emoji = 'âŒ';
            }
            
            let summary = `## ${emoji} ${environment}ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤\n\n`;
            summary += `| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
            summary += `|---------------|------------|\n`;
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if (migrationStatus && migrationStatus !== 'skipped') {
              summary += `| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | ${migrationStatus === 'success' ? 'âœ…' : 'âŒ'} ${migrationStatus} |\n`;
            }
            
            // Vercel
            summary += `| Vercel | ${vercelStatus === 'success' ? 'âœ…' : vercelStatus === 'failure' ? 'âŒ' : 'âš ï¸'} ${vercelStatus} |\n`;
            
            // GCE (æœ¬ç•ªã®ã¿)
            if (isProduction) {
              summary += `| GCE ProxyServer | ${gceStatus === 'success' ? 'âœ…' : gceStatus === 'skipped' ? 'â­ï¸' : gceStatus === 'failure' ? 'âŒ' : 'âš ï¸'} ${gceStatus || 'skipped'} |\n`;
            }
            
            summary += `\n**Triggered by:** ${{ github.actor }}\n`;
            summary += `**Commit:** ${{ github.sha }}`;
            
            await core.summary.addRaw(summary).write();
