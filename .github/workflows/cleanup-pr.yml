name: Cleanup PR Environment

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: 🧹 Cloud Run クリーンアップ
    runs-on:
      group: self-arc
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PRODUCTION }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run service
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          SERVICE_NAME="tumiki-mcp-proxy-pr-$PR_NUMBER"
          REGION="asia-northeast1"

          echo "🧹 PR #$PR_NUMBER のCloud Runサービスをクリーンアップ中"
          echo "サービス: $SERVICE_NAME"

          # Check if service exists
          if gcloud run services describe "$SERVICE_NAME" \
              --region="$REGION" \
              --project="$GCP_PROJECT_ID" >/dev/null 2>&1; then

            echo "🗑️  Cloud Runサービスを削除中..."

            if gcloud run services delete "$SERVICE_NAME" \
                --region="$REGION" \
                --project="$GCP_PROJECT_ID" \
                --quiet; then
              echo "✅ Cloud Runサービスの削除が完了しました"
            else
              echo "❌ Cloud Runサービスの削除に失敗しました"
              exit 1
            fi
          else
            echo "ℹ️  Cloud Runサービスが見つかりません（デプロイされていない可能性があります）"
            echo "   PRがデプロイ完了前にクローズされた場合、これは正常な状態です"
          fi

      - name: Cleanup summary
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
        run: |
          echo "========================================="
          echo "🧹 PR環境のクリーンアップが完了しました"
          echo "========================================="
          echo "PR: #$PR_NUMBER"
          echo "マージ済み: $PR_MERGED"
          echo "サービス: tumiki-mcp-proxy-pr-$PR_NUMBER"
          echo "ステータス: クリーンアップ完了"
          echo "========================================="
