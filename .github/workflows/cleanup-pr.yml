name: Cleanup PR Environment

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã®PRç•ªå·'
        required: true
        type: number
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå‰Šé™¤ã‚’å®Ÿè¡Œã›ãšç¢ºèªã®ã¿ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  cleanup:
    name: ğŸ§¹ Cloud Run ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    runs-on:
      group: self-arc
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PRODUCTION }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run service
        shell: bash
        env:
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || false }}
        run: |
          SERVICE_NAME="tumiki-mcp-proxy-pr-$PR_NUMBER"
          REGION="asia-northeast1"

          echo "ğŸ§¹ PR #$PR_NUMBER ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­"
          echo "ã‚µãƒ¼ãƒ“ã‚¹: $SERVICE_NAME"

          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: å‰Šé™¤ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“"
          fi

          # Check if service exists
          if gcloud run services describe "$SERVICE_NAME" \
              --region="$REGION" \
              --project="$GCP_PROJECT_ID" >/dev/null 2>&1; then

            echo "ğŸ—‘ï¸  Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ä¸­..."

            if [ "$DRY_RUN" = "true" ]; then
              echo "âœ… [ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³] Cloud Runã‚µãƒ¼ãƒ“ã‚¹ '$SERVICE_NAME' ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼ˆå®Ÿéš›ã«ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰"
            else
              if gcloud run services delete "$SERVICE_NAME" \
                  --region="$REGION" \
                  --project="$GCP_PROJECT_ID" \
                  --quiet; then
                echo "âœ… Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
              else
                echo "âŒ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
                exit 1
              fi
            fi
          else
            echo "â„¹ï¸  Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
            echo "   PRãŒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å‰ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸå ´åˆã€ã“ã‚Œã¯æ­£å¸¸ãªçŠ¶æ…‹ã§ã™"
          fi

      - name: Cleanup summary
        shell: bash
        env:
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
          PR_MERGED: ${{ github.event_name == 'workflow_dispatch' && 'N/A (æ‰‹å‹•å®Ÿè¡Œ)' || github.event.pull_request.merged }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || false }}
        run: |
          echo "========================================="
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ” PRç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰"
          else
            echo "ğŸ§¹ PRç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
          fi
          echo "========================================="
          echo "PR: #$PR_NUMBER"
          echo "ãƒãƒ¼ã‚¸æ¸ˆã¿: $PR_MERGED"
          echo "ã‚µãƒ¼ãƒ“ã‚¹: tumiki-mcp-proxy-pr-$PR_NUMBER"
          echo "ãƒ¢ãƒ¼ãƒ‰: $([ "$DRY_RUN" = "true" ] && echo "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå‰Šé™¤ãªã—ï¼‰" || echo "æœ¬ç•ªå®Ÿè¡Œ")"
          echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
          echo "========================================="
