name: Migrate Database
description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚staging/productionç’°å¢ƒã§ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™

inputs:
  database_url:
    description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURLï¼ˆç’°å¢ƒåˆ¥ï¼‰
    required: true
  environment:
    description: ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒï¼ˆstaging/productionï¼‰
    required: true

runs:
  using: composite
  steps:
    - name: ğŸ—„ï¸ Run database migration
      shell: bash
      env:
        DATABASE_URL: ${{ inputs.database_url }}
      run: |
        echo "ğŸš€ Starting database migration for ${{ inputs.environment }} environment..."
        echo "ğŸ“ Database URL: $(echo $DATABASE_URL | sed 's/:[^@]*@/:***@/')" # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¹ã‚¯

        # packages/db ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
        if [ ! -d "packages/db" ]; then
          echo "âŒ Error: packages/db directory not found"
          exit 1
        fi

        cd packages/db

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        echo "ğŸ”„ Executing database migrations..."
        if pnpm db:deploy; then
          echo "âœ… Database migration completed successfully"
        else
          echo "âŒ Database migration failed"
          echo "ğŸ’¡ Please check:"
          echo "  - Database connection (DATABASE_URL)"
          echo "  - Migration files in prisma/migrations/"
          echo "  - Database server status"
          exit 1
        fi

        echo "ğŸ‰ Migration job completed for ${{ inputs.environment }} environment"
