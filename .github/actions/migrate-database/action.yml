name: Migrate Database
description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚staging/production/previewç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¾ã™

inputs:
  database_url:
    description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šURLï¼ˆç’°å¢ƒåˆ¥ï¼‰
    required: true
  environment:
    description: ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒï¼ˆstaging/production/previewï¼‰
    required: true

outputs:
  migration_applied:
    description: ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚ŒãŸã‹ã©ã†ã‹
    value: ${{ steps.migrate.outputs.migration_applied }}
  migration_names:
    description: é©ç”¨ã•ã‚ŒãŸãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰
    value: ${{ steps.migrate.outputs.migration_names }}

runs:
  using: composite
  steps:
    - name: ðŸ—„ï¸ Run database migration
      id: migrate
      shell: bash
      env:
        DATABASE_URL: ${{ inputs.database_url }}
      run: |
        echo "ðŸš€ Starting database migration for ${{ inputs.environment }} environment..."
        echo "ðŸ“ Database URL: $(echo $DATABASE_URL | sed 's/:[^@]*@/:***@/')" # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒžã‚¹ã‚¯

        # packages/db ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
        if [ ! -d "packages/db" ]; then
          echo "âŒ Error: packages/db directory not found"
          exit 1
        fi

        cd packages/db

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¨å‡ºåŠ›ã®ã‚­ãƒ£ãƒ—ãƒãƒ£
        echo "ðŸ”„ Executing database migrations..."
        set +e  # ä¸€æ™‚çš„ã«ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
        pnpm db:deploy 2>&1 | tee /tmp/migration_output.log
        MIGRATION_STATUS=${PIPESTATUS[0]}
        set -e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã™ã‚‹è¨­å®šã‚’æˆ»ã™
        MIGRATION_OUTPUT=$(cat /tmp/migration_output.log)

        # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œçµæžœã‚’ãƒã‚§ãƒƒã‚¯
        if [ $MIGRATION_STATUS -eq 0 ]; then
          echo "âœ… Database migration completed successfully"
          
          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
          # Prismaã®å‡ºåŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã¦æ¤œçŸ¥
          if echo "$MIGRATION_OUTPUT" | grep -q "The following migration(s) have been applied:" || \
             echo "$MIGRATION_OUTPUT" | grep -q "Applying migration"; then
            
            echo "migration_applied=true" >> $GITHUB_OUTPUT
            
            # é©ç”¨ã•ã‚ŒãŸãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æŠ½å‡º
            # ãƒ‘ã‚¿ãƒ¼ãƒ³1: migrations/ã®å¾Œã®è¡Œã‹ã‚‰æŠ½å‡ºï¼ˆâ””â”€ 20250823231216_add_tags_description_to_mcpserver/ï¼‰
            MIGRATION_NAMES=$(echo "$MIGRATION_OUTPUT" | grep -A 20 "migrations/" | grep "â””â”€" | sed 's/.*â””â”€ //' | sed 's/\///' | grep -v "migration\.sql" | tr '\n' ',' | sed 's/,$//')
            
            if [ -z "$MIGRATION_NAMES" ]; then
              # ãƒ‘ã‚¿ãƒ¼ãƒ³2: Applying migration ã®å¾Œã‹ã‚‰æŠ½å‡º
              MIGRATION_NAMES=$(echo "$MIGRATION_OUTPUT" | grep "Applying migration" | sed "s/.*Applying migration \`//" | sed "s/\`//" | grep -v "migration\.sql" | tr '\n' ',' | sed 's/,$//')
            fi
            
            if [ -z "$MIGRATION_NAMES" ]; then
              # ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ•°å­—ã§å§‹ã¾ã‚‹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’ç›´æŽ¥æ¤œç´¢
              MIGRATION_NAMES=$(echo "$MIGRATION_OUTPUT" | grep -oE "[0-9]{14}_[a-zA-Z0-9_]+" | grep -v "migration\.sql" | head -5 | tr '\n' ',' | sed 's/,$//')
            fi
            
            # migration.sqlã‚’å«ã‚€ã‚¨ãƒ³ãƒˆãƒªã‚’é™¤å¤–
            if [ -n "$MIGRATION_NAMES" ]; then
              MIGRATION_NAMES=$(echo "$MIGRATION_NAMES" | tr ',' '\n' | grep -v "migration\.sql" | tr '\n' ',' | sed 's/,$//')
            fi
            
            echo "migration_names=$MIGRATION_NAMES" >> $GITHUB_OUTPUT
            echo "ðŸ“ Applied migrations: $MIGRATION_NAMES"
          elif echo "$MIGRATION_OUTPUT" | grep -q "No pending migrations to apply"; then
            # æ˜Žç¤ºçš„ã«ã€Œé©ç”¨ã™ã‚‹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„ã€å ´åˆ
            echo "migration_applied=false" >> $GITHUB_OUTPUT
            echo "migration_names=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No pending migrations to apply"
          else
            echo "migration_applied=false" >> $GITHUB_OUTPUT
            echo "migration_names=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new migrations were applied"
          fi
        else
          echo "âŒ Database migration failed"
          echo "ðŸ’¡ Please check:"
          echo "  - Database connection (DATABASE_URL)"
          echo "  - Migration files in prisma/migrations/"
          echo "  - Database server status"
          echo ""
          echo "ðŸ“‹ Migration output:"
          cat /tmp/migration_output.log
          echo ""
          echo "migration_applied=false" >> $GITHUB_OUTPUT
          echo "migration_names=" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "ðŸŽ‰ Migration job completed for ${{ inputs.environment }} environment"
