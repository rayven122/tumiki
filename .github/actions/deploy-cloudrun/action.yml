name: 'Deploy to Cloud Run'
description: 'Deploy MCP Proxy to Google Cloud Run'

inputs:
  environment:
    description: 'Deployment environment (preview|staging|production)'
    required: true
  pr_number:
    description: 'PR number for preview deployments (optional, used to create unique service names)'
    required: false
    default: ''
  gcp_credentials:
    description: 'GCP service account credentials JSON'
    required: true
  gcp_project_id:
    description: 'GCP project ID'
    required: true
  region:
    description: 'Cloud Run region'
    default: 'asia-northeast1'
    required: false
  min_instances:
    description: 'Minimum number of instances'
    default: '0'
    required: false
  max_instances:
    description: 'Maximum number of instances'
    default: '3'
    required: false

outputs:
  service_url:
    description: 'Cloud Run service URL'
    value: ${{ steps.deploy.outputs.service_url }}
  health_url:
    description: 'Health check URL'
    value: ${{ steps.deploy.outputs.health_url }}

runs:
  using: 'composite'
  steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ inputs.gcp_credentials }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      shell: bash
      run: |
        gcloud auth configure-docker asia-northeast1-docker.pkg.dev

    - name: Build Docker image
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
      run: |
        echo "ğŸš€ Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™"
        echo "ç’°å¢ƒ: $ENVIRONMENT"

        # Get short SHA
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "ã‚³ãƒŸãƒƒãƒˆSHA: $SHORT_SHA"

        # Build Docker image
        echo "ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        docker build \
          -t asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA \
          -t asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-latest \
          -f apps/mcp-proxy/Dockerfile \
          .

        echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: Push Docker image
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)

        # Push images to Artifact Registry
        echo "ğŸ“¦ Artifact Registryã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
        docker push asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA
        docker push asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-latest

        echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: Deploy to Cloud Run
      id: deploy
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        PR_NUMBER: ${{ inputs.pr_number }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
        REGION: ${{ inputs.region }}
        MIN_INSTANCES: ${{ inputs.min_instances }}
        MAX_INSTANCES: ${{ inputs.max_instances }}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)

        # Determine service name and secret environment based on environment
        if [ "$ENVIRONMENT" = "preview" ] && [ -n "$PR_NUMBER" ]; then
          SERVICE_NAME="tumiki-mcp-proxy-pr-$PR_NUMBER"
          SECRET_ENV="staging"  # Previewç’°å¢ƒã§ã¯stagingã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨
          echo "ğŸ”µ PR #$PR_NUMBER ã®Previewãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆstagingã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ï¼‰"
        else
          SERVICE_NAME="tumiki-mcp-proxy-$ENVIRONMENT"
          SECRET_ENV="$ENVIRONMENT"
        fi

        echo "ğŸš€ Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        echo "ã‚µãƒ¼ãƒ“ã‚¹: $SERVICE_NAME"
        echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $REGION"
        echo "ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: æœ€å° $MIN_INSTANCES / æœ€å¤§ $MAX_INSTANCES"

        # VPCã‚³ãƒã‚¯ã‚¿ãƒ¼ã®è¨­å®šï¼ˆproductionç’°å¢ƒã®ã¿ä½¿ç”¨ï¼‰
        VPC_ARGS=""
        if [ "$ENVIRONMENT" = "production" ]; then
          VPC_ARGS="--vpc-connector=tumiki-vpc-connector --vpc-egress=private-ranges-only"
          echo "VPC: tumiki-vpc-connector (private-ranges-only)"
        else
          VPC_ARGS="--clear-vpc-connector"
          echo "VPC: $ENVIRONMENT ç’°å¢ƒã§ã¯VPCã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“"
        fi

        # Deploy to Cloud Run
        gcloud run deploy "$SERVICE_NAME" \
          --image=asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA \
          --region="$REGION" \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=512Mi \
          --cpu=1 \
          --timeout=60s \
          --concurrency=80 \
          --min-instances="$MIN_INSTANCES" \
          --max-instances="$MAX_INSTANCES" \
          --set-env-vars=NODE_ENV=production,LOG_LEVEL=info,LOG_DESTINATION=stdout \
          --set-secrets=DATABASE_URL=tumiki-database-url-$SECRET_ENV:latest,UPSTASH_REDIS_REST_URL=tumiki-redis-url:latest,UPSTASH_REDIS_REST_TOKEN=tumiki-redis-token:latest,PRISMA_FIELD_ENCRYPTION_KEY=tumiki-cache-encryption-key-$SECRET_ENV:latest \
          --service-account=tumiki-mcp-proxy@$GCP_PROJECT_ID.iam.gserviceaccount.com \
          --no-cpu-throttling \
          $VPC_ARGS

        # Get service URL
        SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
          --region="$REGION" \
          --project="$GCP_PROJECT_ID" \
          --format='value(status.url)')

        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"

        # Output for GitHub Actions
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "health_url=$SERVICE_URL/health" >> $GITHUB_OUTPUT

    - name: Verify deployment
      shell: bash
      env:
        SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¤œè¨¼ä¸­..."

        # Wait for service to be ready (increased for cold start)
        echo "â³ ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰..."
        sleep 15

        # Health check with retries
        for i in {1..5}; do
          if curl -f -s "$SERVICE_URL/health" > /dev/null; then
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
          fi
          echo "â³ ã‚µãƒ¼ãƒ“ã‚¹ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­ï¼ˆè©¦è¡Œ $i/5ï¼‰..."
          sleep 5
        done

        echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        exit 1

    - name: Display deployment info
      shell: bash
      env:
        SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
        HEALTH_URL: ${{ steps.deploy.outputs.health_url }}
        ENVIRONMENT: ${{ inputs.environment }}
        PR_NUMBER: ${{ inputs.pr_number }}
      run: |
        echo "========================================="
        echo "ğŸ‰ Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸ"
        echo "========================================="
        echo "ç’°å¢ƒ: $ENVIRONMENT"

        if [ "$ENVIRONMENT" = "preview" ] && [ -n "$PR_NUMBER" ]; then
          echo "PR: #$PR_NUMBER"
          echo "ã‚µãƒ¼ãƒ“ã‚¹: tumiki-mcp-proxy-pr-$PR_NUMBER"
        fi

        echo "ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: $HEALTH_URL"
        echo "========================================="
