name: 'Deploy to Cloud Run'
description: 'Deploy MCP Proxy to Google Cloud Run'

inputs:
  environment:
    description: 'Deployment environment (preview|staging|production)'
    required: true
  pr_number:
    description: 'PR number for preview deployments (optional, used to create unique service names)'
    required: false
    default: ''
  gcp_credentials:
    description: 'GCP service account credentials JSON'
    required: true
  gcp_project_id:
    description: 'GCP project ID'
    required: true
  vercel_token:
    description: 'Vercel API token for pulling environment variables'
    required: true
  vercel_org_id:
    description: 'Vercel organization ID'
    required: true
  vercel_project_id:
    description: 'Vercel project ID'
    required: true
  region:
    description: 'Cloud Run region'
    default: 'asia-northeast1'
    required: false
  min_instances:
    description: 'Minimum number of instances'
    default: '0'
    required: false
  max_instances:
    description: 'Maximum number of instances'
    default: '3'
    required: false

outputs:
  service_url:
    description: 'Cloud Run service URL'
    value: ${{ steps.deploy.outputs.service_url }}
  health_url:
    description: 'Health check URL'
    value: ${{ steps.deploy.outputs.health_url }}

runs:
  using: 'composite'
  steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ inputs.gcp_credentials }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      shell: bash
      run: |
        gcloud auth configure-docker asia-northeast1-docker.pkg.dev

    - name: Build Docker image
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
      run: |
        echo "ğŸš€ Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™"
        echo "ç’°å¢ƒ: $ENVIRONMENT"

        # Get short SHA
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "ã‚³ãƒŸãƒƒãƒˆSHA: $SHORT_SHA"

        # Build Docker image
        echo "ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        docker build \
          -t asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA \
          -t asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-latest \
          -f apps/mcp-proxy/Dockerfile \
          .

        echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: Push Docker image
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)

        # Push images to Artifact Registry
        echo "ğŸ“¦ Artifact Registryã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
        docker push asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA
        docker push asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-latest

        echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: Deploy to Cloud Run
      id: deploy
      shell: bash
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        PR_NUMBER: ${{ inputs.pr_number }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
        VERCEL_TOKEN: ${{ inputs.vercel_token }}
        VERCEL_ORG_ID: ${{ inputs.vercel_org_id }}
        VERCEL_PROJECT_ID: ${{ inputs.vercel_project_id }}
        REGION: ${{ inputs.region }}
        MIN_INSTANCES: ${{ inputs.min_instances }}
        MAX_INSTANCES: ${{ inputs.max_instances }}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)

        # Determine service name based on environment
        if [ "$ENVIRONMENT" = "preview" ] && [ -n "$PR_NUMBER" ]; then
          SERVICE_NAME="tumiki-mcp-proxy-pr-$PR_NUMBER"
          echo "ğŸ”µ PR #$PR_NUMBER ã®Previewãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆpreviewã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼‰"
        else
          SERVICE_NAME="tumiki-mcp-proxy-$ENVIRONMENT"
        fi

        echo "ğŸš€ Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        echo "ã‚µãƒ¼ãƒ“ã‚¹: $SERVICE_NAME"
        echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $REGION"
        echo "ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: æœ€å° $MIN_INSTANCES / æœ€å¤§ $MAX_INSTANCES"

        # VPCã‚³ãƒã‚¯ã‚¿ãƒ¼ã®è¨­å®šï¼ˆç¾åœ¨ã¯ç„¡åŠ¹åŒ–ï¼‰
        # TODO: å°†æ¥çš„ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã™ã‚‹å ´åˆã¯æœ‰åŠ¹åŒ–
        VPC_ARGS="--clear-vpc-connector"
        echo "VPC: å…¨ç’°å¢ƒã§VPCã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯IPæ¥ç¶šï¼‰"

        # .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Cloud Run ã® env-vars-file å½¢å¼ï¼ˆYAMLï¼‰ã«å¤‰æ›
        # Cloud Run ã¯å€¤ã«ç‰¹æ®Šæ–‡å­—ï¼ˆ=ãªã©ï¼‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã€YAMLå½¢å¼ã‚’è¦æ±‚ã™ã‚‹
        # ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨ç©ºè¡Œã‚’é™¤å¤–ã—ã€YAMLå½¢å¼ã«å¤‰æ›
        if [ -f .env ]; then
          {
            # ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨ç©ºè¡Œã‚’é™¤å¤–ã—ã¦YAMLå½¢å¼ã«å¤‰æ›
            grep -v '^\s*#' .env | grep -v '^\s*$' | while IFS= read -r line; do
              # KEY="VALUE" ã®å½¢å¼ã‹ã‚‰ KEY ã¨ VALUE ã‚’æŠ½å‡º
              key="${line%%=*}"
              value="${line#*=}"
              # å€¤ã®å‰å¾Œã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å‰Šé™¤
              value="${value#\"}"
              value="${value%\"}"
              # YAMLå½¢å¼ã§å‡ºåŠ›ï¼ˆå€¤ã¯å¸¸ã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€ï¼‰
              echo "${key}: \"${value}\""
            done
          } > .env.cloudrun

          # ç’°å¢ƒå¤‰æ•°ã®æ•°ã‚’ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚å†…å®¹ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          ENV_COUNT=$(wc -l < .env.cloudrun)
          echo "ğŸ“‹ ç’°å¢ƒå¤‰æ•°ã‚’ ${ENV_COUNT} å€‹å¤‰æ›ã—ã¾ã—ãŸ"
        else
          echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi

        # Deploy to Cloud Run
        gcloud run deploy "$SERVICE_NAME" \
          --image=asia-northeast1-docker.pkg.dev/$GCP_PROJECT_ID/tumiki-mcp/mcp-proxy:$ENVIRONMENT-$SHORT_SHA \
          --region="$REGION" \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=512Mi \
          --cpu=1 \
          --timeout=60s \
          --concurrency=80 \
          --min-instances="$MIN_INSTANCES" \
          --max-instances="$MAX_INSTANCES" \
          --env-vars-file=.env.cloudrun \
          --service-account=tumiki-mcp-proxy@$GCP_PROJECT_ID.iam.gserviceaccount.com \
          --no-cpu-throttling \
          $VPC_ARGS

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -f .env.cloud-run.local .env.cloudrun

        # Get service URL
        CLOUDRUN_URL=$(gcloud run services describe "$SERVICE_NAME" \
          --region="$REGION" \
          --project="$GCP_PROJECT_ID" \
          --format='value(status.url)')

        # Set URL based on environment
        if [ "$ENVIRONMENT" = "production" ]; then
          SERVICE_URL="https://mcp.tumiki.cloud"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸŒ æœ¬ç•ªURL: $SERVICE_URL"
          echo "ğŸ“¦ Cloud Run URL: $CLOUDRUN_URL"
        elif [ "$ENVIRONMENT" = "staging" ]; then
          SERVICE_URL="https://stg-mcp.tumiki.cloud"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸŒ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°URL: $SERVICE_URL"
          echo "ğŸ“¦ Cloud Run URL: $CLOUDRUN_URL"
        else
          # Previewç’°å¢ƒã§ã¯Cloud Run URLã‚’ãã®ã¾ã¾ä½¿ç”¨
          SERVICE_URL="$CLOUDRUN_URL"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        fi

        # Output for GitHub Actions
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "health_url=$SERVICE_URL/health" >> $GITHUB_OUTPUT

    - name: Verify deployment
      shell: bash
      env:
        SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¤œè¨¼ä¸­..."

        # Wait for service to be ready (increased for cold start)
        echo "â³ ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰..."
        sleep 15

        # Health check with retries
        for i in {1..5}; do
          if curl -f -s "$SERVICE_URL/health" > /dev/null; then
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
          fi
          echo "â³ ã‚µãƒ¼ãƒ“ã‚¹ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­ï¼ˆè©¦è¡Œ $i/5ï¼‰..."
          sleep 5
        done

        echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        exit 1

    - name: Display deployment info
      shell: bash
      env:
        SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
        HEALTH_URL: ${{ steps.deploy.outputs.health_url }}
        ENVIRONMENT: ${{ inputs.environment }}
        PR_NUMBER: ${{ inputs.pr_number }}
      run: |
        echo "========================================="
        echo "ğŸ‰ Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸ"
        echo "========================================="
        echo "ç’°å¢ƒ: $ENVIRONMENT"

        if [ "$ENVIRONMENT" = "preview" ] && [ -n "$PR_NUMBER" ]; then
          echo "PR: #$PR_NUMBER"
          echo "ã‚µãƒ¼ãƒ“ã‚¹: tumiki-mcp-proxy-pr-$PR_NUMBER"
        fi

        echo "ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: $HEALTH_URL"
        echo "========================================="
