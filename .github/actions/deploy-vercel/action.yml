name: 'Deploy to Vercel'
description: 'Deploy to Vercel (staging or production)'

inputs:
  stage:
    description: 'staging or production'
    required: true
  vercel_token:
    description: 'Vercel token'
    required: true

outputs:
  url:
    description: 'Deployment URL'
    value: ${{ steps.deploy.outputs.url }}

runs:
  using: 'composite'
  steps:
    - name: Deploy
      id: deploy
      shell: bash
      env:
        VERCEL_TOKEN: ${{ inputs.vercel_token }}
      run: |
        # Install Vercel CLI if needed
        echo "ðŸ” Vercel CLIã‚’ç¢ºèªä¸­..."
        if ! command -v vercel >/dev/null; then
          echo "ðŸ“¦ Vercel CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm install -g vercel
        else
          echo "âœ… Vercel CLIã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
        fi

        # Deploy
        echo "ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸: ${{ inputs.stage }}ï¼‰..."
        if [ "${{ inputs.stage }}" = "production" ]; then
          echo "ðŸ“ æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
          OUTPUT=$(vercel deploy --prod --yes --token="$VERCEL_TOKEN" 2>&1) || DEPLOY_EXIT_CODE=$?
        elif [ "${{ inputs.stage }}" = "staging" ]; then
          echo "ðŸ“ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
          OUTPUT=$(vercel deploy --target staging --yes --token="$VERCEL_TOKEN" 2>&1) || DEPLOY_EXIT_CODE=$?
        else
          echo "ðŸ“ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
          OUTPUT=$(vercel deploy --yes --token="$VERCEL_TOKEN" 2>&1) || DEPLOY_EXIT_CODE=$?
        fi

        # Show deployment output
        echo "ðŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤å‡ºåŠ›:"
        echo "$OUTPUT"

        # Check if deployment failed
        if [ -n "$DEPLOY_EXIT_CODE" ] && [ "$DEPLOY_EXIT_CODE" -ne 0 ]; then
          echo "âŒ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $DEPLOY_EXIT_CODEï¼‰"
          exit 1
        fi

        # Extract URL (try multiple patterns)
        VERCEL_URL=$(echo "$OUTPUT" | grep -oE 'https://[a-zA-Z0-9.-]+\.vercel\.app' | head -1)

        if [ -z "$VERCEL_URL" ]; then
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤URLãŒå‡ºåŠ›ã‹ã‚‰è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          echo "å®Œå…¨ãªå‡ºåŠ›:"
          echo "$OUTPUT"
          exit 1
        fi

        # Set URL based on environment
        if [ "${{ inputs.stage }}" = "production" ]; then
          URL="https://www.tumiki.cloud"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ðŸŒ æœ¬ç•ªURL: $URL"
          echo "ðŸ“¦ Vercel URL: $VERCEL_URL"
        elif [ "${{ inputs.stage }}" = "staging" ]; then
          URL="https://stg.tumiki.cloud"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ðŸŒ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°URL: $URL"
          echo "ðŸ“¦ Vercel URL: $VERCEL_URL"
        else
          # Previewç’°å¢ƒã§ã¯Vercel URLã‚’ãã®ã¾ã¾ä½¿ç”¨
          URL="$VERCEL_URL"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $URL"
        fi

        echo "url=$URL" >> $GITHUB_OUTPUT
