name: 'Deploy to Vercel'
description: 'Deploy to Vercel (staging or production)'

inputs:
  stage:
    description: 'staging or production'
    required: true
  vercel_token:
    description: 'Vercel token'
    required: true

outputs:
  url:
    description: 'Deployment URL'
    value: ${{ steps.deploy.outputs.url }}

runs:
  using: 'composite'
  steps:
    - name: Deploy
      id: deploy
      shell: bash
      env:
        VERCEL_TOKEN: ${{ inputs.vercel_token }}
      run: |
        # Install Vercel CLI if needed
        echo "ðŸ” Checking Vercel CLI..."
        if ! command -v vercel >/dev/null; then
          echo "ðŸ“¦ Installing Vercel CLI..."
          npm install -g vercel
        else
          echo "âœ… Vercel CLI already installed"
        fi

        # Deploy
        echo "ðŸš€ Starting deployment (stage: ${{ inputs.stage }})..."
        if [ "${{ inputs.stage }}" = "production" ]; then
          echo "ðŸ“ Production deployment"
          OUTPUT=$(vercel deploy --prod --yes --token="$VERCEL_TOKEN" 2>&1) || DEPLOY_EXIT_CODE=$?
        else
          echo "ðŸ“ Preview deployment"
          OUTPUT=$(vercel deploy --yes --token="$VERCEL_TOKEN" 2>&1) || DEPLOY_EXIT_CODE=$?
        fi

        # Show deployment output
        echo "ðŸ“‹ Deployment output:"
        echo "$OUTPUT"

        # Check if deployment failed
        if [ -n "$DEPLOY_EXIT_CODE" ] && [ "$DEPLOY_EXIT_CODE" -ne 0 ]; then
          echo "âŒ Vercel deployment failed with exit code: $DEPLOY_EXIT_CODE"
          exit 1
        fi

        # Extract URL (try multiple patterns)
        URL=$(echo "$OUTPUT" | grep -oE 'https://[a-zA-Z0-9.-]+\.vercel\.app' | head -1)

        if [ -z "$URL" ]; then
          echo "âŒ Deployment URL not found in output"
          echo "Full output:"
          echo "$OUTPUT"
          exit 1
        fi

        echo "âœ… Deployed to: $URL"
        echo "url=$URL" >> $GITHUB_OUTPUT
