name: Notify Slack Summary
description: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’çµ±åˆã—ã¦Slackã«é€šçŸ¥ã—ã¾ã™

inputs:
  slack_webhook_url:
    description: Slack Webhook URL
    required: true
  environment:
    description: ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒï¼ˆstaging/production/previewï¼‰
    required: true
  migration_status:
    description: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®çµæœ
    required: false
  migration_applied:
    description: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚ŒãŸã‹ã©ã†ã‹
    required: false
    default: "false"
  migration_names:
    description: é©ç”¨ã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
    required: false
  preview_migration_applied:
    description: Preview DBã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚ŒãŸã‹ã©ã†ã‹ï¼ˆstagingç’°å¢ƒæ™‚ã®ã¿ï¼‰
    required: false
    default: "false"
  preview_migration_names:
    description: Preview DBã«é©ç”¨ã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
    required: false
  vercel_status:
    description: Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã®çµæœ
    required: true
  vercel_url:
    description: Vercelã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURL
    required: false
  gce_status:
    description: GCEãƒ‡ãƒ—ãƒ­ã‚¤ã®çµæœï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
    required: false
  actor:
    description: å®Ÿè¡Œè€…
    required: true
  commit_sha:
    description: ã‚³ãƒŸãƒƒãƒˆSHA
    required: true
  ref_name:
    description: ãƒ–ãƒ©ãƒ³ãƒ/ã‚¿ã‚°å
    required: true

runs:
  using: composite
  steps:
    - name: ğŸ“‹ Prepare summary notification
      id: prepare
      shell: bash
      run: |
        echo "ğŸ”” Preparing Slack summary notification..."

        # ç’°å¢ƒåã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
        case "${{ inputs.environment }}" in
          "production")
            ENV_NAME="æœ¬ç•ªç’°å¢ƒ"
            ENV_EMOJI="ğŸ”´"
            ;;
          "staging")
            ENV_NAME="ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ"
            ENV_EMOJI="ğŸŸ¡"
            ;;
          "preview")
            ENV_NAME="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ"
            ENV_EMOJI="ğŸ”µ"
            ;;
          *)
            ENV_NAME="${{ inputs.environment }}ç’°å¢ƒ"
            ENV_EMOJI="âšª"
            ;;
        esac

        # å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
        OVERALL_SUCCESS=true
        if [ "${{ inputs.migration_status }}" == "failure" ] || \
           [ "${{ inputs.vercel_status }}" == "failure" ] || \
           ([ "${{ inputs.environment }}" == "production" ] && [ "${{ inputs.gce_status }}" == "failure" ]); then
          OVERALL_SUCCESS=false
        fi

        if [ "$OVERALL_SUCCESS" == "true" ]; then
          HEADER_TEXT="${ENV_EMOJI} ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          STATUS_EMOJI="âœ…"
        else
          HEADER_TEXT="${ENV_EMOJI} ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          STATUS_EMOJI="âŒ"
        fi

        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        MIGRATION_SECTION=""
        if [ "${{ inputs.migration_status }}" != "" ] && [ "${{ inputs.migration_status }}" != "skipped" ]; then
          if [ "${{ inputs.migration_applied }}" == "true" ] && [ -n "${{ inputs.migration_names }}" ]; then
            # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æ•´å½¢
            MIGRATION_LIST=""
            IFS=',' read -ra MIGRATIONS <<< "${{ inputs.migration_names }}"
            for migration in "${MIGRATIONS[@]}"; do
              if [ -n "$migration" ]; then
                # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨åå‰ã‚’åˆ†é›¢
                if [[ "$migration" =~ ^([0-9]{14})_(.*)$ ]]; then
                  NAME="${BASH_REMATCH[2]}"
                  MIGRATION_LIST="${MIGRATION_LIST}â€¢ \`${NAME}\`\\n"
                else
                  MIGRATION_LIST="${MIGRATION_LIST}â€¢ \`${migration}\`\\n"
                fi
              fi
            done
            MIGRATION_TEXT="*ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:* âœ… é©ç”¨æ¸ˆã¿\\n${MIGRATION_LIST}"
          elif [ "${{ inputs.migration_status }}" == "success" ]; then
            MIGRATION_TEXT="*ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:* âœ… å¤‰æ›´ãªã—"
          else
            MIGRATION_TEXT="*ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:* âŒ å¤±æ•—"
          fi
          
          MIGRATION_SECTION=',
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "'"${MIGRATION_TEXT}"'"
              }
            }'
        fi

        # Preview DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆstagingç’°å¢ƒã®ã¿ï¼‰
        PREVIEW_MIGRATION_SECTION=""
        if [ "${{ inputs.environment }}" == "staging" ] && [ "${{ inputs.preview_migration_applied }}" == "true" ] && [ -n "${{ inputs.preview_migration_names }}" ]; then
          # Preview DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æ•´å½¢
          PREVIEW_MIGRATION_LIST=""
          IFS=',' read -ra PREVIEW_MIGRATIONS <<< "${{ inputs.preview_migration_names }}"
          for migration in "${PREVIEW_MIGRATIONS[@]}"; do
            if [ -n "$migration" ]; then
              # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨åå‰ã‚’åˆ†é›¢
              if [[ "$migration" =~ ^([0-9]{14})_(.*)$ ]]; then
                NAME="${BASH_REMATCH[2]}"
                PREVIEW_MIGRATION_LIST="${PREVIEW_MIGRATION_LIST}â€¢ \`${NAME}\`\\n"
              else
                PREVIEW_MIGRATION_LIST="${PREVIEW_MIGRATION_LIST}â€¢ \`${migration}\`\\n"
              fi
            fi
          done
          PREVIEW_MIGRATION_TEXT="*Preview DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:* âœ… é©ç”¨æ¸ˆã¿\\n${PREVIEW_MIGRATION_LIST}"
          
          PREVIEW_MIGRATION_SECTION=',
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "'"${PREVIEW_MIGRATION_TEXT}"'"
              }
            }'
        elif [ "${{ inputs.environment }}" == "staging" ] && [ "${{ inputs.preview_migration_applied }}" == "false" ]; then
          PREVIEW_MIGRATION_SECTION=',
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Preview DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:* âœ… å¤‰æ›´ãªã—"
              }
            }'
        fi

        # Vercelãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
        VERCEL_STATUS_TEXT=""
        if [ "${{ inputs.vercel_status }}" == "success" ]; then
          VERCEL_STATUS_TEXT="âœ… æˆåŠŸ"
          if [ -n "${{ inputs.vercel_url }}" ]; then
            VERCEL_STATUS_TEXT="âœ… æˆåŠŸ | <${{ inputs.vercel_url }}|ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º>"
          fi
        else
          VERCEL_STATUS_TEXT="âŒ å¤±æ•—"
        fi

        # GCEãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
        GCE_SECTION=""
        if [ "${{ inputs.environment }}" == "production" ] && [ -n "${{ inputs.gce_status }}" ]; then
          if [ "${{ inputs.gce_status }}" == "success" ]; then
            GCE_STATUS_TEXT="âœ… æˆåŠŸ"
          elif [ "${{ inputs.gce_status }}" == "skipped" ]; then
            GCE_STATUS_TEXT="â­ï¸ ã‚¹ã‚­ãƒƒãƒ—"
          else
            GCE_STATUS_TEXT="âŒ å¤±æ•—"
          fi
          
          GCE_SECTION=',
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*GCE ProxyServer:*\\n'"${GCE_STATUS_TEXT}"'"
                }
              ]
            }'
        fi

        # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
        COMMIT_SHA_SHORT=$(echo "${{ inputs.commit_sha }}" | cut -c1-7)
        CONTEXT_TEXT="å®Ÿè¡Œè€…: ${{ inputs.actor }} | ãƒ–ãƒ©ãƒ³ãƒ: ${{ inputs.ref_name }} | ã‚³ãƒŸãƒƒãƒˆ: \`${COMMIT_SHA_SHORT}\`"

        # Block Kitå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        cat <<EOF > /tmp/slack_blocks.json
        {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "${HEADER_TEXT}",
                "emoji": true
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*ç’°å¢ƒ:*\\n${ENV_NAME}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Vercel:*\\n${VERCEL_STATUS_TEXT}"
                }
              ]
            }${GCE_SECTION}${MIGRATION_SECTION}${PREVIEW_MIGRATION_SECTION},
            {
              "type": "divider"
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "${CONTEXT_TEXT}"
                },
                {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°>"
                }
              ]
            }
          ]
        }
        EOF

        # JSONã‚’GitHub Outputã«ä¿å­˜
        BLOCKS_JSON=$(cat /tmp/slack_blocks.json | tr -d '\n')
        echo "blocks_json<<EOF" >> $GITHUB_OUTPUT
        echo "${BLOCKS_JSON}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ“¢ Send summary to Slack
      uses: ./.github/actions/notify-slack
      with:
        slack_webhook_url: ${{ inputs.slack_webhook_url }}
        blocks: ${{ steps.prepare.outputs.blocks_json }}
