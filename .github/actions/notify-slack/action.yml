name: Notify Slack
description: æ±ç”¨çš„ãªSlacké€šçŸ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚Block Kitå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™

inputs:
  slack_webhook_url:
    description: Slack Webhook URL
    required: true
  blocks:
    description: Slack Block Kitå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆJSONæ–‡å­—åˆ—ï¼‰
    required: false
  text:
    description: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆblocksãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ä½¿ç”¨ï¼‰
    required: false
  fail_on_error:
    description: Slacké€šçŸ¥å¤±æ•—æ™‚ã«ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹ã‹ã©ã†ã‹
    required: false
    default: "false"

outputs:
  status:
    description: é€šçŸ¥é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆsuccess/failedï¼‰
    value: ${{ steps.send.outputs.status }}
  http_code:
    description: HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰
    value: ${{ steps.send.outputs.http_code }}

runs:
  using: composite
  steps:
    - name: ğŸ“¢ Send Slack notification
      id: send
      shell: bash
      run: |
        echo "ğŸ”” Sending Slack notification..."

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹ç¯‰
        BLOCKS_INPUT='${{ inputs.blocks }}'
        TEXT_INPUT='${{ inputs.text }}'
        
        if [ -n "$BLOCKS_INPUT" ]; then
          # Block Kitå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          SLACK_MESSAGE="$BLOCKS_INPUT"
        elif [ -n "$TEXT_INPUT" ]; then
          # ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          SLACK_MESSAGE=$(cat <<EOF
        {
          "text": "${{ inputs.text }}"
        }
        EOF
        )
        else
          echo "âŒ Error: Either 'blocks' or 'text' must be provided"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "http_code=0" >> $GITHUB_OUTPUT
          if [ "${{ inputs.fail_on_error }}" == "true" ]; then
            exit 1
          fi
          exit 0
        fi

        # Slack ã«é€šçŸ¥ã‚’é€ä¿¡
        HTTP_RESPONSE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
          -X POST \
          -H 'Content-Type: application/json' \
          -d "${SLACK_MESSAGE}" \
          "${{ inputs.slack_webhook_url }}")

        echo "http_code=$HTTP_RESPONSE" >> $GITHUB_OUTPUT

        if [ "$HTTP_RESPONSE" -eq 200 ]; then
          echo "âœ… Slack notification sent successfully"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Warning: Failed to send Slack notification (HTTP $HTTP_RESPONSE)"
          echo "Response: $(cat /tmp/slack_response.txt)"
          echo "status=failed" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.fail_on_error }}" == "true" ]; then
            exit 1
          fi
        fi
