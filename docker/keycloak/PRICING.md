# Keycloak GCE 料金詳細

## 📊 月額料金算出（2024-2025年時点）

### Compute Engine（e2-small）

#### 構成
- **リージョン**: asia-northeast1（東京、Tier 1）
- **マシンタイプ**: e2-small
- **vCPU**: 2 vCPU
- **メモリ**: 2 GiB
- **ブートディスク**: 10GB 標準永続ディスク

#### 料金計算

**1. VM インスタンス料金（e2-small）**

- **時間単価**: $0.03258/時間（東京リージョン）
- **月間稼働時間**: 730時間（平均）

計算：
```
730時間 × $0.03258 = $23.78/月
```

**2. 永続ディスク料金**

- **標準永続ディスク単価**: $0.040/GB/月
- **ディスクサイズ**: 10GB

計算：
```
10GB × $0.040 = $0.40/月
```

**3. 外部IPアドレス料金**

- **静的外部IP単価**: $4.00/月（使用中）

計算：
```
$4.00/月
```

**注**: Cloud Load Balancer を使用する場合、外部IPは不要（$0.00/月）

**Compute Engine 合計**: $23.78 + $0.40 + $4.00 = **$28.18/月**

---

### Cloud SQL for PostgreSQL（db-f1-micro）

#### 構成
- **リージョン**: asia-northeast1（東京）
- **インスタンスタイプ**: db-f1-micro（shared-core、0.6GB メモリ）
- **ストレージ**: 10GB SSD
- **バックアップ**: 有効（7日間保持）
- **高可用性**: 無効

#### 料金計算

**1. インスタンス料金**

- **db-f1-micro 時間単価**: $0.015/時間（東京リージョン）
- **月間稼働時間**: 730時間

計算：
```
730時間 × $0.015 = $10.95/月
```

**2. ストレージ料金**

- **SSD 単価**: $0.17/GB/月
- **ストレージ容量**: 10GB

計算：
```
10GB × $0.17 = $1.70/月
```

**3. バックアップストレージ料金**

- **バックアップ単価**: $0.08/GB/月
- **バックアップ容量**: 10GB（想定）

計算：
```
10GB × $0.08 = $0.80/月
```

**Cloud SQL 合計**: $10.95 + $1.70 + $0.80 = **$13.45/月**

---

## 💵 総額

### 月額料金（外部IP使用）
```
Compute Engine (e2-small):  $28.18
Cloud SQL (db-f1-micro):    $13.45
─────────────────────────────────
合計:                       $41.63/月
```

### 日本円換算（1ドル=150円）
```
$41.63 × 150 = 約 6,245円/月
```

---

### 月額料金（Cloud Load Balancer使用、外部IP不要）
```
Compute Engine (e2-small):  $24.18
Cloud SQL (db-f1-micro):    $13.45
─────────────────────────────────
合計:                       $37.63/月
```

### 日本円換算（1ドル=150円）
```
$37.63 × 150 = 約 5,645円/月
```

---

## 📉 コスト比較

### Cloud Run vs GCE

| 構成 | 月額料金 | 削減額 | 削減率 |
|------|----------|--------|--------|
| **Cloud Run (min=1)** | $85.15 | - | - |
| **GCE e2-small (外部IP)** | $41.63 | **-$43.52** | **51%削減** |
| **GCE e2-small (LB)** | $37.63 | **-$47.52** | **56%削減** |

**GCEの方が約半額**で運用可能です。

---

## 📈 使用量増加時の料金シミュレーション

### シナリオ: 月間100万リクエスト（10倍）

**GCE e2-small**:
```
Compute Engine: $24.18（変更なし、定額）
Cloud SQL:      $13.45（変更なし）
─────────────────────────────────
合計: $37.63/月（変更なし）
```

**Cloud Run（比較）**:
```
アイドル: $71.28（変更なし）
アクティブ: $0.53 × 10 = $5.30
リクエスト: $0.04 × 10 = $0.40
─────────────────────────────────
Cloud Run: $77.00/月
総額: $90.30/月
```

**GCEのメリット**: トラフィックが増えても料金が変わらない（定額）

---

## 💡 さらなるコスト最適化オプション

### オプション 1: プリエンプティブル VM を使用

**効果**: VM 料金を約70%削減

**料金変更**:
```
e2-small プリエンプティブル: $23.78 → $7.13/月
─────────────────────────────────
総額: $37.63 → $21.00/月（約3,150円/月）
```

**デメリット**:
- VMが24時間以内に強制停止される可能性あり
- 認証サービスには非推奨（高可用性が必要なため）

**推奨**: ❌ 非推奨（本番環境には不向き）

---

### オプション 2: HDD ストレージを使用

**効果**: Cloud SQL ストレージ料金を削減

**料金変更**:
```
SSD: $1.70 → HDD: $0.90
─────────────────────────────────
Cloud SQL 合計: $13.45 → $12.65/月
総額: $37.63 → $36.83/月（約5,525円/月）
```

**削減額**: 約$0.80/月（約120円/月）

**デメリット**:
- パフォーマンス低下（IOPS が SSD の 1/10 程度）

**推奨**: △ 軽量使用なら検討可

---

### オプション 3: バックアップを手動管理

**効果**: バックアップストレージ料金を削減

**料金変更**:
```
バックアップ: $0.80 → $0.00
─────────────────────────────────
Cloud SQL 合計: $13.45 → $12.65/月
総額: $37.63 → $36.83/月（約5,525円/月）
```

**削減額**: 約$0.80/月（約120円/月）

**デメリット**:
- データ損失リスク増加
- 手動バックアップの運用負荷

**推奨**: ❌ 非推奨（リスクが高い）

---

## 🎯 推奨構成

**GCE e2-small + Cloud Load Balancer** を推奨します。

**理由**:
1. Cloud Run より **約56%削減**（月額約5,645円）
2. 常時稼働でコールドスタートなし
3. JVMアプリケーションに十分なリソース（2GB メモリ）
4. トラフィック増加時も定額

---

## 🔍 無料枠の適用

Google Cloud には無料枠がありますが、asia-northeast1（東京）リージョンは対象外のため、適用されません。

**無料枠対象リージョン**:
- us-west1
- us-central1
- us-east1

東京リージョンで運用する場合、無料枠は使用できません。

---

## 💡 まとめ

### 推奨構成の月額料金

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Compute Engine (e2-small)       $24.18
  Cloud SQL (db-f1-micro, 10GB)   $13.45
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  合計                            $37.63/月
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  日本円換算（1ドル=150円）      約5,645円/月
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Cloud Run と比較**:
- Cloud Run: $85.15/月（約12,773円/月）
- **GCE e2-small: $37.63/月（約5,645円/月）**
- **削減額: $47.52/月（約7,128円/月、56%削減）**

**特徴**:
- ✅ コールドスタートなし（JVMアプリに最適）
- ✅ 定額料金（トラフィック増加時も安心）
- ✅ 十分なリソース（2GB メモリ）
- ✅ Cloud Run の半額以下

**参考リンク**:
- [Compute Engine 料金](https://cloud.google.com/compute/pricing)
- [Cloud SQL 料金](https://cloud.google.com/sql/pricing)
