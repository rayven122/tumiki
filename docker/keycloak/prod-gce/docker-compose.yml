version: '3.8'

services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    restart: unless-stopped

    environment:
      # 管理者認証情報
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USERNAME}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      # データベース設定（Cloud SQL）
      KC_DB: postgres
      KC_DB_URL: ${KC_DB_URL}

      # ホスト設定
      KC_HOSTNAME: ${KEYCLOAK_DOMAIN}
      KC_HOSTNAME_STRICT: false
      KC_PROXY: edge

      # ヘルスチェックとメトリクス
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true

      # JVMメモリ設定（e2-small: 2GB用に最適化）
      JAVA_OPTS_APPEND: "-Xms512m -Xmx1536m"

      # パフォーマンス設定
      KC_HTTP_POOL_MAX_THREADS: 100

    ports:
      - "8080:8080"

    volumes:
      - ../tumiki-realm.json:/opt/keycloak/data/import/tumiki-realm.json:ro

    command:
      - start
      - --optimized
      - --import-realm

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 3s
      start_period: 60s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
