# 組織管理機能 仕様要件書

## 1. 背景・目的

### 1.1 背景
- 組織図UIにおいて、部署間の関係（エッジ）を視覚的に編集できる機能が必要
- 現状では、意図しない操作による誤った組織構造の作成を防ぐ仕組みが不足している
- データの整合性を保つため、バリデーション機能が必要

### 1.2 目的
- ユーザーが選択したノード（部署）のみを操作対象とすることで、誤操作を防ぐ
- 組織構造として不正な状態（孤立した部署など）を保存できないようにする
- ユーザーに分かりやすいエラーメッセージとフィードバックを提供する

## 2. データモデル・システムアーキテクチャ

### 2.1 Keycloak統合アーキテクチャ

本機能は、Keycloakの認証・認可基盤を活用した組織管理を実現します。

#### 2.1.1 基本構造
- **認証基盤**: Keycloak
- **使用エンティティ**: Groups、Roles、Users
- **階層構造**: Realm → Organization Groups → Department Child Groups → Users

#### 2.1.2 データモデル構成

```
Keycloak Realm (例: tumiki-realm)
├── Organization Group 1 (例: Tech Corp)
│   ├── Department Child Group 1-1 (例: Engineering)
│   │   ├── Department Child Group 1-1-1 (例: Frontend)
│   │   │   └── Users
│   │   ├── Department Child Group 1-1-2 (例: Backend)
│   │   │   └── Users
│   │   └── Users
│   ├── Department Child Group 1-2 (例: Product)
│   │   └── Users
│   └── Department Child Group 1-3 (例: Marketing)
│       └── Users
├── Organization Group 2
│   ├── Department Child Group 2-1
│   └── Department Child Group 2-2
└── Organization Group 3
    └── ...
```

#### 2.1.3 エンティティの役割

**Groups（グループ）**:
- **Organization Group（組織グループ）**: Realm直下に作成される最上位グループ
  - 1つのRealmに複数の組織グループを作成可能
  - 例: "Tech Corp", "Acme Inc", "Global Ventures"
- **Department Child Groups（部署子グループ）**: 組織グループ配下の部署を表現
  - 階層構造を持つ（最大深度は設計次第）
  - 親子関係で部署の階層を表現
  - 例: "Engineering" → "Frontend", "Backend"

**Users（ユーザー）**:
- 各Child Groupに所属
- 複数のGroupに所属可能
- Group所属により部署配属を表現

**Roles（ロール）**:
- ユーザーの権限を定義
- 部署内での役職を表現（例: "部長", "課長", "メンバー"）
- Group単位またはUser単位で割り当て可能

#### 2.1.4 UIでの操作対象

本UIでは、以下の操作を視覚的に行うことができます:

1. **Child Groups（部署）の操作**
   - 新規部署の作成
   - 部署名の変更
   - 部署の削除
   - 部署の階層移動（親部署の変更）
   - 部署間の接続関係（エッジ）の編集

2. **Users（ユーザー）の操作**
   - 部署へのユーザー追加
   - 部署からのユーザー削除
   - ユーザーの役職（Role）変更
   - 部署責任者の指定

3. **視覚的な階層表示**
   - マップビュー: 組織図として視覚化
   - ツリービュー: 階層構造として表示
   - テーブルビュー: 一覧形式で表示

### 2.2 マルチテナント対応

#### 2.2.1 Realmの分離
- 同一Keycloakインスタンス内に複数のRealmを作成可能
- 各Realmは完全に独立したテナント

#### 2.2.2 組織の分離
- 同一Realm内に複数のOrganization Groupを作成可能
- 各組織は独立した部署階層を持つ
- ユーザーは複数の組織に所属可能（Groupの多重所属）

### 2.3 データ同期と整合性

#### 2.3.1 UIとKeycloakの同期
- UI上での操作は即座にKeycloak Admin APIを通じて反映
- tRPCルーター経由でKeycloak APIを呼び出し
- 楽観的更新とエラーハンドリング

#### 2.3.2 整合性保証
- Keycloak側での階層構造検証
- UI側でのバリデーション（本仕様書の対象）
- トランザクション処理による一貫性保持

### 2.4 セキュリティとアクセス制御

#### 2.4.1 権限モデル
- Organization Group単位でのアクセス制御
- 組織管理者ロール: 自組織内の全操作が可能
- 部署管理者ロール: 自部署内の限定的な操作が可能
- 一般ユーザー: 閲覧のみ

#### 2.4.2 操作権限
- Child Groupsの編集: 組織管理者のみ
- Usersの追加・削除: 組織管理者および部署管理者
- Rolesの割り当て: 組織管理者のみ

## 3. ユーザーストーリー

### US-1: 部署の接続関係を作成したい
**As a** 組織管理者
**I want to** 選択した部署から他の部署へ接続線を引けるようにしたい
**So that** 組織の階層構造を視覚的に構築できる

**受け入れ基準**:
- 部署を選択すると、その部署の下側に接続ポイント（ハンドル）が表示される
- ハンドルをドラッグして他の部署に接続できる
- 選択していない部署からは接続線を引けない

### US-2: 部署の接続関係を削除したい
**As a** 組織管理者
**I want to** 不要な接続線を削除できるようにしたい
**So that** 組織構造を柔軟に変更できる

**受け入れ基準**:
- 選択した部署に関連する接続線のみ削除できる
- 削除時には視覚的なフィードバック（削除ボタン）がある
- 削除後、組織構造が不正な状態になる場合は保存できない

### US-3: 部署の接続関係を変更したい
**As a** 組織管理者
**I want to** 既存の接続線を別の部署に付け替えられるようにしたい
**So that** 組織の再編を簡単に行える

**受け入れ基準**:
- 選択した部署に関連する接続線のみ付け替えられる
- ドラッグ操作で直感的に変更できる
- 不正な接続（ルートへの接続など）は自動的に拒否される

### US-4: 誤った組織構造を保存できないようにしたい
**As a** 組織管理者
**I want to** 不完全な組織構造を保存できないようにしたい
**So that** データの整合性を保つことができる

**受け入れ基準**:
- 親部署のない部署が存在する場合、保存ボタンが無効化される
- 無効な理由がツールチップで表示される
- 構造が正しい状態になると、自動的に保存ボタンが有効になる

## 4. 機能要件

### 4.1 エッジ作成機能

#### FR-1.1: ボトムハンドルの表示
- **条件**: 以下のいずれかを満たす場合
  - 部署が選択されている
  - 部署に子部署が存在する
- **表示位置**: 部署ボックスの下側中央
- **視覚的特徴**: 小さな円形、プライマリカラー

#### FR-1.2: エッジ作成の操作
- **操作**: ボトムハンドルをドラッグして他の部署へドロップ
- **制約**:
  - 選択された部署からのみ作成可能
  - ルート部署（最上位組織）への/からの接続は不可
  - 接続元と接続先が同一の部署は不可

#### FR-1.3: エッジ作成時のフィードバック
- **成功時**: エッジが視覚的に表示される
- **失敗時**: エラーメッセージを表示
  - 「選択されたノードに関連する接続のみ可能です」

### 4.2 エッジ削除機能

#### FR-2.1: 削除可能なエッジ
- **条件**: 選択された部署に関連するエッジのみ
  - 選択部署から出ているエッジ（source）
  - 選択部署に入っているエッジ（target）

#### FR-2.2: 削除の操作方法
1. **エッジ上の削除ボタン**: エッジ上に表示される×ボタンをクリック
2. **キーボード操作**: エッジを選択してDeleteキーを押す

#### FR-2.3: 削除時のフィードバック
- **成功時**: 「エッジを削除しました」トースト表示
- **失敗時**: 「選択されたノードのエッジのみ削除できます」エラートースト

### 4.3 エッジ再接続機能

#### FR-3.1: 再接続可能なエッジ
- **条件**: 選択された部署に関連するエッジのみ

#### FR-3.2: 再接続の操作
- **操作**: エッジのハンドルをドラッグして別の部署に接続
- **制約**: エッジ作成と同じ制約が適用される

#### FR-3.3: 再接続時のフィードバック
- **失敗時**: 「選択されたノードのエッジのみ再接続できます」エラートースト

### 4.4 初期表示状態

#### FR-4.1: デフォルト選択状態
- **要件**: ページ読み込み時、全ての部署が未選択状態
- **理由**: ユーザーが意図的に部署を選択してから操作を行うため

### 4.5 バリデーション機能

#### FR-5.1: 矢印なし部署の定義
- **定義**: 親部署への接続が存在しない部署（ルート除く）
- **検出タイミング**: エッジの作成・削除・再接続時に自動検出

#### FR-5.2: 保存ボタンの状態制御
- **有効条件**: 全ての部署（ルート除く）が少なくとも1つの親部署を持つ
- **無効条件**: 矢印なし部署が1つでも存在する
- **視覚的フィードバック**:
  - 無効時: ボタンがグレーアウト
  - ツールチップ: 「全ての部署に親部署を設定してください」

#### FR-5.3: 保存時のバリデーション
- **実行タイミング**: 保存ボタンクリック時
- **検証内容**: 矢印なし部署がないことを確認
- **失敗時**: エラートースト「全ての部署に親部署を設定してください」

### 4.6 保存機能

#### FR-6.1: 保存処理
- **現在の実装**: モック実装（ローカル状態のみ）
- **将来の拡張**: tRPC経由でKeycloak APIに保存

#### FR-6.2: 保存時のフィードバック
- **成功時**: 「組織構造を保存しました」トースト表示
- **失敗時**: バリデーションエラーメッセージ

## 5. UI/UX要件

### 5.1 視覚的フィードバック

#### UX-1.1: 部署の選択状態
- **選択時**:
  - 太いボーダー（プライマリカラー）
  - リングエフェクト
  - 関連するエッジが黒色で強調表示
- **未選択時**: 通常のボーダー（グレー）

#### UX-1.2: ハンドルの表示
- **サイズ**: 18px × 18px
- **色**: プライマリカラー
- **位置**:
  - トップハンドル: 部署ボックス上側中央
  - ボトムハンドル: 部署ボックス下側中央

#### UX-1.3: エッジの表示
- **通常時**: グレー（#9ca3af）、太さ3px
- **選択部署関連**: 黒色（#000000）、太さ3px
- **削除ボタン**: 赤い円形ボタン、選択部署関連エッジのみ表示

#### UX-1.4: ボタンの状態
- **保存ボタン有効時**: プライマリカラー
- **保存ボタン無効時**: グレーアウト、カーソル不可

### 5.2 操作のフィードバック

#### UX-2.1: トースト通知
- **表示位置**: 画面上部中央
- **表示時間**: 3秒
- **種類**:
  - 成功: 緑色
  - エラー: 赤色
  - 情報: 青色

#### UX-2.2: ツールチップ
- **表示タイミング**: マウスホバー時
- **対象**: 無効化された保存ボタン
- **内容**: 無効化の理由

### 5.3 アクセシビリティ

#### UX-3.1: キーボード操作
- **Tab**: フォーカス移動
- **Delete**: 選択中のエッジを削除
- **Enter/Space**: ボタンのアクティベート

#### UX-3.2: タッチ操作
- **タップターゲット**: 最小44px × 44px
- **ドラッグ**: タッチスクリーンでのドラッグ操作をサポート

## 6. バリデーションルール

### VR-1: ルートノード保護
- **ルール**: ルート部署（最上位組織）への/からの接続は不可
- **理由**: 組織構造の一貫性を保つため
- **エラー表示**: なし（操作を自動的に拒否）

### VR-2: 選択状態チェック
- **ルール**: 選択された部署に関連する操作のみ許可
- **対象操作**:
  - エッジ作成
  - エッジ削除
  - エッジ再接続
- **エラー表示**: 操作に応じたエラーメッセージ

### VR-3: 矢印なし部署チェック
- **ルール**: 全ての部署（ルート除く）が親部署を持つ必要がある
- **チェックタイミング**:
  - エッジ作成・削除・再接続後
  - 保存ボタンクリック時
- **エラー表示**: 保存ボタン無効化 + ツールチップ

### VR-4: 循環参照チェック（既存機能）
- **ルール**: 部署の親子関係に循環参照が存在しない
- **チェックタイミング**: 部署移動時
- **エラー表示**: 「部署の移動に失敗しました（循環参照の可能性）」

## 7. エラーメッセージ一覧

| エラーコード | 表示メッセージ | 発生条件 | 表示方法 |
|-------------|--------------|---------|---------|
| ERR-001 | 選択されたノードに関連する接続のみ可能です | 未選択部署からエッジ作成 | トースト |
| ERR-002 | 選択されたノードのエッジのみ削除できます | 未選択部署のエッジ削除 | トースト |
| ERR-003 | 選択されたノードのエッジのみ再接続できます | 未選択部署のエッジ再接続 | トースト |
| ERR-004 | 全ての部署に親部署を設定してください | 矢印なし部署が存在 | ツールチップ + トースト |
| ERR-005 | 部署の移動に失敗しました（循環参照の可能性） | 循環参照検出 | トースト |

## 8. 成功メッセージ一覧

| メッセージコード | 表示メッセージ | 発生条件 | 表示方法 |
|----------------|--------------|---------|---------|
| MSG-001 | エッジを削除しました | エッジ削除成功 | トースト |
| MSG-002 | 組織構造を保存しました | 保存処理成功 | トースト |
| MSG-003 | 部署を移動しました | 部署移動成功 | トースト |
| MSG-004 | 部署情報を更新しました | 部署情報更新成功 | トースト |
| MSG-005 | 部署を削除しました | 部署削除成功 | トースト |

## 9. テストシナリオ

### TS-1: エッジ作成の基本フロー
1. Marketingノードをクリックして選択
2. ボトムハンドルが表示されることを確認
3. ボトムハンドルからProductノードへドラッグ
4. エッジが作成されることを確認
5. 保存ボタンが有効であることを確認

**期待結果**: エッジが作成され、保存可能な状態になる

### TS-2: エッジ作成の選択状態エラー
1. Marketingノードを選択
2. Productノードのボトムハンドルからドラッグを試みる
3. エラートースト「選択されたノードに関連する接続のみ可能です」が表示される

**期待結果**: エッジが作成されず、エラーメッセージが表示される

### TS-3: エッジ削除と保存ボタン無効化
1. Engineeringノードを選択
2. Engineering → Frontendのエッジを削除
3. 保存ボタンが無効化される
4. 保存ボタンにホバーして「全ての部署に親部署を設定してください」ツールチップが表示される

**期待結果**: エッジが削除され、保存ボタンが無効化される

### TS-4: エッジ再作成と保存ボタン有効化
1. TS-3の続き（Frontendが孤立状態）
2. Tech CorpノードまたはEngineeringノードを選択
3. 選択ノードからFrontendノードへエッジを作成
4. 保存ボタンが有効化される

**期待結果**: 保存ボタンが再び有効になる

### TS-5: デフォルト状態の確認
1. ページを開く
2. 全ての部署が未選択状態であることを確認
3. 部署を選択していない状態でボトムハンドルが表示されないことを確認（子部署がない場合）

**期待結果**: デフォルトで全て未選択、適切なハンドル表示

### TS-6: ルートノード保護
1. 任意の部署を選択
2. Tech Corp（ルート）へ/からの接続を試みる
3. エッジが作成されない（エラーメッセージなし）

**期待結果**: ルートへの不正な接続が防止される

### TS-7: エッジ削除の選択状態エラー
1. Marketingノードを選択
2. Engineering → Frontendのエッジを選択
3. Deleteキーを押す
4. エラートースト「選択されたノードのエッジのみ削除できます」が表示される

**期待結果**: エッジが削除されず、エラーメッセージが表示される

### TS-8: エッジ再接続の成功フロー
1. Engineeringノードを選択
2. Engineering → Backendのエッジをドラッグ
3. Productノードに接続
4. エッジが再接続される

**期待結果**: エッジが正常に再接続される

### TS-9: 保存機能の成功フロー
1. 全ての部署に親部署が設定されている状態を確認
2. 保存ボタンをクリック
3. 「組織構造を保存しました」トーストが表示される

**期待結果**: 保存が成功し、フィードバックが表示される

### TS-10: 保存機能のバリデーションエラー
1. 任意のエッジを削除して矢印なし部署を作成
2. 保存ボタンをクリック（無効化されているのでクリックできない場合はスキップ）
3. エラートースト「全ての部署に親部署を設定してください」が表示される

**期待結果**: 保存が拒否され、エラーメッセージが表示される

## 10. 優先順位

### P0: 必須機能（MVP）
- FR-1.1, FR-1.2: エッジ作成機能
- FR-2.1, FR-2.2: エッジ削除機能
- FR-5.2: 保存ボタンの状態制御
- VR-1: ルートノード保護
- VR-3: 矢印なし部署チェック

### P1: 重要機能
- FR-3.1, FR-3.2: エッジ再接続機能
- FR-4.1: デフォルト選択状態
- FR-5.3: 保存時のバリデーション
- VR-2: 選択状態チェック

### P2: 改善項目
- UX-1: 視覚的フィードバック全般
- UX-2: 操作のフィードバック
- UX-3: アクセシビリティ対応

## 11. 将来の拡張

### 拡張1: バックエンド連携
- tRPC経由でKeycloak APIに組織構造を保存
- 保存時にサーバー側でもバリデーション実施
- 楽観的更新とエラーハンドリング

### 拡張2: 追加バリデーション
- 最小/最大階層数の制限
- 部署名の重複チェック
- メンバー数の上限チェック
- より詳細な循環参照チェック

### 拡張3: UI/UX改善
- エッジ作成時のビジュアルフィードバック強化
- ドラッグ中のプレビュー表示
- アニメーション効果の追加
- アンドゥ/リドゥ機能
- キーボードショートカット

### 拡張4: 履歴管理
- 組織構造変更履歴の記録
- 変更の差分表示
- ロールバック機能

---

**文書バージョン**: 1.0
**最終更新日**: 2025-12-21
**作成者**: Claude Code
**レビュアー**: TBD
**承認者**: TBD
