# MCPサーバー管理画面 - 機能設計書 v2

## 概要

ユーザーが直感的にMCPサーバーを追加・カスタマイズできるアプリケーションの機能設計です。

## 設計原則

1. **シンプルな用語**: 専門用語を避け、日常的な言葉で説明
2. **段階的な開示**: 必要な情報を段階的に表示
3. **直感的なフロー**: 2ステップで完結する追加プロセス
4. **視覚的フィードバック**: 状態や進捗を明確に

## v2での主な改善点

### 1. ユーザーフローの簡素化

**改善前**: テンプレート選択 → 認証設定 → ツール選択 → サーバー作成

**改善後**: テンプレート選択 → 認証設定と同時にサーバー自動作成

### 2. サーバータイプの明確化

- **単体サーバー**: 1つのテンプレートから作成、すぐに使える
- **統合サーバー**: 複数の既存サーバーをまとめて管理

## データモデルの関係性

### 用語の整理

- **MCPサーバーテンプレート** (`McpServerTemplate`): 設計図・レシピ（接続方法、認証方式の定義）
- **接続設定** (`McpConfig`): APIキーや環境変数などの認証情報
- **接続されたサーバー** (`McpServer`): 実際に利用できる状態のサーバー

### データフロー

#### パターンA: 単体サーバー接続（基本フロー）

1. テンプレートを選択 (McpServerTemplate)
2. 認証情報を設定 (McpConfig + OAuth/APIキー)
3. **自動的に単体サーバーが作成される** (McpServer) → すぐに利用可能！

#### パターンB: 統合サーバー作成（上級者向け）

1. 既に接続済みの複数のサーバー (McpServer) を選択
2. それらをまとめた統合サーバーを作成 (新しいMcpServer)
3. 複数サーバーのツールをまとめて利用

## 画面構成と機能

### 1. メインダッシュボード (`/mcp/servers`)

#### 目的

接続済みのサーバーを一覧表示し、管理する

#### 表示情報

- 接続済みサーバーの一覧（単体サーバー、統合サーバー、カスタムサーバーテンプレートすべて）
- 各サーバーの基本情報
  - サーバー名
  - サーバータイプ（単体、統合、カスタムテンプレート）
  - 接続状態（接続中、停止中、エラー、検証中）
  - 利用可能なツール数
  - 統合サーバーの場合: 含まれるサーバー名のリスト
  - カスタムテンプレートの場合: 公開範囲（プライベート、組織内共有、公開）

#### 機能

- サーバーの追加
- サーバーの起動/停止
- サーバーの並び替え（ドラッグ&ドロップ）
- サーバーの詳細表示
- サーバーの設定
- サーバーの削除
- フィルター機能
  - すべて表示
  - 単体サーバーのみ
  - 統合サーバーのみ
  - カスタムテンプレートのみ
- カスタムテンプレートの編集
- カスタムテンプレートの複製
- カスタムテンプレートからサーバーを接続

---

### 2. サーバー追加画面 (`/mcp/servers/add`)

#### 目的

利用可能なサーバーテンプレートから選択する

#### 表示情報

- 利用可能なサーバーテンプレート一覧
- 各テンプレートの基本情報
  - サーバー名
  - 説明
  - カテゴリータグ
  - 認証方式（APIキー、OAuth、認証不要）
  - 接続タイプ（クラウド、ローカル）

#### 機能

- テンプレートの検索
- カテゴリーでフィルタリング
- テンプレート詳細の表示
- カスタムサーバーの追加
- 統合サーバーの作成

---

### 3. サーバー詳細モーダル

#### 目的

選択したサーバーの詳細情報を表示し、接続設定を開始する

#### 表示情報

- サーバーの詳細説明
- 提供されるツールのリスト
- 必要な認証情報の説明

#### 機能

- 接続設定の開始
- 外部ドキュメントへのリンク

---

### 4. 接続設定ウィザード（改善版）

#### 目的

サーバーに接続するための設定を行う

#### ステップ1: サーバー名の設定

##### 入力情報

- サーバー名（編集可能、デフォルト値あり）

#### ステップ2: 認証設定 & 接続

##### パターンA: OAuth認証の場合

###### 機能

- OAuth認証画面へのリダイレクト
- 認証完了後、自動的に単体サーバーを作成

##### パターンB: APIキー認証の場合

###### 入力情報

- APIキー
- 必要な環境変数（複数可）

###### 機能

- APIキーの検証
- 接続完了後、自動的に単体サーバーを作成

##### パターンC: 認証不要の場合

###### 機能

- 即座に接続
- 自動的に単体サーバーを作成

---

### 5. 統合サーバー作成ウィザード（新規）

#### 目的

複数の既存サーバーをまとめて管理する

#### ステップ1: サーバーの選択

##### 表示情報

- 接続済みサーバーの一覧
- 各サーバーのツール数

##### 機能

- 複数サーバーの選択（最低2つ以上）

#### ステップ2: 統合サーバーの設定

##### 入力情報

- 統合サーバー名（デフォルト: 選択したサーバー名を連結）

##### 表示情報

- 選択されたサーバー一覧
- 利用可能なツールの合計数

##### 機能

- 統合サーバーの作成

---

### 6. サーバー詳細画面 (`/mcp/servers/[id]`)

#### 目的

接続済みサーバーの詳細情報、統計、管理

#### タブ1: 概要

##### 表示情報

- 統計情報
  - 今月のリクエスト数
  - 利用可能なツール数
  - 最終使用日時
- サーバー情報
  - サーバータイプ（単体 or 統合）
  - 統合サーバーの場合: 含まれるサーバー一覧
- 接続設定
  - 接続タイプ
  - 認証状態
- 利用可能なツール一覧

##### 機能

- 再接続（エラー時）
- ツール詳細の表示

#### タブ2: 設定

##### 表示情報

- 基本設定
  - サーバー名
  - アイコン
- 認証設定（単体サーバーのみ）
  - 現在の認証状態
- 統合サーバー設定（統合サーバーのみ）
  - 含まれるサーバーの一覧
  - 各サーバーの接続状態
- ツール設定
  - 利用するツールの一覧

##### 機能

- サーバー名の編集
- アイコンの変更
- 認証の更新（単体サーバー）
- APIキーの再設定（APIキー認証の場合）
- 統合サーバーへのサーバー追加/削除
- ツールの有効/無効切り替え
- サーバーの削除

#### タブ3: ログ・統計

##### 表示情報

- リクエストログ
  - タイムスタンプ
  - 実行されたツール名
  - ステータス（成功/失敗）
  - 実行時間
- グラフ
  - 日別リクエスト数
  - ツール別使用状況

##### 機能

- ログのフィルタリング
- グラフの期間選択

---

### 7. カスタムサーバー作成モーダル

#### 目的

独自のサーバーテンプレートを作成する

#### ステップ1: 基本情報

##### 入力情報

- テンプレート名
- 説明
- カテゴリータグ
- アイコン（オプション）

#### ステップ2: 接続設定

##### 入力情報

- 接続タイプ（クラウド or ローカル）
- クラウド接続の場合
  - 接続URL
  - Cloud Run IAM認証を使用するか
- ローカル接続の場合
  - コマンド
  - 引数（複数可）

#### ステップ3: 認証設定

##### 入力情報

- 認証タイプ（なし、APIキー、OAuth）
- APIキーの場合
  - 必要な環境変数/ヘッダーのキー名
- OAuthの場合
  - プロバイダー（Google, GitHub, など）
  - スコープ

#### ステップ4: 公開設定

##### 入力情報

- 公開範囲（プライベート、組織内共有、公開）

##### 機能

- テンプレートの作成

---

## ユーザーフロー

### フロー1: 単体サーバーの接続（基本フロー）

1. メインダッシュボードで「サーバーを追加」
2. サーバー追加画面でテンプレートを選択
3. サーバー詳細モーダルで「接続する」
4. 接続設定ウィザード
   - サーバー名を設定
   - 認証設定を行う
5. 認証完了と同時に単体サーバーが自動作成
6. メインダッシュボードに戻る or ツールを確認

### フロー2: 統合サーバーの作成

1. メインダッシュボードで「サーバーを追加」
2. サーバー追加画面で「統合サーバーを作成」
3. 統合サーバー作成ウィザード
   - まとめたいサーバーを選択
   - 統合サーバー名を設定
4. 統合サーバーが作成される
5. メインダッシュボードに表示

### フロー3: カスタムサーバーの追加

1. メインダッシュボードで「サーバーを追加」
2. サーバー追加画面で「カスタムサーバーを追加」
3. カスタムサーバー作成モーダル
   - 基本情報を入力
   - 接続設定を入力
   - 認証設定を入力
   - 公開設定を選択
4. テンプレートが作成される
5. メインダッシュボードに表示（カスタムテンプレートとしてラベル付き）
6. フィルターで「カスタムテンプレート」を選択して確認可能
7. 「このテンプレートから接続」でフロー1へ

---

## 実装の優先順位

### Phase 1: コア機能（MVP）

1. メインダッシュボード
2. サーバー追加画面
3. サーバー詳細モーダル
4. 接続設定ウィザード（OAuth/APIキー対応）
5. 単体サーバーの自動作成
6. サーバー詳細画面（概要タブのみ）

### Phase 2: 拡張機能

1. 統合サーバー作成機能
2. カスタムサーバー機能
3. サーバー詳細画面（設定タブ）
4. 並び替え機能
5. 検索・フィルター機能の強化

### Phase 3: 分析・管理機能

1. サーバー詳細画面（ログ・統計タブ）
2. ツールグループ機能
3. 組織設定との連携
4. 高度なフィルター・ソート

---

## まとめ

この設計により、ユーザーは技術的な知識がなくても直感的にMCPサーバーを追加・管理できます。

**主な改善点:**

1. 2ステップで完結するシンプルなフロー
2. 認証完了と同時にサーバー作成（すぐに利用可能）
3. 単体サーバーと統合サーバーの明確な区別
4. 段階的な情報開示で認知負荷を軽減
5. カスタマイズ可能な柔軟性を保持
