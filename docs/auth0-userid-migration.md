# Auth0 ユーザーID移行ガイド

このドキュメントでは、Auth0のsub（`github|141129258`のような形式）から実際のユーザーID（`141129258`）を抽出して使用するための移行手順を説明します。

## 背景

現在のシステムでは、Auth0のsubをそのままUserテーブルのIDとして使用していますが、以下の理由により、パイプ記号以降の部分のみを使用するように変更します：

- データベース内のIDがシンプルになり、可読性が向上する
- Auth0はパイプ記号以降の部分を実際のuserIdとして管理している
- 将来的な拡張性とメンテナンス性の向上

## 移行前後の比較

### 移行前
```
User.id: "github|141129258"
User.id: "google-oauth2|102635221332040133994"
```

### 移行後
```
User.id: "141129258"
User.id: "102635221332040133994"
```

## 実装内容

### 1. Auth0ユーティリティ関数

`packages/utils/src/auth0Utils.ts`に以下の関数を実装：

- `extractUserIdFromSub(sub: string): string` - Auth0 subからuserIdを抽出
- `buildAuth0Sub(provider: string, userId: string): string` - providerとuserIdからsubを構築
- `extractProviderFromSub(sub: string): string` - subからプロバイダー名を抽出
- `isAuth0Sub(value: string): boolean` - Auth0 sub形式かどうかを判定

### 2. 認証フローの更新

- **ユーザー登録時** (`syncUserFromAuth0`): Auth0 subからuserIdを抽出して保存
- **認証時** (`protectedProcedure`): `session.user.sub`からuserIdを抽出して`session.user.id`に設定
- **Auth0 Management API呼び出し時**: 完全なsubを使用（コメントで明記）

## 移行手順

### ステップ1: コードのデプロイ

1. このブランチ（`fix-user-migration`）の変更をマージ
2. 本番環境にデプロイ

**重要**: この時点では新規ユーザーのみが新しい形式で登録されます。既存ユーザーは影響を受けません。

### ステップ2: 既存データのバックアップ

本番データベースのバックアップを作成：

```bash
# 例: PostgreSQLの場合
pg_dump -h [host] -U [user] -d [database] > backup_$(date +%Y%m%d_%H%M%S).sql
```

### ステップ3: マイグレーションスクリプトの実行

1. マイグレーションスクリプトをドライランで実行（確認のみ）：

```bash
cd packages/scripts
bun run src/migrate-user-ids.ts
```

2. 問題がなければ、実際に実行：

```bash
bun run src/migrate-user-ids.ts --confirm
```

スクリプトは以下の処理を行います：
- 既存のユーザーIDを`github|123` → `123`形式に変換
- 関連するすべてのテーブルの外部キーを更新
- トランザクション内で処理するため、エラー時は自動的にロールバック

### ステップ4: 動作確認

1. **新規ユーザー登録**: 新しいユーザーが正しい形式で登録されることを確認
2. **既存ユーザーログイン**: 移行済みユーザーが正常にログインできることを確認
3. **機能テスト**: 主要機能が正常に動作することを確認

## ロールバック手順

問題が発生した場合：

1. **コードのロールバック**: 以前のバージョンにデプロイし直す
2. **データのロールバック**: バックアップからデータベースを復元

```bash
# 例: PostgreSQLの場合
psql -h [host] -U [user] -d [database] < backup_[timestamp].sql
```

## 注意事項

### マイグレーション中の考慮事項

- マイグレーション実行中は一時的にサービスを停止することを推奨
- 大量のユーザーがいる場合は、バッチ処理を検討
- マイグレーション完了後、必ず全体的な動作確認を実施

### コード上の注意点

- Auth0 Management APIを呼び出す際は、完全なsub（`github|123`形式）を使用する必要がある
- データベース操作では抽出したuserId（`123`形式）を使用する
- テストコードも新しい形式に合わせて更新済み

## トラブルシューティング

### よくある問題

1. **マイグレーションスクリプトがエラーになる**
   - データベース接続設定を確認
   - 環境変数が正しく設定されているか確認

2. **ユーザーがログインできない**
   - Auth0の設定を確認
   - ユーザーIDが正しく移行されているか確認

3. **関連データの不整合**
   - すべての外部キー参照が更新されているか確認
   - マイグレーションログを確認

## まとめ

この移行により、システム全体のユーザーID管理がよりシンプルで保守しやすくなります。移行プロセスは慎重に計画し、十分なテストを行った上で実施してください。

問題が発生した場合は、すぐにロールバック手順を実行し、原因を調査してください。