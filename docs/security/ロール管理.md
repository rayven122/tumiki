# ロール管理

## 1. 会員種別

### 1.1 無料会員（Free）
- 基本的な機能のみ利用可能
- 制限事項：
  - 管理できるMCPサーバー数の制限（例：1台まで）
  - URLの発行数制限
  - 基本的な監視機能のみ
  - バッチ処理機能利用不可

### 1.2 有料会員（Premium）
- すべての機能を利用可能
- 特典：
  - 無制限のMCPサーバー管理
  - 無制限のURL発行
  - 高度な監視機能
  - バッチ処理機能の利用
  - プライオリティサポート

## 2. 権限ロール

### 2.1 サービス管理者（Super Admin）
- システム全体への完全なアクセス権限
- データベースの直接操作権限
- システム設定の変更権限
- デバッグ情報へのアクセス権限
- 開発環境の設定変更権限
- テスト環境の管理権限
- ログの完全な閲覧権限
- システムの再起動権限
- バックアップの作成・復元権限

### 2.2 システム管理者（Admin）
- システム全体の設定管理
- ユーザー管理（作成・編集・削除）
- APIキーの管理
- すべてのMCPサーバーの管理権限
- セキュリティ設定の管理
- 監査ログの閲覧

### 2.3 サーバー管理者（Server Manager）
- 割り当てられたMCPサーバーの管理
- サーバーの起動・停止・再起動
- サーバー状態の監視
- URLの発行と管理

### 2.4 一般ユーザー（User）
- 割り当てられたサーバーの状態確認
- 発行されたURLの利用
- 基本的な操作の実行

### 2.5 閲覧者（Viewer）
- システム状態の閲覧のみ
- サーバー状態の確認
- レポートの閲覧

## 3. データベース設計

### 3.1 ユーザー関連
```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String    // ハッシュ化されたパスワード
  role          Role      @default(USER)
  membershipType MembershipType @default(FREE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // リレーション
  servers       ServerUser[]
  apiKeys       ApiKey[]
  urls          GeneratedUrl[]
  sessions      Session[]
}

enum Role {
  DEVELOPER
  ADMIN
  SERVER_MANAGER
  USER
  VIEWER
}

enum MembershipType {
  FREE
  PREMIUM
}
```

### 3.2 セッション管理
```prisma
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

### 3.3 サーバー関連
```prisma
model Server {
  id          String   @id @default(cuid())
  name        String
  host        String
  status      ServerStatus @default(STOPPED)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  users       ServerUser[]
  apiKeys     ApiKey[]
  urls        GeneratedUrl[]
  tools       ServerTool[]
}

enum ServerStatus {
  RUNNING
  STOPPED
  MAINTENANCE
  ERROR
}

model ServerUser {
  id        String   @id @default(cuid())
  userId    String
  serverId  String
  role      ServerUserRole
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([userId, serverId])
}

enum ServerUserRole {
  OWNER
  MANAGER
  MEMBER
}
```

### 3.4 APIキー管理
```prisma
model ApiKey {
  id          String   @id @default(cuid())
  name        String
  key         String   // 暗号化されたAPIキー
  type        ApiKeyType
  userId      String
  serverId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
}

enum ApiKeyType {
  SLACK
  OTHER
}
```

### 3.5 URL管理
```prisma
model GeneratedUrl {
  id          String   @id @default(cuid())
  url         String   @unique
  userId      String
  serverId    String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  tools       UrlTool[]
}

model ServerTool {
  id          String   @id @default(cuid())
  serverId    String
  name        String
  isActive    Boolean  @default(true)
  
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  urls        UrlTool[]
}

model UrlTool {
  id            String   @id @default(cuid())
  urlId         String
  serverToolId  String
  
  url           GeneratedUrl @relation(fields: [urlId], references: [id], onDelete: Cascade)
  serverTool    ServerTool  @relation(fields: [serverToolId], references: [id], onDelete: Cascade)

  @@unique([urlId, serverToolId])
}
```

### 3.6 課金管理
```prisma
model Subscription {
  id            String   @id @default(cuid())
  userId        String   @unique
  planType      MembershipType
  startDate     DateTime
  endDate       DateTime?
  status        SubscriptionStatus
  paymentMethod String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}
```

## 4. セキュリティ考慮事項
- パスワードは必ずハッシュ化して保存
- APIキーは暗号化して保存
- セッショントークンの有効期限管理
- 適切なインデックス設定

## 5. 実装時の検討事項
- バックアップ戦略
- インデックス最適化
- パフォーマンスチューニング
- データ移行戦略
