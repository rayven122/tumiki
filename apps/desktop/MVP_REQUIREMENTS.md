# Tumiki Desktop MVP 要件書

## 1. MVP スコープ

### 1.1 含まれる機能

1. **OAuth 認証**
   - Keycloakによる認証（SaaSと共通）
   - トークン暗号化保存
   - 自動トークンリフレッシュ

2. **AIツールへのワンクリック接続**
   - MCPサーバー一覧表示（SaaS + ローカル）
   - Claude Code / Claude Desktop / Cursor の設定ファイル自動生成

3. **ローカルMCPサーバー登録**
   - 手動登録フォーム（name, command, args, transport）
   - 全てクラウドで管理（環境変数含む）

4. **ログのハイブリッド管理**
   - ローカルファイル書き出し
   - 5分ごとにクラウド同期
   - 7日間のローカル保持

### 1.2 スコープ外（Phase 2以降）

- チーム管理
- 複数プロファイル
- メトリクス分析
- プラグインシステム
- 自動更新

---

## 2. UI仕様

### 2.1 ログイン画面

```text
┌─────────────────────────────────────────┐
│                                         │
│          Tumiki Desktop                 │
│                                         │
│        [Keycloakでログイン]             │
│                                         │
└─────────────────────────────────────────┘
```

- Keycloakのログインページを外部ブラウザで開く
- コールバックURLでトークン取得
- トークンを暗号化してローカル保存

### 2.2 サーバー一覧画面

```text
┌─────────────────────────────────────────┐
│ Tumiki Desktop         [設定] [同期]    │
├─────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐               │
│ │📦 GitHub│ │🔍 Google│               │
│ │MCP      │ │Drive MCP│               │
│ │ツール:5 │ │ツール:3 │               │
│ │[接続設定]│ │[接続設定]│              │
│ └─────────┘ └─────────┘               │
│ [+ ローカルサーバーを追加]              │
└─────────────────────────────────────────┘
```

### 2.3 接続設定ダイアログ

```text
接続先を選択:
☐ Claude Code
☐ Claude Desktop
☐ Cursor

[キャンセル] [設定ファイル生成]
```

### 2.4 ローカルサーバー登録

```text
サーバー名 * [_____]
説明        [_____]
コマンド *  [_____] (例: node, python, uvx)
引数        [_____] [+ 引数を追加]
トランスポート * ○ stdio ○ SSE

[キャンセル] [登録]
```

※ サーバー設定と環境変数は全てクラウドで管理されます

---

## 3. 認証フロー

### 3.1 OAuth 認証（Keycloak）

**初回ログイン**:

1. ユーザーが「Keycloakでログイン」ボタンをクリック
2. アプリが外部ブラウザでKeycloakログインページを開く
3. ユーザーがブラウザで認証
4. KeycloakがカスタムURLスキーム（`tumiki-desktop://callback`）にリダイレクト
5. アプリがコールバックを受け取り、認可コードを取得
6. 認可コードをアクセストークン・リフレッシュトークンと交換
7. トークンを暗号化してローカル保存

**トークンリフレッシュ**:

1. アクセストークン有効期限切れを検知
2. リフレッシュトークンで新しいアクセストークンを取得
3. 新しいトークンを暗号化保存

**ログアウト**:

1. ローカルのトークンを削除
2. Keycloakのセッションをクリア（オプション）

### 3.2 カスタムURLスキーム

- **スキーム**: `tumiki-desktop://`
- **コールバックURL**: `tumiki-desktop://callback`
- **登録**: アプリ起動時にOSに登録

## 4. データモデル

### 4.1 ローカルDB（SQLite）

- `auth_tokens`: 認証トークン（access_token, refresh_token, expires_at）- 暗号化
- `log_sync_queue`: ログ同期キュー（server_id, log_entry, sync_status）

※ MCPサーバー設定と環境変数は全てクラウドで管理

---

## 5. ログ管理

### 5.1 ローカルログ構造

```text
~/Library/Application Support/Tumiki Desktop/logs/
├── server-{id}/
│   ├── 2025-11-20.log
│   └── 2025-11-21.log
└── sync-queue/
    ├── pending/
    └── synced/
```

### 5.2 同期フロー

1. ローカルログ読み込み
2. 未同期ログ抽出 (`sync-queue/pending/`)
3. SaaS API へ POST
4. 成功したら `sync-queue/synced/` へ移動
5. 7日以上経過したログ削除

---

## 6. 開発スケジュール

### Week 1-2: 基礎

- [ ] Electron基盤
- [ ] SQLite
- [ ] Keycloak認証（OAuth 2.0 + PKCE）
- [ ] カスタムURLスキーム登録
- [ ] tRPC client
- [ ] 基本UI

### Week 3-4: コア機能

- [ ] サーバー一覧
- [ ] ローカルサーバー登録
- [ ] AIツール接続設定
- [ ] ログ記録

### Week 5-6: 同期

- [ ] ログクラウド同期
- [ ] オフライン対応
- [ ] ログ保持期間管理

### Week 7-8: リリース準備

- [ ] テスト（カバレッジ100%）
- [ ] バグ修正
- [ ] ドキュメント
- [ ] Alpha リリース

---

## 7. 完了条件

### 機能要件

- ✅ KeycloakによるOAuth認証
- ✅ トークンの暗号化保存と自動リフレッシュ
- ✅ SaaSからMCPサーバー一覧取得・表示
- ✅ ローカルMCPサーバー登録・管理
- ✅ Claude Code / Claude Desktop / Cursor 設定ファイル自動生成
- ✅ ログのローカルファイル記録
- ✅ ログのクラウド定期同期
- ✅ オフライン時もログ記録継続

### 技術要件

- ✅ `pnpm typecheck` 成功
- ✅ `pnpm test` 成功（カバレッジ100%）
- ✅ `pnpm build` 成功
- ✅ macOS で正常動作


---

**最終更新**: 2025-11-20
**バージョン**: MVP 1.0.0
