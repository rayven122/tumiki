<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP ProxyServer ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #2d3748;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-align: center;
      }

      .header p {
        color: #4a5568;
        font-size: 1.1rem;
        text-align: center;
      }

      .upload-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin: 20px;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .file-input-label {
        display: inline-block;
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .drop-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 10px;
        padding: 40px;
        margin: 20px 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .drop-zone.dragover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .control-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-group label {
        font-weight: 600;
        color: #4a5568;
        min-width: 100px;
      }

      .control-group select,
      .control-group input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        min-width: 150px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 25px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #2d3748;
        font-size: 1.5rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
      }

      .chart-container {
        width: 100%;
        height: 300px;
        margin: 20px 0;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      th {
        background: #f7fafc;
        font-weight: 600;
        color: #4a5568;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      tr:hover {
        background: #f7fafc;
      }

      .metric-value {
        font-weight: 600;
        color: #2d3748;
      }

      .transport-sse {
        color: #3182ce;
      }

      .transport-http {
        color: #38a169;
      }

      .status-success {
        color: #38a169;
      }

      .status-warning {
        color: #d69e2e;
      }

      .status-error {
        color: #e53e3e;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(255, 255, 255, 0.7) 100%
        );
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        backdrop-filter: blur(5px);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #4a5568;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #4a5568;
      }

      .error {
        background: #fed7d7;
        color: #c53030;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .warning {
        background: #fef5e7;
        color: #d69e2e;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .success {
        background: #c6f6d5;
        color: #2f855a;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .control-row {
          flex-direction: column;
          align-items: stretch;
        }

        .dashboard {
          grid-template-columns: 1fr;
        }

        .summary-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸš€ MCP ProxyServer ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®çµ±åˆåˆ†æãƒ»å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«</p>
      </div>

      <div class="upload-section">
        <h2>ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</h2>
        <p>
          performance_report_*.json
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã€ã¾ãŸã¯æ‰‹å‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
        </p>

        <div class="file-input-wrapper">
          <button
            class="btn btn-primary"
            onclick="loadFromServer()"
            style="margin: 10px"
          >
            ğŸ”„ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿
          </button>
          <input
            type="file"
            id="fileInput"
            class="file-input"
            multiple
            accept=".json"
          />
          <label for="fileInput" class="file-input-label">
            ğŸ“‚ æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          </label>
        </div>

        <div class="drop-zone" id="dropZone">
          <p>ã¾ãŸã¯ã€ã“ã“ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>

        <div id="fileList"></div>
        <div id="serverStatus" style="margin-top: 15px"></div>
      </div>

      <div class="controls" id="controls" style="display: none">
        <div class="control-row">
          <div class="control-group">
            <label for="transportFilter">Transport:</label>
            <select id="transportFilter">
              <option value="all">ã™ã¹ã¦</option>
              <option value="SSE">SSE Transport</option>
              <option value="HTTP">HTTP Transport</option>
            </select>
          </div>
          <div class="control-group">
            <label for="scenarioFilter">ã‚·ãƒŠãƒªã‚ª:</label>
            <select id="scenarioFilter">
              <option value="all">ã™ã¹ã¦</option>
            </select>
          </div>
          <div class="control-group">
            <label for="dateRange">æœŸé–“:</label>
            <input type="date" id="dateFrom" />
            <span>ã€œ</span>
            <input type="date" id="dateTo" />
          </div>
          <button class="btn btn-primary" onclick="applyFilters()">
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
          </button>
          <button class="btn btn-secondary" onclick="resetFilters()">
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>

      <div class="summary-stats" id="summaryStats" style="display: none"></div>

      <div class="dashboard" id="dashboard" style="display: none">
        <div class="card">
          <h2>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§</h2>
          <div class="table-container">
            <table id="reportTable">
              <thead>
                <tr>
                  <th>æ—¥æ™‚</th>
                  <th>ã‚·ãƒŠãƒªã‚ª</th>
                  <th>Transport</th>
                  <th>å¹³å‡RPS</th>
                  <th>P50ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·</th>
                  <th>æˆåŠŸç‡</th>
                  <th>ã‚¨ãƒ©ãƒ¼æ•°</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ“ˆ RPSæ¯”è¼ƒ</h2>
          <div class="chart-container">
            <canvas id="rpsChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>â±ï¸ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¯”è¼ƒ</h2>
          <div class="chart-container">
            <canvas id="latencyChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ”€ Transportæ¯”è¼ƒ</h2>
          <div class="chart-container">
            <canvas id="transportChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ“… æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰</h2>
          <div class="chart-container">
            <canvas id="timeSeriesChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼çµ±è¨ˆ</h2>
          <div class="chart-container">
            <canvas id="sessionChart"></canvas>
          </div>
        </div>
      </div>

      <div class="loading" id="loading" style="display: none">
        <p>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let allReports = [];
      let filteredReports = [];
      let charts = {}; // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
      document.addEventListener("DOMContentLoaded", () => {
        loadFromServer();
      });

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç†
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFiles);

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
      const dropZone = document.getElementById("dropZone");

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        handleFiles({ target: { files: e.dataTransfer.files } });
      });

      function handleFiles(event) {
        const files = Array.from(event.target.files);
        const jsonFiles = files.filter((file) => file.name.endsWith(".json"));

        if (jsonFiles.length === 0) {
          showError("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        showLoading(true);
        loadReports(jsonFiles);
      }

      function loadReports(files) {
        const promises = files.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                resolve({ filename: file.name, data });
              } catch (error) {
                reject(`${file.name}: ${error.message}`);
              }
            };
            reader.onerror = () =>
              reject(`${file.name}: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`);
            reader.readAsText(file);
          });
        });

        Promise.all(promises)
          .then((reports) => {
            allReports = reports;
            processReports();
            showSuccess(
              `${reports.length}å€‹ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`,
            );
          })
          .catch((error) => {
            showError(`ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error}`);
          })
          .finally(() => {
            showLoading(false);
          });
      }

      function processReports() {
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–ã¨çµ±åˆ
        const scenarios = new Set();
        const normalizedReports = [];

        allReports.forEach(({ filename, data }) => {
          if (data.scenarios && Array.isArray(data.scenarios)) {
            data.scenarios.forEach((scenario) => {
              scenarios.add(scenario.name);
              normalizedReports.push({
                ...scenario,
                timestamp: data.reportInfo?.timestamp || filename,
                filename: filename,
              });
            });
          } else {
            // æ—§å½¢å¼ã¸ã®å¯¾å¿œ
            normalizedReports.push({
              name: "unknown",
              transport: "Unknown",
              timestamp: filename,
              filename: filename,
              performance: data,
            });
          }
        });

        filteredReports = normalizedReports;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
        updateFilterOptions(scenarios);

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
        showDashboard();
        updateSummaryStats();
        updateReportTable();
        updateCharts();
      }

      function updateFilterOptions(scenarios) {
        const scenarioFilter = document.getElementById("scenarioFilter");
        scenarioFilter.innerHTML = '<option value="all">ã™ã¹ã¦</option>';

        scenarios.forEach((scenario) => {
          const option = document.createElement("option");
          option.value = scenario;
          option.textContent = scenario;
          scenarioFilter.appendChild(option);
        });
      }

      function applyFilters() {
        const transportFilter =
          document.getElementById("transportFilter").value;
        const scenarioFilter = document.getElementById("scenarioFilter").value;
        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;

        filteredReports = allReports.flatMap(({ data }) => {
          if (!data.scenarios) return [];

          return data.scenarios
            .filter((scenario) => {
              if (
                transportFilter !== "all" &&
                scenario.transport !== transportFilter
              )
                return false;
              if (scenarioFilter !== "all" && scenario.name !== scenarioFilter)
                return false;

              if (dateFrom || dateTo) {
                const reportDate = new Date(data.reportInfo?.timestamp || 0);
                if (dateFrom && reportDate < new Date(dateFrom)) return false;
                if (dateTo && reportDate > new Date(dateTo + "T23:59:59"))
                  return false;
              }

              return true;
            })
            .map((scenario) => ({
              ...scenario,
              timestamp: data.reportInfo?.timestamp || "unknown",
            }));
        });

        updateSummaryStats();
        updateReportTable();
        updateCharts();
      }

      function resetFilters() {
        document.getElementById("transportFilter").value = "all";
        document.getElementById("scenarioFilter").value = "all";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";

        filteredReports = allReports.flatMap(({ data }) => {
          if (!data.scenarios) return [];
          return data.scenarios.map((scenario) => ({
            ...scenario,
            timestamp: data.reportInfo?.timestamp || "unknown",
          }));
        });

        updateSummaryStats();
        updateReportTable();
        updateCharts();
      }

      function updateSummaryStats() {
        const stats = calculateSummaryStats(filteredReports);
        const container = document.getElementById("summaryStats");

        container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalReports}</div>
                    <div class="stat-label">ç·ãƒ¬ãƒãƒ¼ãƒˆæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgRPS}</div>
                    <div class="stat-label">å¹³å‡RPS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgLatency}ms</div>
                    <div class="stat-label">å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgSuccessRate}%</div>
                    <div class="stat-label">å¹³å‡æˆåŠŸç‡</div>
                </div>
            `;
      }

      function calculateSummaryStats(reports) {
        if (reports.length === 0) {
          return {
            totalReports: 0,
            avgRPS: 0,
            avgLatency: 0,
            avgSuccessRate: 0,
          };
        }

        const totalReports = reports.length;
        const avgRPS = (
          reports.reduce(
            (sum, r) => sum + (r.performance?.requests?.average || 0),
            0,
          ) / totalReports
        ).toFixed(1);
        const avgLatency = (
          reports.reduce(
            (sum, r) => sum + (r.performance?.latency?.average || 0),
            0,
          ) / totalReports
        ).toFixed(1);
        const avgSuccessRate = (
          reports.reduce(
            (sum, r) => sum + (r.performance?.successRate || 0),
            0,
          ) / totalReports
        ).toFixed(1);

        return { totalReports, avgRPS, avgLatency, avgSuccessRate };
      }

      function updateReportTable() {
        const tbody = document.querySelector("#reportTable tbody");
        tbody.innerHTML = "";

        filteredReports
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .forEach((report) => {
            const row = document.createElement("tr");
            const timestamp = new Date(report.timestamp).toLocaleString(
              "ja-JP",
            );
            const transport = report.transport || "Unknown";
            const performance = report.performance || {};

            row.innerHTML = `
                        <td>${timestamp}</td>
                        <td>${report.name || "Unknown"}</td>
                        <td><span class="transport-${transport.toLowerCase()}">${transport}</span></td>
                        <td class="metric-value">${(performance.requests?.average || 0).toFixed(1)}</td>
                        <td class="metric-value">${performance.latency?.p50 || 0}ms</td>
                        <td class="metric-value ${getSuccessRateClass(performance.successRate)}">${(performance.successRate || 0).toFixed(1)}%</td>
                        <td class="metric-value ${performance.errors > 0 ? "status-error" : "status-success"}">${performance.errors || 0}</td>
                    `;
            tbody.appendChild(row);
          });
      }

      function getSuccessRateClass(rate) {
        if (rate >= 99) return "status-success";
        if (rate >= 95) return "status-warning";
        return "status-error";
      }

      /**
       * æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
       */
      function destroyChart(chartId) {
        if (charts[chartId]) {
          charts[chartId].destroy();
          delete charts[chartId];
        }
      }

      /**
       * å…¨ã¦ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
       */
      function destroyAllCharts() {
        Object.keys(charts).forEach((chartId) => {
          if (charts[chartId]) {
            charts[chartId].destroy();
            delete charts[chartId];
          }
        });
      }

      function updateCharts() {
        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å…¨ã¦ç ´æ£„ã—ã¦ã‹ã‚‰å†ä½œæˆ
        destroyAllCharts();

        updateRPSChart();
        updateLatencyChart();
        updateTransportChart();
        updateTimeSeriesChart();
        updateSessionChart();
      }

      function updateRPSChart() {
        const ctx = document.getElementById("rpsChart").getContext("2d");
        const data = filteredReports.map((r) => ({
          x: r.name + " (" + r.transport + ")",
          y: r.performance?.requests?.average || 0,
        }));

        charts.rpsChart = new Chart(ctx, {
          type: "bar",
          data: {
            datasets: [
              {
                label: "RPS",
                data: data,
                backgroundColor: data.map((_, i) => `hsl(${i * 30}, 70%, 60%)`),
                borderColor: data.map((_, i) => `hsl(${i * 30}, 70%, 50%)`),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Requests per Second",
                },
              },
            },
          },
        });
      }

      function updateLatencyChart() {
        const ctx = document.getElementById("latencyChart").getContext("2d");
        const reports = filteredReports.filter((r) => r.performance?.latency);

        const data = {
          labels: reports.map((r) => r.name + " (" + r.transport + ")"),
          datasets: [
            {
              label: "P50",
              data: reports.map((r) => r.performance.latency.p50),
              borderColor: "#667eea",
              backgroundColor: "rgba(102, 126, 234, 0.1)",
            },
            {
              label: "P90",
              data: reports.map((r) => r.performance.latency.p90),
              borderColor: "#764ba2",
              backgroundColor: "rgba(118, 75, 162, 0.1)",
            },
            {
              label: "P99",
              data: reports.map((r) => r.performance.latency.p99),
              borderColor: "#f093fb",
              backgroundColor: "rgba(240, 147, 251, 0.1)",
            },
          ],
        };

        charts.latencyChart = new Chart(ctx, {
          type: "line",
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Latency (ms)",
                },
              },
            },
          },
        });
      }

      function updateTransportChart() {
        const ctx = document.getElementById("transportChart").getContext("2d");
        const transportStats = {};

        filteredReports.forEach((r) => {
          const transport = r.transport || "Unknown";
          if (!transportStats[transport]) {
            transportStats[transport] = {
              count: 0,
              totalRPS: 0,
              totalLatency: 0,
            };
          }
          transportStats[transport].count++;
          transportStats[transport].totalRPS +=
            r.performance?.requests?.average || 0;
          transportStats[transport].totalLatency +=
            r.performance?.latency?.average || 0;
        });

        const labels = Object.keys(transportStats);
        const avgRPS = labels.map((t) =>
          (transportStats[t].totalRPS / transportStats[t].count).toFixed(1),
        );
        const avgLatency = labels.map((t) =>
          (transportStats[t].totalLatency / transportStats[t].count).toFixed(1),
        );

        charts.transportChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["å¹³å‡RPS", "å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (é€†æ•°)", "ãƒ¬ãƒãƒ¼ãƒˆæ•°"],
            datasets: labels.map((transport, i) => ({
              label: transport,
              data: [
                transportStats[transport].totalRPS /
                  transportStats[transport].count,
                1000 /
                  (transportStats[transport].totalLatency /
                    transportStats[transport].count), // é€†æ•°ã§è¡¨ç¤º
                transportStats[transport].count * 10, // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
              ],
              borderColor: `hsl(${i * 120}, 70%, 50%)`,
              backgroundColor: `hsla(${i * 120}, 70%, 50%, 0.2)`,
              pointBackgroundColor: `hsl(${i * 120}, 70%, 50%)`,
              fill: true,
            })),
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function updateTimeSeriesChart() {
        const ctx = document.getElementById("timeSeriesChart").getContext("2d");
        const sortedReports = filteredReports
          .filter((r) => r.timestamp)
          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const datasets = {};
        sortedReports.forEach((r) => {
          const key = r.name + " (" + r.transport + ")";
          if (!datasets[key]) {
            datasets[key] = {
              label: key,
              data: [],
              borderColor: `hsl(${Object.keys(datasets).length * 45}, 70%, 50%)`,
              backgroundColor: `hsla(${Object.keys(datasets).length * 45}, 70%, 50%, 0.1)`,
              fill: false,
            };
          }
          datasets[key].data.push({
            x: new Date(r.timestamp),
            y: r.performance?.requests?.average || 0,
          });
        });

        charts.timeSeriesChart = new Chart(ctx, {
          type: "line",
          data: {
            datasets: Object.values(datasets),
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: "time",
                time: {
                  displayFormats: {
                    hour: "MM/DD HH:mm",
                  },
                },
                title: {
                  display: true,
                  text: "æ—¥æ™‚",
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "RPS",
                },
              },
            },
          },
        });
      }

      function updateSessionChart() {
        const ctx = document.getElementById("sessionChart").getContext("2d");
        const sessionData = filteredReports
          .filter((r) => r.sessionValidation)
          .map((r) => ({
            name: r.name + " (" + r.transport + ")",
            validation: r.sessionValidation,
          }));

        if (sessionData.length === 0) {
          ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
          return;
        }

        const data = {
          labels: sessionData.map((d) => d.name),
          datasets: [
            {
              label: "ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆåŠŸç‡ (%)",
              data: sessionData.map((d) => d.validation.successRate || 0),
              backgroundColor: "rgba(56, 161, 105, 0.6)",
              borderColor: "rgba(56, 161, 105, 1)",
              borderWidth: 1,
            },
            {
              label: "å¹³å‡ãƒ„ãƒ¼ãƒ«æ•°",
              data: sessionData.map((d) => d.validation.averageToolCount || 0),
              backgroundColor: "rgba(102, 126, 234, 0.6)",
              borderColor: "rgba(102, 126, 234, 1)",
              borderWidth: 1,
              yAxisID: "y1",
            },
          ],
        };

        charts.sessionChart = new Chart(ctx, {
          type: "bar",
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "æˆåŠŸç‡ (%)",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                beginAtZero: true,
                title: {
                  display: true,
                  text: "ãƒ„ãƒ¼ãƒ«æ•°",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      function showDashboard() {
        document.getElementById("controls").style.display = "block";
        document.getElementById("summaryStats").style.display = "grid";
        document.getElementById("dashboard").style.display = "grid";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        document.querySelector(".upload-section").appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }

      function showSuccess(message) {
        const successDiv = document.createElement("div");
        successDiv.className = "success";
        successDiv.textContent = message;
        document.querySelector(".upload-section").appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }

      /**
       * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
       */
      async function loadFromServer() {
        const statusDiv = document.getElementById("serverStatus");
        statusDiv.innerHTML = "<p>ğŸ”„ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>";

        try {
          const response = await fetch("/api/reports/data");

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || "Unknown server error");
          }

          if (data.reports && data.reports.length > 0) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ allReports å½¢å¼ã«å¤‰æ›
            allReports = data.reports.map((report) => ({
              filename: report.filename,
              data: report.data,
            }));

            try {
              processReports();
              statusDiv.innerHTML = `<div class="success">âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ ${data.reports.length} ä»¶ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ</div>`;
            } catch (chartError) {
              console.error("ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚¨ãƒ©ãƒ¼:", chartError);
              statusDiv.innerHTML = `<div class="warning">ğŸ”„ ãƒãƒ£ãƒ¼ãƒˆæç”»ä¸­...</div>`;
              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†æç”»ã‚’è©¦è¡Œ
              setTimeout(() => {
                try {
                  destroyAllCharts();
                  updateCharts();
                  statusDiv.innerHTML = `<div class="success">âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ ${data.reports.length} ä»¶ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ</div>`;
                } catch (retryError) {
                  console.error("ãƒãƒ£ãƒ¼ãƒˆå†æç”»ã‚¨ãƒ©ãƒ¼:", retryError);
                  statusDiv.innerHTML = `<div class="warning">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...</div>`;
                }
              }, 500);
            }
            setTimeout(() => {
              statusDiv.innerHTML = "";
            }, 3000);
          } else {
            statusDiv.innerHTML =
              '<div class="error">ğŸ“ ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            setTimeout(() => {
              statusDiv.innerHTML = "";
            }, 3000);
          }
        } catch (error) {
          console.warn("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—:", error);

          // Chart.jsã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
          if (error.message && error.message.includes("Canvas")) {
            statusDiv.innerHTML = `<div class="warning">âš¡ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...</div>`;
            setTimeout(() => {
              statusDiv.innerHTML = "";
              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤
              setTimeout(() => {
                loadFromServer();
              }, 1000);
            }, 2000);
          } else {
            statusDiv.innerHTML = `<div class="error">âš ï¸ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}<br>æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div>`;
            setTimeout(() => {
              statusDiv.innerHTML = "";
            }, 5000);
          }
        }
      }

      /**
       * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
       */
      async function getServerReportsList() {
        try {
          const response = await fetch("/api/reports");
          const data = await response.json();
          console.log("Server reports:", data);
          return data;
        } catch (error) {
          console.error("Failed to fetch server reports list:", error);
          return null;
        }
      }
    </script>
  </body>
</html>
